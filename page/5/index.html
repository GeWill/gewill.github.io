<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
<meta property="og:type" content="website">
<meta property="og:title" content="Will&#39;s Blog">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Will&#39;s Blog">
<meta property="og:description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Ge Will">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Will's Blog</title>
  







<head>
    <!-- 霞鹜文楷字体 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css"/>

    <!-- datapulse统计 -->
    <script defer type="text/javascript" src="https://datapulse.app/datapulse.min.js" id="datapulse" data-endpoint="https://datapulse.app/api/v1/event" data-workspace="cljxqml5q0y0f8j37d4futnbl"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DR0FC9YJLH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-DR0FC9YJLH');
    </script>

    <!-- 看板娘 -->
    <script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
</head>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Will's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">192</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">11</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">1</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ge Will"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Ge Will</p>
  <div class="site-description" itemprop="description">The people who are crazy enough to think they can change the world, are the ones who DO.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">192</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/gewill" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gewill" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:531sunlight@gmail.com" title="E-Mail → mailto:531sunlight@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/gewei" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;gewei" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/BoJack_D" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;BoJack_D" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/08/01/RxSwift-%E2%85%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/08/01/RxSwift-%E2%85%A2/" class="post-title-link" itemprop="url">RxSwift Ⅲ：iOS 应用程序与 RxCocoa</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-08-01 22:01:54" itemprop="dateCreated datePublished" datetime="2018-08-01T22:01:54+08:00">2018-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>由于Rx是一个多平台框架，因此它不会对您的Rx驱动的应用程序运行的设备做出任何假设。 RxSwift严格遵循RxPython，RxRuby，RxJS和所有其他平台所遵循的通用API设计，因此它不包含任何特定功能或与UIKit或Cocoa的集成，以帮助您开发iOS或macOS。</p>
<p>RxCocoa是一个独立的库（尽管它与RxSwift捆绑在一起），它允许您使用许多预构建的功能来更好地与UIKit和Cocoa集成。</p>
<p>RxCocoa将为您提供开箱即用的类来进行反应式网络，对用户交互作出反应，将数据模型绑定到UI控件等等。</p>
<h2 id="第十二章：开始学习-RxCocoa"><a href="#第十二章：开始学习-RxCocoa" class="headerlink" title="第十二章：开始学习 RxCocoa"></a>第十二章：开始学习 RxCocoa</h2><p>更新天气信息界面，根据API获取的数据。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApiController</span>.shared.currentWeather(city: <span class="string">&quot;RxSwift&quot;</span>)</span><br><span class="line">      .observeOn(<span class="type">MainScheduler</span>.instance)</span><br><span class="line">      .subscribe(onNext: &#123; data <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>.tempLabel.text <span class="operator">=</span> <span class="string">&quot;<span class="subst">\(data.temperature)</span>° C&quot;</span></span><br><span class="line">        <span class="keyword">self</span>.iconLabel.text <span class="operator">=</span> data.icon</span><br><span class="line">        <span class="keyword">self</span>.humidityLabel.text <span class="operator">=</span> <span class="string">&quot;<span class="subst">\(data.humidity)</span>%&quot;</span></span><br><span class="line">        <span class="keyword">self</span>.cityNameLabel.text <span class="operator">=</span> data.cityName</span><br><span class="line">      &#125;)</span><br><span class="line">      .disposed(by:bag)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> search <span class="operator">=</span> searchCityName.rx.controlEvent(.editingDidEndOnExit).asObservable()</span><br><span class="line">      .map &#123; <span class="keyword">self</span>.searchCityName.text &#125;</span><br><span class="line">      .filter &#123; (<span class="variable">$0</span> <span class="operator">??</span> <span class="string">&quot;&quot;</span>).characters.count <span class="operator">&gt;</span> <span class="number">0</span> &#125;</span><br><span class="line">      .flatMapLatest &#123; text <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">ApiController</span>.shared.currentWeather(city: text <span class="operator">??</span> <span class="string">&quot;Error&quot;</span>)</span><br><span class="line">          .catchErrorJustReturn(<span class="type">ApiController</span>.<span class="type">Weather</span>.empty)</span><br><span class="line">      &#125;</span><br><span class="line">      .asDriver(onErrorJustReturn: <span class="type">ApiController</span>.<span class="type">Weather</span>.empty)</span><br><span class="line"></span><br><span class="line">    search.map &#123; <span class="string">&quot;<span class="subst">\(<span class="variable">$0</span>.temperature)</span>° C&quot;</span> &#125;</span><br><span class="line">      .drive(tempLabel.rx.text)</span><br><span class="line">      .disposed(by:bag)</span><br><span class="line"></span><br><span class="line">    search.map &#123; <span class="variable">$0</span>.icon &#125;</span><br><span class="line">      .drive(iconLabel.rx.text)</span><br><span class="line">      .disposed(by:bag)</span><br><span class="line"></span><br><span class="line">    search.map &#123; <span class="string">&quot;<span class="subst">\(<span class="variable">$0</span>.humidity)</span>%&quot;</span> &#125;</span><br><span class="line">      .drive(humidityLabel.rx.text)</span><br><span class="line">      .disposed(by:bag)</span><br><span class="line"></span><br><span class="line">    search.map &#123; <span class="variable">$0</span>.cityName &#125;</span><br><span class="line">      .drive(cityNameLabel.rx.text)</span><br><span class="line">      .disposed(by:bag)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="第十三章：RxCocoa-中级"><a href="#第十三章：RxCocoa-中级" class="headerlink" title="第十三章：RxCocoa 中级"></a>第十三章：RxCocoa 中级</h2><p>添加搜索框支持</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">  <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">  style()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> searchInput <span class="operator">=</span> searchCityName.rx.controlEvent(.editingDidEndOnExit).asObservable()</span><br><span class="line">    .map &#123; <span class="keyword">self</span>.searchCityName.text &#125;</span><br><span class="line">    .filter &#123; (<span class="variable">$0</span> <span class="operator">??</span> <span class="string">&quot;&quot;</span>).count <span class="operator">&gt;</span> <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> textSearch <span class="operator">=</span> searchInput.flatMap &#123; text <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">ApiController</span>.shared.currentWeather(city: text <span class="operator">??</span> <span class="string">&quot;Error&quot;</span>)</span><br><span class="line">      .catchErrorJustReturn(<span class="type">ApiController</span>.<span class="type">Weather</span>.dummy)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> mapInput <span class="operator">=</span> mapView.rx.regionDidChangeAnimated</span><br><span class="line">    .skip(<span class="number">1</span>)</span><br><span class="line">    .map &#123; <span class="keyword">_</span> <span class="keyword">in</span> <span class="keyword">self</span>.mapView.centerCoordinate &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> mapSearch <span class="operator">=</span> mapInput.flatMap &#123; coordinate <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">ApiController</span>.shared.currentWeather(lat: coordinate.latitude, lon: coordinate.longitude)</span><br><span class="line">      .catchErrorJustReturn(<span class="type">ApiController</span>.<span class="type">Weather</span>.dummy)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> currentLocation <span class="operator">=</span> locationManager.rx.didUpdateLocations</span><br><span class="line">    .map &#123; locations <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">return</span> locations[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    .filter &#123; location <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">return</span> location.horizontalAccuracy <span class="operator">&lt;</span> kCLLocationAccuracyHundredMeters</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> geoInput <span class="operator">=</span> geoLocationButton.rx.tap.asObservable()</span><br><span class="line">    .do(onNext: &#123;</span><br><span class="line">      <span class="keyword">self</span>.locationManager.requestWhenInUseAuthorization()</span><br><span class="line">      <span class="keyword">self</span>.locationManager.startUpdatingLocation()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> geoLocation <span class="operator">=</span> geoInput.flatMap &#123;</span><br><span class="line">    <span class="keyword">return</span> currentLocation.take(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> geoSearch <span class="operator">=</span> geoLocation.flatMap &#123; location <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">ApiController</span>.shared.currentWeather(lat: location.coordinate.latitude, lon: location.coordinate.longitude)</span><br><span class="line">      .catchErrorJustReturn(<span class="type">ApiController</span>.<span class="type">Weather</span>.dummy)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> search <span class="operator">=</span> <span class="type">Observable</span>.from([geoSearch, textSearch, mapSearch])</span><br><span class="line">  .merge()</span><br><span class="line">  .asDriver(onErrorJustReturn: <span class="type">ApiController</span>.<span class="type">Weather</span>.dummy)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> running <span class="operator">=</span> <span class="type">Observable</span>.from([searchInput.map &#123; <span class="keyword">_</span> <span class="keyword">in</span> <span class="literal">true</span> &#125;,</span><br><span class="line">                                 geoInput.map &#123; <span class="keyword">_</span> <span class="keyword">in</span> <span class="literal">true</span> &#125;,</span><br><span class="line">                                 mapInput.map &#123; <span class="keyword">_</span> <span class="keyword">in</span> <span class="literal">true</span>&#125;,</span><br><span class="line">                                 search.map &#123; <span class="keyword">_</span> <span class="keyword">in</span> <span class="literal">false</span> &#125;.asObservable()])</span><br><span class="line">  .merge()</span><br><span class="line">  .startWith(<span class="literal">true</span>)</span><br><span class="line">  .asDriver(onErrorJustReturn: <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  running</span><br><span class="line">    .skip(<span class="number">1</span>)</span><br><span class="line">    .drive(activityIndicator.rx.isAnimating)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line">  </span><br><span class="line">  running</span><br><span class="line">    .drive(tempLabel.rx.isHidden)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  running</span><br><span class="line">    .drive(iconLabel.rx.isHidden)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  running</span><br><span class="line">    .drive(humidityLabel.rx.isHidden)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  running</span><br><span class="line">    .drive(cityNameLabel.rx.isHidden)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line">  </span><br><span class="line">  search.map &#123; <span class="string">&quot;<span class="subst">\(<span class="variable">$0</span>.temperature)</span>° C&quot;</span> &#125;</span><br><span class="line">    .drive(tempLabel.rx.text)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  search.map &#123; <span class="variable">$0</span>.icon &#125;</span><br><span class="line">    .drive(iconLabel.rx.text)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  search.map &#123; <span class="string">&quot;<span class="subst">\(<span class="variable">$0</span>.humidity)</span>%&quot;</span> &#125;</span><br><span class="line">    .drive(humidityLabel.rx.text)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  search.map &#123; <span class="variable">$0</span>.cityName &#125;</span><br><span class="line">    .drive(cityNameLabel.rx.text)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  locationManager.rx.didUpdateLocations</span><br><span class="line">    .subscribe(onNext: &#123; locations <span class="keyword">in</span></span><br><span class="line">      <span class="built_in">print</span>(locations)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  mapButton.rx.tap</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">      <span class="keyword">self</span>.mapView.isHidden <span class="operator">=</span> <span class="operator">!</span><span class="keyword">self</span>.mapView.isHidden</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  mapView.rx.setDelegate(<span class="keyword">self</span>)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  search.map &#123; [<span class="variable">$0</span>.overlay()] &#125;</span><br><span class="line">    .drive(mapView.rx.overlays)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/08/01/RxSwift-%E2%85%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/08/01/RxSwift-%E2%85%A1/" class="post-title-link" itemprop="url">RxSwift Ⅱ：操作符和最佳实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-08-01 21:57:49" itemprop="dateCreated datePublished" datetime="2018-08-01T21:57:49+08:00">2018-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="第五章：Filtering-Operator"><a href="#第五章：Filtering-Operator" class="headerlink" title="第五章：Filtering Operator"></a>第五章：Filtering Operator</h2><h3 id="Ignoring"><a href="#Ignoring" class="headerlink" title="Ignoring"></a>Ignoring</h3><p>忽略所有event，转化为一个 Comletable。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">ignoreElements</span>() -&gt; <span class="type">Completable</span></span><br></pre></td></tr></table></figure>

<p>仅发射指定index的event，其余都忽略。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">elementAt</span>(<span class="keyword">_</span> <span class="params">index</span>: <span class="type">Int</span>) -&gt; <span class="type">Observable</span>&lt;<span class="type">String</span>&gt;</span><br></pre></td></tr></table></figure>

<p>或者直接使用 <code>.filter</code> ，是 RxSwift 对 Swift 标准库中 <code>.filter</code> 对应版本。具体用法很简单，和 Swift 版一样。</p>
<h3 id="Skipping"><a href="#Skipping" class="headerlink" title="Skipping"></a>Skipping</h3><p><code>.skip(n) 即可跳过前</code> n 个 event。</p>
<p><code>.skipWhile</code> 跳过符合条件的 event，但是遇到不符合条件的 event 后，不再跳过该 event 以及后面的event。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Observable</span>.of(<span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    .skipWhile &#123; integer <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(integer)</span> skipWhile&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> integer <span class="operator">%</span> <span class="number">2</span> <span class="operator">==</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2 skipWhile</span><br><span class="line">2 skipWhile</span><br><span class="line">3 skipWhile</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<p><code>.skipUntil(trigger)</code> 持续跳过直到另一个Observable生成元素。</p>
<h3 id="Taking"><a href="#Taking" class="headerlink" title="Taking"></a>Taking</h3><p>Taking 和 Skipping 是相反的。</p>
<p><code>.take(n)</code> 只发射前 n 个 event 。</p>
<p><code>.takeWhile &#123; &#125;</code>  放射符合条件的event，直到遇到不符合条件的元素，不再发射。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line"><span class="type">Observable</span>.of(<span class="number">2</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line">    .enumerated()</span><br><span class="line">    .takeWhile &#123; index, integer <span class="keyword">in</span></span><br><span class="line">        integer <span class="operator">%</span> <span class="number">2</span> <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> index <span class="operator">&lt;</span> <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">    .map &#123; <span class="variable">$0</span>.element &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">2</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<p><code>.takeUntil(trigger)</code>  类似的，持续发射，直到另一个Observable生成元素，后面不再发射。</p>
<h3 id="Distinct"><a href="#Distinct" class="headerlink" title="Distinct"></a>Distinct</h3><p><code>.distinctUntilChanged()</code> 只发射不同于前一个的元素。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Observable</span>.of(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;A&quot;</span>)</span><br><span class="line">    .distinctUntilChanged()</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p> Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">A</span><br></pre></td></tr></table></figure>

<p><code>distinctUntilChanged(_:)</code> 对阻止重复发射不符合 <code>Equatable</code> 类型的元素时很有用。因为你可以控制前后两个元素是否相等。</p>
<h2 id="第六章：Filtering-实践"><a href="#第六章：Filtering-实践" class="headerlink" title="第六章：Filtering 实践"></a>第六章：Filtering 实践</h2><p>上一章介绍了RxSwift中函数式编程的观念。操作符操作一个Observable，输出一个心得Observable。得益于此，我么可以链式调用操作符。</p>
<h3 id="改进-Combinestagram-项目"><a href="#改进-Combinestagram-项目" class="headerlink" title="改进 Combinestagram 项目"></a>改进 Combinestagram 项目</h3><p>就是把上一章的 filtering 操作符应用在项目中。</p>
<h3 id="基于时间的操作符"><a href="#基于时间的操作符" class="headerlink" title="基于时间的操作符"></a>基于时间的操作符</h3><p>基于时间的操作符使用 <strong>Scheduler</strong> 。</p>
<p><code>take(_:scheduler:)</code> 是一个过滤操作符，和 <code>take(1)</code> 和 <code>takeWhile(...)</code> 类似。</p>
<p>只会发送指定时间段内的元素。一旦时间点过了，就会发送 <code>.complete</code> 事件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">errorMessage</span>() &#123;</span><br><span class="line">  alert(title: <span class="string">&quot;No access to Camera Roll&quot;</span>,</span><br><span class="line">        text: <span class="string">&quot;You can grant access to Combinestagram from the Settings app&quot;</span>)</span><br><span class="line">    .asObservable()</span><br><span class="line">    .take(<span class="number">5.0</span>, scheduler: <span class="type">MainScheduler</span>.instance)</span><br><span class="line">    .subscribe(onCompleted: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">self</span><span class="operator">?</span>.dismiss(animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">      <span class="keyword">_</span> <span class="operator">=</span> <span class="keyword">self</span><span class="operator">?</span>.navigationController<span class="operator">?</span>.popViewController(animated: <span class="literal">true</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>以下是一些合适使用 <code>throttle</code> 的场景：</p>
<ul>
<li>搜索输入框的订阅，然后发送当前文本内容的API请求。通过 <code>throttle</code> , 你可以让用户快速输入，同时仅在用户完成输入时才你的向服务器发送请求。</li>
<li>当用户点击按钮来展示一个 modal view controller 时，你可以阻止双击以及展示两次 modal view controller。通过 <code>throttle</code> 点击事件，可以现实只接收最后一次点击事件，不论用户双击或三击。</li>
<li>如果你只关心用户拖动手势时停留的地方。你可以使用 <code>throttle</code> 当前触摸位置，只考虑那些停止改变的位置的元素。</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">images.asObservable()</span><br><span class="line">    .throttle(<span class="number">0.5</span>, scheduler: <span class="type">MainScheduler</span>.instance)</span><br><span class="line">    .subscribe(onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] photos <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> preview <span class="operator">=</span> <span class="keyword">self</span><span class="operator">?</span>.imagePreview <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">      preview.image <span class="operator">=</span> <span class="type">UIImage</span>.collage(images: photos,</span><br><span class="line">                                      size: preview.frame.size)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: bag)</span><br></pre></td></tr></table></figure>

<h2 id="第七章：Transforming-Operator"><a href="#第七章：Transforming-Operator" class="headerlink" title="第七章：Transforming Operator"></a>第七章：Transforming Operator</h2><p>当你决定学习 RxSwift，或许会觉得它是深奥的库。也许让你想起来当初学习 iOS 或者 Swift 的时候。但学习到第七章你应该意识到 RxSwift 并非魔法。它是精心构建的API，能让极大地提升效率和简化代码。学到这里你应该会感觉不错。</p>
<p>本章你将学习运算符中最重要的一类：transforming 运算符。你将一直使用 transforming，准备Observable数据以供订阅者使用。需要强调的是，RxSwift 中的 transforming 运算符与 Swift 标准库之间有相似之处 ，如 <code>map (_:)</code> 和 <code>flatMap (_:)</code> 。 </p>
<h3 id="Transforming-元素"><a href="#Transforming-元素" class="headerlink" title="Transforming 元素"></a>Transforming 元素</h3><p>将可观察到的单个元素转换为所有这些元素的数组的一种简便方法是使用 <code>toArray</code>。<img src="https://gewill.org/assets/toArray.jpg" alt="toArray"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"><span class="type">Observable</span>.of(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line">  .toArray()</span><br><span class="line">  .subscribe(onNext: &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p><code>map</code> 可将每个元素进行 transforming 。<img src="https://gewill.org/assets/map.jpg" alt="map"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"><span class="keyword">let</span> formatter <span class="operator">=</span> <span class="type">NumberFormatter</span>()</span><br><span class="line">formatter.numberStyle <span class="operator">=</span> .spellOut</span><br><span class="line"></span><br><span class="line"><span class="type">Observable</span>&lt;<span class="type">NSNumber</span>&gt;.of(<span class="number">123</span>, <span class="number">4</span>, <span class="number">56</span>)</span><br><span class="line">    .map &#123;</span><br><span class="line">        formatter.string(from: <span class="variable">$0</span>) <span class="operator">??</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"><span class="type">Observable</span>.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">    .enumerated()</span><br><span class="line">    .map &#123; index, integer <span class="keyword">in</span></span><br><span class="line">        index <span class="operator">&gt;</span> <span class="number">2</span> <span class="operator">?</span> integer <span class="operator">*</span> <span class="number">2</span> : integer</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>



<h3 id="Transforming-内部-Observable"><a href="#Transforming-内部-Observable" class="headerlink" title="Transforming 内部 Observable"></a>Transforming 内部 Observable</h3><p>RxSwift 包含 <code>flatMap</code> 系列中的几个运算符, 允许你深入Observable,处理其Observable类型的属性。<img src="https://gewill.org/assets/flatMap.jpg" alt="flatMap"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> score: <span class="type">BehaviorSubject</span>&lt;<span class="type">Int</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ryan <span class="operator">=</span> <span class="type">Student</span>(score: <span class="type">BehaviorSubject</span>(value: <span class="number">80</span>))</span><br><span class="line"><span class="keyword">let</span> charlotte <span class="operator">=</span> <span class="type">Student</span>(score: <span class="type">BehaviorSubject</span>(value: <span class="number">90</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> student <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">Student</span>&gt;()</span><br><span class="line"></span><br><span class="line">student</span><br><span class="line">    .flatMap &#123;</span><br><span class="line">        <span class="variable">$0</span>.score</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">student.onNext(ryan)</span><br><span class="line">ryan.score.onNext(<span class="number">85</span>)</span><br><span class="line"></span><br><span class="line">student.onNext(charlotte)</span><br><span class="line">ryan.score.onNext(<span class="number">95</span>)</span><br><span class="line"></span><br><span class="line">charlotte.score.onNext(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>What makes</p>
<p>flatMapLatest different is that it will automatically switch to the latest observable and</p>
<p>unsubscribe from the the previous one.</p>
<p><code>flatMapLatest</code> 和 <code>flatMap</code> 略有不同之处是它会自动切换到最后一个 Observable，注销订阅之前的 Observable。</p>
<p><img src="https://gewill.org/assets/flatMapLatest.jpg" alt="flatMapLatest"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ryan <span class="operator">=</span> <span class="type">Student</span>(score: <span class="type">BehaviorSubject</span>(value: <span class="number">80</span>))</span><br><span class="line"><span class="keyword">let</span> charlotte <span class="operator">=</span> <span class="type">Student</span>(score: <span class="type">BehaviorSubject</span>(value: <span class="number">90</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> student <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">Student</span>&gt;()</span><br><span class="line"></span><br><span class="line">student</span><br><span class="line">    .flatMapLatest &#123;</span><br><span class="line">        <span class="variable">$0</span>.score</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">student.onNext(ryan)</span><br><span class="line"></span><br><span class="line">ryan.score.onNext(<span class="number">85</span>)</span><br><span class="line"></span><br><span class="line">student.onNext(charlotte)</span><br><span class="line"></span><br><span class="line">ryan.score.onNext(<span class="number">95</span>)</span><br><span class="line"></span><br><span class="line">charlotte.score.onNext(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only one thing to point out here that’s different from the previous example of flatMap:</span></span><br><span class="line"><span class="comment">// Changing ryan’s score here will have no effect. It will not be printed out. This is because flatMapLatest has already switched to the latest observable, for charlotte.</span></span><br></pre></td></tr></table></figure>



<h3 id="观察事件"><a href="#观察事件" class="headerlink" title="观察事件"></a>观察事件</h3><p>使用具体化运算符 <code>materialize</code>, 可以将 Observable 发射的每个事件包装成 Observable。比如下面的例子中 <code>$0.score.materialize()</code>  将 <code>BehaviorSubject&lt;Int&gt;</code> 封装为  <code>Observable&lt;Event&lt;Int&gt;&gt;</code> 。这样的话，我的就可以自己处理 .error 和 .complete 事件，而不终结该 Observable 。</p>
<p>对应的我们再使用 <code>.dematerialize()</code>  转回 <code>Observable&lt;Int&gt;</code> ，即可正常订阅。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">MyError</span>: <span class="title class_">Error</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> anError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ryan <span class="operator">=</span> <span class="type">Student</span>(score: <span class="type">BehaviorSubject</span>(value: <span class="number">80</span>))</span><br><span class="line"><span class="keyword">let</span> charlotte <span class="operator">=</span> <span class="type">Student</span>(score: <span class="type">BehaviorSubject</span>(value: <span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> student: <span class="type">BehaviorSubject</span>&lt;<span class="type">Student</span>&gt; <span class="operator">=</span> <span class="type">BehaviorSubject</span>(value: ryan)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> studentScore: <span class="type">Observable</span>&lt;<span class="type">Event</span>&lt;<span class="type">Int</span>&gt;&gt; <span class="operator">=</span> student</span><br><span class="line">    .flatMapLatest &#123;</span><br><span class="line">        <span class="variable">$0</span>.score.materialize()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">studentScore</span><br><span class="line">    .filter &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="variable">$0</span>.error <span class="operator">==</span> <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="variable">$0</span>.error<span class="operator">!</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    .dematerialize()</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;subscribe: <span class="subst">\(<span class="variable">$0</span>)</span>&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">ryan.score.onNext(<span class="number">85</span>)</span><br><span class="line">ryan.score.onError(<span class="type">MyError</span>.anError)</span><br><span class="line">ryan.score.onNext(<span class="number">90</span>)</span><br><span class="line">student.onNext(charlotte)</span><br></pre></td></tr></table></figure>

<p>Console 输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">subscribe: 80</span><br><span class="line">subscribe: 85</span><br><span class="line">anError</span><br><span class="line">subscribe: 100</span><br></pre></td></tr></table></figure>

<h2 id="第八章：Transforming-实践"><a href="#第八章：Transforming-实践" class="headerlink" title="第八章：Transforming 实践"></a>第八章：Transforming 实践</h2><p>在上一章中学习了 RxSwift 的主要功能，包括：map 和 flatMap 。</p>
<h3 id="开始-GitFeed-项目"><a href="#开始-GitFeed-项目" class="headerlink" title="开始 GitFeed 项目"></a>开始 GitFeed 项目</h3><p>本章中要处理的项目将显示 GitHub 仓库的动态, 如所有最新的 like, fork 和 comment.。</p>
<p>该项目将有两个不同的故事情节:</p>
<ul>
<li>主要的情节是要接触到 GitHub 的 JSON API, 接收 JSON 响应, 并最终将其转换为对象集合.    </li>
<li>次要将提取的对象保存到磁盘并在 “新” 活动列表之前的表中显示它们。从服务器获取事件。</li>
</ul>
<h3 id="网络获取数据"><a href="#网络获取数据" class="headerlink" title="网络获取数据"></a>网络获取数据</h3><p>我们将会将 URLSession 添加个响应式拓展。</p>
<p><img src="https://gewill.org/assets/CocoaAPIToRxAPI.jpeg" alt="CocoaAPIToRxAPI"></p>
<p>具体就是把网络API的请求和响应分别封装起来：</p>
<p>其中 <code>share(replay:, scope:)</code> ，可以避免 <code>URLSession.rx.response(request:)</code> 因过早 .complete 造成订阅时重新发送网络请求。原理就是封装多个 Observable 的元素为一个新的 Observable，并指定缓冲区最大元素数量，生命周期。定义如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">share</span>(<span class="params">replay</span>: <span class="type">Int</span> <span class="operator">=</span> <span class="keyword">default</span>, <span class="params">scope</span>: <span class="type">SubjectLifetimeScope</span> <span class="operator">=</span> <span class="keyword">default</span>)</span><br></pre></td></tr></table></figure>

<p>代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">fetchEvents</span>(<span class="params">repo</span>: <span class="type">String</span>) &#123;</span><br><span class="line">    	<span class="comment">// 1. 使用 map 构造一个请求</span></span><br><span class="line">        <span class="keyword">let</span> response <span class="operator">=</span> <span class="type">Observable</span>.from([repo])</span><br><span class="line">            .map &#123; urlString -&gt; <span class="type">URL</span> <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">return</span> <span class="type">URL</span>(string: <span class="string">&quot;https://api.github.com/repos/<span class="subst">\(urlString)</span>/events&quot;</span>)<span class="operator">!</span></span><br><span class="line">            &#125;</span><br><span class="line">            .map &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] url -&gt; <span class="type">URLRequest</span> <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">var</span> request <span class="operator">=</span> <span class="type">URLRequest</span>(url: url)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> modifiedHeader <span class="operator">=</span> <span class="keyword">self</span><span class="operator">?</span>.lastModified.value &#123;</span><br><span class="line">                    request.addValue(modifiedHeader <span class="keyword">as</span> <span class="type">String</span>,</span><br><span class="line">                        forHTTPHeaderField: <span class="string">&quot;Last-Modified&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> request</span><br><span class="line">            &#125;</span><br><span class="line">            .flatMap &#123; request -&gt; <span class="type">Observable</span>&lt;(response: <span class="type">HTTPURLResponse</span>, data: <span class="type">Data</span>)&gt; <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">return</span> <span class="type">URLSession</span>.shared.rx.response(request: request)</span><br><span class="line">            &#125;</span><br><span class="line">            .share(replay: <span class="number">1</span>, scope: .whileConnected)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 转换响应</span></span><br><span class="line">        response</span><br><span class="line">            .filter &#123; response, <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">                 <span class="comment">// 检查右边的值是否在左边的 range 内</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span><span class="operator">..&lt;</span><span class="number">300</span> <span class="operator">~=</span> response.statusCode</span><br><span class="line">            &#125;</span><br><span class="line">            .map &#123; <span class="keyword">_</span>, data -&gt; [[<span class="type">String</span>: <span class="keyword">Any</span>]] <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> jsonObject <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">JSONSerialization</span>.jsonObject(with: data, options: []),</span><br><span class="line">                    <span class="keyword">let</span> result <span class="operator">=</span> jsonObject <span class="keyword">as?</span> [[<span class="type">String</span>: <span class="keyword">Any</span>]] <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> []</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result</span><br><span class="line">            &#125;</span><br><span class="line">            .filter &#123; objects <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">return</span> objects.count <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">            .map &#123; objects <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">return</span> objects.flatMap(<span class="type">Event</span>.<span class="keyword">init</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            .subscribe(onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] newEvents <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span><span class="operator">?</span>.processEvents(newEvents)</span><br><span class="line">            &#125;)</span><br><span class="line">            .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">        response</span><br><span class="line">            .filter &#123; response, <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span><span class="operator">..&lt;</span><span class="number">400</span> <span class="operator">~=</span> response.statusCode</span><br><span class="line">            &#125;</span><br><span class="line">            .flatMap &#123; response, <span class="keyword">_</span> -&gt; <span class="type">Observable</span>&lt;<span class="type">NSString</span>&gt; <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> value <span class="operator">=</span> response.allHeaderFields[<span class="string">&quot;Last-Modified&quot;</span>] <span class="keyword">as?</span> <span class="type">NSString</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="type">Observable</span>.empty()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="type">Observable</span>.just(value)</span><br><span class="line">            &#125;</span><br><span class="line">            .subscribe(onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] modifiedHeader <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> strongSelf <span class="operator">=</span> <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                strongSelf.lastModified.value <span class="operator">=</span> modifiedHeader</span><br><span class="line">                <span class="keyword">try?</span> modifiedHeader.write(to: strongSelf.modifiedFileURL, atomically: <span class="literal">true</span>,</span><br><span class="line">                    encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8.rawValue)</span><br><span class="line">            &#125;)</span><br><span class="line">            .disposed(by: bag)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="第九章：合并Operator"><a href="#第九章：合并Operator" class="headerlink" title="第九章：合并Operator"></a>第九章：合并Operator</h2><p>在前面的章节中, 你学习了如何创建、ﬁlter 和转换可观察序列。RxSwift ﬁltering 和转换运算符的行为与 Swift 的标准集合运算符非常相似。你看到了 RxSwift 与 flatMap 的真正力量, 它让你用很少的代码执行很多任务.   </p>
<p>这一章将向你展示几种不同的组合序列的方法, 以及如何在每个序列中组合数据。你将使用的一些操作员与 Swift 集合操作员非常相似。它们有助于结合异步序列中的元素, 就像使用 Swift 数组一样。</p>
<h3 id="前缀和串联"><a href="#前缀和串联" class="headerlink" title="前缀和串联"></a>前缀和串联</h3><p>从 <code>startWith(_:)</code> 运算符赋值给定初始值的可观察序列。此值必须与可观察元素的类型相同。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> numbers <span class="operator">=</span> <span class="type">Observable</span>.of(<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> numbers.startWith(<span class="number">1</span>) observable.subscribe(onNext: &#123; value <span class="keyword">in</span> <span class="built_in">print</span>(value) &#125;)</span><br></pre></td></tr></table></figure>

<p>类似地 <code>.concat(_:)</code> 可以合并两个序列。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> first <span class="operator">=</span> <span class="type">Observable</span>.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">let</span> second <span class="operator">=</span> <span class="type">Observable</span>.of(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> <span class="type">Observable</span>.concat([first, second])</span><br><span class="line">observable.subscribe(onNext: &#123; value <span class="keyword">in</span> <span class="built_in">print</span>(value) &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h3><p>Merge 也是合并，不过会按照顺序发射事件。</p>
<p><img src="https://gewill.org/assets/merge.jpg" alt="merge"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> left <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> right <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source <span class="operator">=</span> <span class="type">Observable</span>.of(left.asObservable(), right.asObservable())</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> source.merge()</span><br><span class="line"><span class="keyword">let</span> disposable <span class="operator">=</span> observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> leftValues <span class="operator">=</span> [<span class="string">&quot;Berlin&quot;</span>, <span class="string">&quot;Munich&quot;</span>, <span class="string">&quot;Frankfurt&quot;</span>]</span><br><span class="line"><span class="keyword">var</span> rightValues <span class="operator">=</span> [<span class="string">&quot;Madrid&quot;</span>, <span class="string">&quot;Barcelona&quot;</span>, <span class="string">&quot;Valencia&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">repeat</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> arc4random_uniform(<span class="number">2</span>) <span class="operator">==</span> <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="operator">!</span>leftValues.isEmpty &#123;</span><br><span class="line">            left.onNext(<span class="string">&quot;Left:  &quot;</span> <span class="operator">+</span> leftValues.removeFirst())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="operator">!</span>rightValues.isEmpty &#123;</span><br><span class="line">        right.onNext(<span class="string">&quot;Right: &quot;</span> <span class="operator">+</span> rightValues.removeFirst())</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> <span class="operator">!</span>leftValues.isEmpty <span class="operator">||</span> <span class="operator">!</span>rightValues.isEmpty</span><br><span class="line"></span><br><span class="line">disposable.dispose()</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Right: Madrid</span><br><span class="line">Right: Barcelona</span><br><span class="line">Left:  Berlin</span><br><span class="line">Left:  Munich</span><br><span class="line">Left:  Frankfurt</span><br><span class="line">Right: Valencia</span><br></pre></td></tr></table></figure>

<h3 id="Combining-元素"><a href="#Combining-元素" class="headerlink" title="Combining 元素"></a>Combining 元素</h3><p>RxSwift中一组基本的运算符是 <code>combineLatest</code> 。他们组合来自几个序列的值：</p>
<p><img src="https://gewill.org/assets/Combining%20elements.jpg" alt="Combining elements"></p>
<p>Every time one of the inner (combined) sequences emits a value, it calls a closure you provide. You receive the last value from each of the inner sequences. This has many concrete applications, such as observing several text ﬁelds at once and combining their value, watching the status of multiple sources, and so on.</p>
<p>每当内部（组合）序列中的一个发出一个值时，它会调用您提供的闭包。 你会收到每个内部序列的最后一个值。 这里有很多具体的应用场景，例如一次观察几个文本字段并结合它们的价值，观察多个来源的状态等等。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> left <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> right <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> <span class="type">Observable</span>.combineLatest(left, right, resultSelector: &#123;</span><br><span class="line">    lastLeft, lastRight <span class="keyword">in</span></span><br><span class="line">    <span class="string">&quot;<span class="subst">\(lastLeft)</span> <span class="subst">\(lastRight)</span>&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> disposable <span class="operator">=</span> observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&gt; Sending a value to Left&quot;</span>)</span><br><span class="line">left.onNext(<span class="string">&quot;Hello,&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&gt; Sending a value to Right&quot;</span>)</span><br><span class="line">right.onNext(<span class="string">&quot;world&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&gt; Sending another value to Right&quot;</span>)</span><br><span class="line">right.onNext(<span class="string">&quot;RxSwift&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&gt; Sending another value to Left&quot;</span>)</span><br><span class="line">left.onNext(<span class="string">&quot;Have a good day,&quot;</span>)</span><br><span class="line"></span><br><span class="line">disposable.dispose()</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; Sending a value to Left</span><br><span class="line">&gt; Sending a value to Right</span><br><span class="line">Hello, world</span><br><span class="line">&gt; Sending another value to Right</span><br><span class="line">Hello, RxSwift</span><br><span class="line">&gt; Sending another value to Left</span><br><span class="line">Have a good day, RxSwift</span><br></pre></td></tr></table></figure>

<p><code>zip</code> 总是按照顺序一对一对的组合。类似把两个数组按照相同的下标进行组合。</p>
<p> <img src="https://gewill.org/assets/zip.jpg" alt="zip"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Weather</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> cloudy</span><br><span class="line">    <span class="keyword">case</span> sunny</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> left: <span class="type">Observable</span>&lt;<span class="type">Weather</span>&gt; <span class="operator">=</span> <span class="type">Observable</span>.of(.sunny, .cloudy, .cloudy, .sunny)</span><br><span class="line"><span class="keyword">let</span> right <span class="operator">=</span> <span class="type">Observable</span>.of(<span class="string">&quot;Lisbon&quot;</span>, <span class="string">&quot;Copenhagen&quot;</span>, <span class="string">&quot;London&quot;</span>, <span class="string">&quot;Madrid&quot;</span>, <span class="string">&quot;Vienna&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> <span class="type">Observable</span>.zip(left, right) &#123; weather, city <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;It&#x27;s <span class="subst">\(weather)</span> in <span class="subst">\(city)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">It&#x27;s sunny in Lisbon</span><br><span class="line">It&#x27;s cloudy in Copenhagen</span><br><span class="line">It&#x27;s cloudy in London</span><br><span class="line">It&#x27;s sunny in Madrid</span><br></pre></td></tr></table></figure>

<h3 id="Triggers"><a href="#Triggers" class="headerlink" title="Triggers"></a>Triggers</h3><p>应用程序有不同的需求，必须管理多个输入源。 你经常需要立即接受来自多个观察对象的输入。 有些会简单地在代码中触发行为，而其他的将提供数据。 RxSwift 已经覆盖了强大的运算符这会让你的生活更轻松。 或者，至少你的编码生活！</p>
<p>首先看看 <code>withLatestFrom(_:)</code>。 经常被初学者忽略，它在处理用户界面等方面是一个有用的配套工具。<img src="https://gewill.org/assets/trigger.jpg" alt="trigger"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> button <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">Void</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> textField <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> button.withLatestFrom(textField)</span><br><span class="line"><span class="keyword">_</span> <span class="operator">=</span> observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">textField.onNext(<span class="string">&quot;Par&quot;</span>)</span><br><span class="line">textField.onNext(<span class="string">&quot;Pari&quot;</span>)</span><br><span class="line">textField.onNext(<span class="string">&quot;Paris&quot;</span>)</span><br><span class="line">button.onNext(())</span><br><span class="line">button.onNext(())</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Paris</span><br><span class="line">Paris</span><br></pre></td></tr></table></figure>

<p><code>sample(_:)</code> 和 几乎只有一个变化：每当触发器observable发射一个值时，<code>sample(_:)</code> 从其它的可观察值发出最新值，但只有在自上一次元素后才到达。 如果没有新的数据到达，<code>sample(_:)</code> 将不会发射任何东西。<img src="https://gewill.org/assets/sample.jpg" alt="sample"></p>
<h3 id="Switches"><a href="#Switches" class="headerlink" title="Switches"></a>Switches</h3><p><img src="https://gewill.org/assets/Switches.jpg" alt="Switches"></p>
<p><code>amb(_:)</code> 运算符订阅左侧和右侧的可观察序列。 它等待其中任何一个发出一个元素，然后退订另一个序列。 之后，它只传递第一个活动可观察元素。 它可以从模棱两可中选出一个：首先，你不知道你感兴趣的是哪一个序列，等其中先发射一个序列再做决定。</p>
<p>这个运算符经常被忽视。 它有一些精选的实际应用场景，如连接到冗余服务器，并坚持使用第一个响应的服务器。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> left <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> right <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> left.amb(right)</span><br><span class="line"><span class="keyword">let</span> disposable <span class="operator">=</span> observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">left.onNext(<span class="string">&quot;Lisbon&quot;</span>)</span><br><span class="line">right.onNext(<span class="string">&quot;Copenhagen&quot;</span>)</span><br><span class="line">left.onNext(<span class="string">&quot;London&quot;</span>)</span><br><span class="line">left.onNext(<span class="string">&quot;Madrid&quot;</span>)</span><br><span class="line">right.onNext(<span class="string">&quot;Vienna&quot;</span>)</span><br><span class="line"></span><br><span class="line">disposable.dispose()</span><br></pre></td></tr></table></figure>



<p>更流行的选项是 <code>switchLatest()</code> 运算符：</p>
<p>可以自由切换偏爱那个子序列发射的元素。<img src="https://gewill.org/assets/switchLatest.jpg" alt="switchLatest"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> one <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> two <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> three <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">Observable</span>&lt;<span class="type">String</span>&gt;&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> source.switchLatest()</span><br><span class="line"><span class="keyword">let</span> disposable <span class="operator">=</span> observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">source.onNext(one)</span><br><span class="line">one.onNext(<span class="string">&quot;Some text from sequence one&quot;</span>)</span><br><span class="line">two.onNext(<span class="string">&quot;Some text from sequence two&quot;</span>)</span><br><span class="line"></span><br><span class="line">source.onNext(two)</span><br><span class="line">two.onNext(<span class="string">&quot;More text from sequence two&quot;</span>)</span><br><span class="line">one.onNext(<span class="string">&quot;and also from sequence one&quot;</span>)</span><br><span class="line"></span><br><span class="line">source.onNext(three)</span><br><span class="line">two.onNext(<span class="string">&quot;Why don&#x27;t you seem me?&quot;</span>)</span><br><span class="line">one.onNext(<span class="string">&quot;I&#x27;m alone, help me&quot;</span>)</span><br><span class="line">three.onNext(<span class="string">&quot;Hey it&#x27;s three. I win.&quot;</span>)</span><br><span class="line"></span><br><span class="line">source.onNext(one)</span><br><span class="line">one.onNext(<span class="string">&quot;Nope. It&#x27;s me, one!&quot;</span>)</span><br><span class="line"></span><br><span class="line">disposable.dispose()</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Some text from sequence one</span><br><span class="line">More text from sequence two</span><br><span class="line">Hey it&#x27;s three. I win.</span><br><span class="line">Nope. It&#x27;s me, one!</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>形成可观察序列的心智模型可能很困难。 别担心， 你会习惯它。 <strong>练习是顺序理解序列的关键</strong>。 随着您的体验增长，请随时审查这些示例！ 你将在下一章中更好地了解如何使用它。</p>
<h3 id="Combining-一个序列中元素"><a href="#Combining-一个序列中元素" class="headerlink" title="Combining 一个序列中元素"></a>Combining 一个序列中元素</h3><p>所有的厨师都知道你减少得越多，酱汁就越美味。 虽然不是针对厨师，但 RxSwift 拥有将酱汁减少到最有味道的组分的工具。</p>
<p><code>reduce(_:_:)</code> 和 Swift 标准库中类似。<img src="https://gewill.org/assets/reduce.jpg" alt="reduce"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> source <span class="operator">=</span> <span class="type">Observable</span>.of(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>)</span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> source.reduce(<span class="number">0</span>, accumulator: &#123; summary, newValue <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> summary <span class="operator">+</span> newValue</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">25</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>scan(_:accumulator:)</code> 和<code>reduce(_:_:)</code> 只有一个最终结果不同：每次发射事件，都会计算结果并发射。<img src="https://gewill.org/assets/scan.jpg" alt="scan"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> source <span class="operator">=</span> <span class="type">Observable</span>.of(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> source.scan(<span class="number">0</span>, accumulator: <span class="operator">+</span>)</span><br><span class="line">observable.subscribe(onNext: &#123; value <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Console 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">4</span><br><span class="line">9</span><br><span class="line">16</span><br><span class="line">25</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="第十章：合并Operator实践"><a href="#第十章：合并Operator实践" class="headerlink" title="第十章：合并Operator实践"></a>第十章：合并Operator实践</h2><p>在前一章中，你学习了将操作符合并，并通过对一些相当令人头脑灵活的概念进行越来越详细的练习。 一些运算符可能会让你对这些反应性概念的真实应用感到疑惑。<br>在“……实践”一章中，你将有机会尝试一些最强大的运算符。 你将学会解决类似于你在自己的应用程序中遇到的问题。</p>
<h3 id="准备网络后端服务"><a href="#准备网络后端服务" class="headerlink" title="准备网络后端服务"></a>准备网络后端服务</h3><p>这里使用NASA的EONET服务。</p>
<p>我们称之为EONET服务。 它抽象访问由EONET服务器公开的数据，将它们作为服务提供给你的应用程序。 你会看到，结合Rx，这种模式将找到许多应用程序。 它可以让你在应用程序内清晰地分离数据生产和消耗。 你可以轻松替换或模拟生产环境，而不会对用户方面产生任何影响。</p>
<p>先封装一个通用网络请求，然后把 categories 封装为单例，方便所有订阅者订阅。</p>
<h3 id="Categories-view-controller"><a href="#Categories-view-controller" class="headerlink" title="Categories view controller"></a>Categories view controller</h3><p>categories view controller 显示 categories 列表。</p>
<h3 id="Adding-the-event-download-service"><a href="#Adding-the-event-download-service" class="headerlink" title="Adding the event download service"></a>Adding the event download service</h3><h3 id="Getting-events-for-categories"><a href="#Getting-events-for-categories" class="headerlink" title="Getting events for categories"></a>Getting events for categories</h3><h3 id="Events-view-controller"><a href="#Events-view-controller" class="headerlink" title="Events view controller"></a>Events view controller</h3><h3 id="Wiring-the-days-selector"><a href="#Wiring-the-days-selector" class="headerlink" title="Wiring the days selector"></a>Wiring the days selector</h3><h3 id="Splitting-event-downloads"><a href="#Splitting-event-downloads" class="headerlink" title="Splitting event downloads"></a>Splitting event downloads</h3><h2 id="第十一章：基于时间的Operator"><a href="#第十一章：基于时间的Operator" class="headerlink" title="第十一章：基于时间的Operator"></a>第十一章：基于时间的Operator</h2><p>时间就是一切。响应式编程背后的核心思想是基于时间异步数据流的模型。在这方面, RxSwift 提供了一系列操作, 使你能够处理时间和序列在一段时间内的响应和转换方式。正如你将在本章中看到的, 管理序列的时间维度是简单而直接的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/18/RxSwift-I/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/18/RxSwift-I/" class="post-title-link" itemprop="url">RxSwift I：开始学习 RxSwift</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-05-18 23:01:03" itemprop="dateCreated datePublished" datetime="2018-05-18T23:01:03+08:00">2018-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RxSwift/" itemprop="url" rel="index"><span itemprop="name">RxSwift</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="📒RxSwift-I：开始学习-RxSwift"><a href="#📒RxSwift-I：开始学习-RxSwift" class="headerlink" title="📒RxSwift I：开始学习 RxSwift"></a>📒<strong>RxSwift</strong> I：开始学习 RxSwift</h1><p> <img src="https://gewill.org/assets/Rx_Logo_M.png" alt="Rx_Logo_M.png"></p>
<h2 id="第一章：RxSwift-介绍"><a href="#第一章：RxSwift-介绍" class="headerlink" title="第一章：RxSwift 介绍"></a>第一章：RxSwift 介绍</h2><p>RxSwift是一个组合异步和事件驱动编程的库，通过使用可观察序列和功能样式运算符来，从而允许通过调度程序进行参数化执行。</p>
<p>RxSwift 在本质上简化了开发异步程序，允许代码对新数据作出反应，并以顺序和孤立的方式处理它。</p>
<h3 id="介绍异步编程"><a href="#介绍异步编程" class="headerlink" title="介绍异步编程"></a>介绍异步编程</h3><p><img src="https://gewill.org/assets/51526546882_.pic.jpg" alt="51526546882_.pic.jpg"></p>
<p>使用 Cocoa 和 UIKit 异步的API的问题在于：复杂的异步代码变得非常难写，部分原因是苹果SDK提供的API种类繁多。如NotificationCenter、Delegate、GCD、闭包、Combine。</p>
<p>异步编程词汇表：</p>
<ol>
<li>状态（State），具体地说：共享可变状态</li>
<li>命令式编程（Imperative programming）</li>
<li>副作用（Side effects）</li>
<li>声明式编程（Declarative code）：声明式代码让您可以定义行为片段。只要有相关事件发生，RxSwift 就会运行这些行为，并提供一个不可变的、孤立的数据片段来处理。这样，您可以使用异步代码，但做出与简单 for 循环相同的假设：您正在使用不可变数据并且可以以顺序、确定的方式执行代码。</li>
<li>响应式系统（Reactive systems）</li>
</ol>
<p>响应式系统（Reactive systems）是一个相当抽象的术语，它涵盖了Web或iOS应用程序，它们显示了大多数或全部以下特性：</p>
<ul>
<li>响应式设计（Responsive）：始终保持UI更新，代表了最新的应用程序状态。</li>
<li>能复原的（Resilient）：每个行为都是独立定义的，并提供灵活的错误恢复。</li>
<li>灵活的（Elastic）: 该代码处理不同的工作负载，通常实现诸如懒惰驱动数据收集、事件节流和资源共享等特性。</li>
<li>消息驱动（Message driven）：组件使用基于消息的通信来提高可重用性和隔离性，解耦类的生命周期和实现。</li>
</ul>
<h3 id="RxSwift-基础"><a href="#RxSwift-基础" class="headerlink" title="RxSwift 基础"></a>RxSwift 基础</h3><p><img src="https://gewill.org/assets/61526549641_.pic_hd.jpg" alt="61526549641_.pic_hd.jpg"></p>
<p>这个标志是一只电鳗。(Rx 项目曾经被称为Volta）</p>
<p>RxSwift 是微软开源的 ReactiveX 的Swift语言的实现。</p>
<p><strong>RxSwift</strong> 在传统的<strong>Cocoa</strong>编程和纯函数编程之间找到了最佳位置。它允许您对事件作出反应, 方法是使用不可变的代码定义以确定性的、可组合的方式处理异步输入部分。</p>
<p>Rx代码的三个组成部分是 <code>Observable</code>, <code>Operator</code>和 <code>Scheduler</code>。</p>
<p><code>Observable&lt;Element&gt;</code>类提供了Rx代码的基础：异步产生一系列事件的能力，它可以“携带”数据的不可变快照。简单来说，它允许类在一段时间内订阅其他类发出的值。</p>
<p><code>ObservableType</code> 协议 (<code>Observable</code>需要遵循的) 非常简单。<code>Observable</code>可能发出 (并且<code>Observer</code>能接受) 仅三类型事件:</p>
<p>- next 下一个事件: “携带” 最新 (或  “下一个 “) 数据值的事件。这是<code>Observer</code> “接收” 值的方式。</p>
<p>- completed 已完成的事件: 此事件以成功终止事件序列。这意味着<code>Observable</code>完成其生命周期成功, 不会发出任何其他事件。</p>
<p>- error 错误事件: <code>Observable</code>终止带有错误, 不会发出其他事件.</p>
<p>两种不同的可观测序列: 有限和无限的。</p>
<p>由于它们是高度解耦和可组合的, 所以这些方法通常称为<code>Operator</code>。比如filter。</p>
<p><code>Operator</code>也是高度可组合的，它们总是把数据作为输入并输出它们的结果，所以你可以用许多不同的方式轻松地将它们连接起来，实现比单个<code>Operator</code>自己能做的更多的事情。</p>
<p> <code>Scheduler</code>是<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/DISPATCH">GCD</a>和<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/operationqueue">OperationQueue</a>的Rx等价物。</p>
<p>RxSwift将充当你的订阅（在左边）和<code>Scheduler</code>（在右边）之间的调度器，将工件发送到正确的上下文，并无缝地允许它们与彼此的输出一起工作。</p>
<p><img src="https://gewill.org/assets/71526551674_.pic_hd.jpg" alt="71526551674_.pic_hd.jpg"></p>
<p>要读取此关系图, 请在不同的计划程序中按预定的顺序 (1、2、3、…) 来执行彩色作品。例如:</p>
<p>·蓝色网络订阅以在基于自定义 NSOperation 的计划程序上运行的一段代码 (1) 开始。</p>
<p>·数据输出块作为下一个块 (2) 的输入, 它运行在一个不同的调度程序上, 它位于并发后台 GCD 队列中。</p>
<p>·最后, 在主线程调度程序上计划最后一块蓝色代码 (3), 以便用新数据更新 UI。</p>
<h3 id="App-architecture-应用的架构"><a href="#App-architecture-应用的架构" class="headerlink" title="App architecture 应用的架构"></a>App architecture 应用的架构</h3><p>值得一提的是，RxSwift并没有以任何方式改变应用程序的架构；它主要处理事件、异步数据序列和通用通信协议。</p>
<p>通过在苹果开发文档中实现MVC体系结构，可以创建具有Rx的应用程序。如果你喜欢的话，你也可以选择实现MVP架构或MVVM。RxSwift也可以帮你实现自己的单向数据架构。</p>
<p>微软的MVVM架构是专门针对在平台上创建的事件驱动软件开发的，该平台提供数据绑定。RxSwift和MVVM很好地结合在一起，在这本书的末尾，你会看到这个模式以及如何用RxSwift来实现它。</p>
<p>MVVM和RxSwift结合在一起的原因是，ViewModel允许您公开<code>Observable</code>属性，这些属性可以直接绑定到View Controller 代码中的UIKit控件。这使得绑定模型数据到UI非常简单地展示和编码：</p>
<p><img src="https://gewill.org/assets/81526552550_.pic.jpg" alt="81526552550_.pic.jpg"></p>
<p>本书中的所有其他示例都使用MVC架构来保持示例代码简单易懂。</p>
<h3 id="RxCocoa"><a href="#RxCocoa" class="headerlink" title="RxCocoa"></a>RxCocoa</h3><p>RxSwift是通用Rx API的实现。因此，它不涉及任何Cocoa或UIKit类。</p>
<p>RxCocoa是RxSwift的配套库，所有的类都有助于UIKit和Cocoa的开发。除了具有一些高级类之外，RxCocoa还为许多UI组件添加了响应式扩展，以便您可以订阅不同的UI事件。</p>
<p>例如，使用RxCocoa订阅UISwitch的状态变化是非常容易的，例如：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">toggleSwitch.rx.isOn</span><br><span class="line">	.subcribe(onNext: &#123;enabled <span class="keyword">in</span></span><br><span class="line">    	<span class="built_in">print</span>(enabled <span class="operator">?</span> <span class="string">&quot;it&#x27;s ON&quot;</span> : <span class="string">&quot;it&#x27;s OFF&quot;</span>)</span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure>

<p>RxCocoa adds the rx.isOn property (among others) to the UISwitch class so you can subscribe to generally useful event sequences.</p>
<p>RxCocoa将rx.isOn属性（其中之一）添加到UISwitch类，这样您就可以订阅通常有用的<code>Observable</code>序列。</p>
<p><img src="https://gewill.org/assets/101526552877_.pic.jpg" alt="101526552877_.pic.jpg"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>官方git：<a target="_blank" rel="noopener" href="https://github.com/ReactiveX/RxSwift">https://github.com/ReactiveX/RxSwift</a></p>
<p>使用 <a target="_blank" rel="noopener" href="https://guides.cocoapods.org/using/using-cocoapods.html">CocoaPods</a> 、 <a target="_blank" rel="noopener" href="https://github.com/Carthage/Carthage">Carthage</a> 和 <a target="_blank" rel="noopener" href="https://github.com/apple/swift-package-manager">Swift Package Manager</a> 均很方便集成RxSwift。</p>
<h3 id="RxSwift-和-Combine"><a href="#RxSwift-和-Combine" class="headerlink" title="RxSwift 和 Combine"></a>RxSwift 和 Combine</h3><p>RxSwift 和 Combine（以及 Swift 中的其他相应式编程框架）共享许多通用语言和非常相似的概念。</p>
<p>RxSwift是一个较旧的，完善的框架，具有一些自己的原始概念，运算符名称和类型多样性，这主要是由于其多平台跨语言标准，该标准也适用于Linux，这对于Server-Side Swift非常有用。它也是开源的，所以如果你愿意，你可以直接为其核心做出贡献，并确切地看到它的特定部分是如何工作的。它与所有支持 Swift 的 Apple 平台版本兼容，一直支持 iOS 8。</p>
<p>Combine 是 Apple 新的、闪亮的框架，涵盖了类似的概念，但专门针对 Swift 和 Apple 自己的平台量身定制。它与 Swift 标准库共享许多通用语言，因此即使新手也觉得 API 非常熟悉。它仅支持从iOS 13，macOS 10.15等开始的较新的Apple平台。不幸的是，截至今天，它还没有开源，并且不支持Linux。</p>
<p>幸运的是，由于 RxSwift 和 Combine 非常相似，因此您的 RxSwift 知识可以轻松转移到 Combine，反之亦然。RxCombine（<a target="_blank" rel="noopener" href="https://github.com/CombineCommunity/RxCombine%EF%BC%89%E7%AD%89%E9%A1%B9%E7%9B%AE%E5%85%81%E8%AE%B8%E6%82%A8%E6%A0%B9%E6%8D%AE%E9%9C%80%E8%A6%81%E6%B7%B7%E5%90%88%E6%90%AD%E9%85%8D">https://github.com/CombineCommunity/RxCombine）等项目允许您根据需要混合搭配</a> RxSwift Observables 和 Combine Publishers。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ReactiveX/RxSwift/releases/tag/6.5.0">RxSwift 6.5.0</a> 也迎来了 Swift Concurrency 的支持。提供了互操作性：</p>
<ol>
<li><code>await  </code> 调用<code>Observable</code>的<code>values</code></li>
<li>封装 <code>async</code> Task 为 <code>Observable</code></li>
</ol>
<h3 id="社区"><a href="#社区" class="headerlink" title="社区"></a>社区</h3><p>RxSwift社区非常友好，思想开放，并且热衷于讨论模式，常用技巧或互相帮助。</p>
<p>更多的Rx库和实验，像雨后春笋一样的涌现，可以在这里找到：<a target="_blank" rel="noopener" href="https://github.com/RxSwiftCommunity">https://github.com/RxSwiftCommunity</a></p>
<p>可能最好的方式来满足许多对RxSwift感兴趣的人，这是Slack的频道：<a target="_blank" rel="noopener" href="http://rxswift-slack.herokuapp.com/">http://rxswift-slack.herokuapp.com</a>。</p>
<p>Slack频道拥有约5000名成员！ 日常的主题包括：互相帮助，讨论RxSwift或其同伴库的潜在新功能，以及共享RxSwift博客文章和会议讲座。</p>
<h2 id="第二章：Observables"><a href="#第二章：Observables" class="headerlink" title="第二章：Observables"></a>第二章：Observables</h2><h3 id="Observable-是什么"><a href="#Observable-是什么" class="headerlink" title="Observable 是什么"></a>Observable 是什么</h3><p>Observable、observable sequence 和 sequence 在 Rx 都是一个意思。或者在其他Rx实现中称之为stream。</p>
<blockquote>
<p>最好称之为 Observable，不过翻译过来还是序列顺口些。</p>
</blockquote>
<h3 id="Observable-的生命周期"><a href="#Observable-的生命周期" class="headerlink" title="Observable 的生命周期"></a>Observable 的生命周期</h3><ul>
<li>observable发出包含元素的<strong>next</strong>事件。 它可以继续这样做，直到它：</li>
<li>…发出<strong>error</strong>事件并终止，或</li>
<li>…发出<strong>completed</strong>事件并终止。</li>
<li>一旦observable被终止，它不能再发出事件。</li>
</ul>
<p>将这种概念化的最佳方法之一是使用弹珠图（<strong>Marble Diagrams</strong> 基于时间轴上绘制的值）。</p>
<p><img src="https://gewill.org/assets/141526623515_.pic.jpg" alt="141526623515_.pic.jpg"></p>
<p><img src="https://gewill.org/assets/151526623523_.pic.jpg" alt="151526623523_.pic.jpg"></p>
<h3 id="创建-Observable"><a href="#创建-Observable" class="headerlink" title="创建 Observable"></a><strong>创建</strong> <strong>Observable</strong></h3><p>类型擦除的ObservableType，也就是 Swift 中的泛型。</p>
<p>它代表了一种推式风格队列。</p>
<p>let observable: Observable<Int> &#x3D; Observable<Int>.just(one)</p>
<h3 id="订阅-Observable"><a href="#订阅-Observable" class="headerlink" title="订阅 Observable"></a><strong>订阅</strong> <strong>Observable</strong></h3><p>订阅observable sequence的事件处理程序。</p>
<p>func subscribe(_ on: @escaping (RxSwift.Event&lt;Self.E&gt;) -&gt; Swift.Void) -&gt; Disposable</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> one <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> two <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">let</span> three <span class="operator">=</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> <span class="type">Observable</span>.of(one, two, three)</span><br><span class="line"></span><br><span class="line">observable.subscribe(onNext: &#123; element <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在指定的范围内生成一个整数的observable sequence，使用指定的scheduler生成和发送<code>Observer</code>消息。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">range</span>(<span class="params">start</span>: <span class="keyword">Self</span>.<span class="type">E</span>, <span class="params">count</span>: <span class="keyword">Self</span>.<span class="type">E</span>, <span class="params">scheduler</span>: <span class="type">ImmediateSchedulerType</span> <span class="operator">=</span> <span class="keyword">default</span>) -&gt; <span class="type">RxSwift</span>.<span class="type">Observable</span>&lt;<span class="keyword">Self</span>.<span class="type">E</span>&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt;.range(start: <span class="number">1</span>, count: <span class="number">10</span>)</span><br><span class="line">observable</span><br><span class="line">    .subscribe(onNext: &#123; i <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> n <span class="operator">=</span> <span class="type">Double</span>(i)</span><br><span class="line">        <span class="keyword">let</span> fibonacci <span class="operator">=</span> <span class="type">Int</span>(((pow(<span class="number">1.61803</span>, n) <span class="operator">-</span> pow(<span class="number">0.61803</span>, n)) <span class="operator">/</span></span><br><span class="line">            <span class="number">2.23606</span>).rounded())</span><br><span class="line">        <span class="built_in">print</span>(fibonacci)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Disposing-和-terminating"><a href="#Disposing-和-terminating" class="headerlink" title="Disposing 和 terminating"></a><strong>Disposing 和 terminating</strong></h3><p>请记住, 在收到订阅之前, Observable的内容不会执行任何事情。它是触发一个Observable的开始发出事件的订阅, 直到它发出. error 或.completed完成事件并终止。您可以通过取消对它的订阅来手动终止Observable。</p>
<p><code>subscription.dispose()</code></p>
<p>单独管理每个订阅将是单调乏味的, 因此 RxSwift 引入 DisposeBag 类型。DisposeBag 持有 disposable协议的对象，通常是使用<code>.disposed(by:)</code> 方法, 并将调用dispose(), 当DisposeBag即将deallocated。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observable <span class="operator">=</span> <span class="type">Observable</span>.of(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscription <span class="operator">=</span> observable.subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(event)</span><br><span class="line">&#125;</span><br><span class="line">subscription.dispose()</span><br></pre></td></tr></table></figure>

<p>create操作符接受一个名为subscribe的参数。 它的工作是提供对可观察对象进行调用订阅的实现。 换句话说，它定义了将发送给订阅者的所有事件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">create</span>(<span class="keyword">_</span> <span class="params">subscribe</span>: <span class="keyword">@escaping</span> (<span class="type">AnyObserver</span>&lt;<span class="type">String</span>&gt;) -&gt; <span class="type">Disposable</span>) -&gt; <span class="type">Observable</span>&lt;<span class="type">String</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="创建-observable-工厂类"><a href="#创建-observable-工厂类" class="headerlink" title="创建 observable 工厂类"></a><strong>创建 observable 工厂类</strong></h3><p>可以创建一个可观察的工厂，向每个订阅者发布一个新的Observable，而不是创建一个等待订阅者的Observable。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">deferred</span>(<span class="keyword">_</span> <span class="params">observableFactory</span>: <span class="keyword">@escaping</span> () <span class="keyword">throws</span> -&gt; <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt;) -&gt; <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> flip <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> factory: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; <span class="operator">=</span> <span class="type">Observable</span>.deferred &#123;</span><br><span class="line">    flip <span class="operator">=</span> <span class="operator">!</span>flip</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> flip &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Observable</span>.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Observable</span>.of(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">...</span><span class="number">3</span> &#123;</span><br><span class="line">    factory.subscribe(onNext: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable">$0</span>, terminator: <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">        .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">123 </span><br><span class="line">456 </span><br><span class="line">123 </span><br><span class="line">456</span><br></pre></td></tr></table></figure>

<h3 id="使用Traits"><a href="#使用Traits" class="headerlink" title="使用Traits"></a><strong>使用Traits</strong></h3><p><strong>Traits</strong>是具有比常规Observable更窄的行为集合的一种Observable。它们的使用是可选的；您可以在任何可能使用trait的地方使用常规Observable。他们的目的是提供一种给你的API或者代码的读者更清楚地表达意图的方式。 </p>
<p>RxSwift中有三种Traits: Single, Maybe 和 Completable.</p>
<p>Singles将发出.success(value)或.error事件。 .success(value)实际上是.next和.completed事件的组合。 这对于一次性进程非常有用，它可以成功并产生一个值或失败，例如下载数据或从磁盘加载数据。</p>
<p>下面的例子是读取 <code>Copyright.txt</code> 的文件内容：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">FileReadError</span>: <span class="title class_">Error</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> fileNotFound, unreadable, encodingFailed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">loadText</span>(<span class="params">from</span> <span class="params">filename</span>: <span class="type">String</span>) -&gt; <span class="type">Single</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Single</span>.create &#123; single <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> disposable <span class="operator">=</span> <span class="type">Disposables</span>.create()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> path <span class="operator">=</span> <span class="type">Bundle</span>.main.path(forResource: filename, ofType: <span class="string">&quot;txt&quot;</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            single(.error(<span class="type">FileReadError</span>.fileNotFound))</span><br><span class="line">            <span class="keyword">return</span> disposable</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> data <span class="operator">=</span> <span class="type">FileManager</span>.default.contents(atPath: path) <span class="keyword">else</span> &#123;</span><br><span class="line">            single(.error(<span class="type">FileReadError</span>.unreadable))</span><br><span class="line">            <span class="keyword">return</span> disposable</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> contents <span class="operator">=</span> <span class="type">String</span>(data: data, encoding: .utf8) <span class="keyword">else</span> &#123;</span><br><span class="line">            single(.error(<span class="type">FileReadError</span>.encodingFailed))</span><br><span class="line">            <span class="keyword">return</span> disposable</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        single(.success(contents))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> disposable</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loadText(from: <span class="string">&quot;Copyright&quot;</span>)</span><br><span class="line">    .subscribe &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="variable">$0</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .success(<span class="keyword">let</span> string):</span><br><span class="line">            <span class="built_in">print</span>(string)</span><br><span class="line">        <span class="keyword">case</span> .error(<span class="keyword">let</span> error):</span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>



<h3 id="副作用"><a href="#副作用" class="headerlink" title="副作用"></a><strong>副作用</strong></h3><p> <code>do</code> Operator允许插入副作用，处理程序执行过程中并不会以任何方式更改发出的事件的操作。</p>
<h3 id="打印debug-信息"><a href="#打印debug-信息" class="headerlink" title="打印debug 信息"></a><strong>打印debug 信息</strong></h3><p><code>debug</code> Operator, 它将打印observable的每个事件的信息。</p>
<h2 id="第三章：Subjects"><a href="#第三章：Subjects" class="headerlink" title="第三章：Subjects"></a>第三章：Subjects</h2><h3 id="Subject-是什么"><a href="#Subject-是什么" class="headerlink" title="Subject 是什么"></a>Subject 是什么</h3><p>既可以作为<code>Observable</code>，也可以作为<code>Observer</code>，这就是所谓的 Subjects。</p>
<blockquote>
<p>也是最方便互操作的，<code>BehaviorRelay</code>比较常用。</p>
</blockquote>
<p>RxSwift 中有四个subject类型: </p>
<ol>
<li><code>PublishSubject</code>: 开始为空, 只向订阅者发出新元素. </li>
<li><code>ReplaySubject</code>: 用缓冲区大小, 并将保持元素的缓冲区大小, 并将其重播到新订阅者. </li>
<li><code>BehaviorSubject</code>: 从初始值开始, 将其重播或将最新的元素给新订阅者. </li>
<li><code>AsyncSubject</code>：仅发出序列中的最后一个next事件，并且仅当subject收到completed事件时才发出。这是一个很少使用的主题。</li>
</ol>
<h3 id="PublishSubject"><a href="#PublishSubject" class="headerlink" title="PublishSubject"></a>PublishSubject</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents an object that is both an observable sequence as well as an observer.</span></span><br><span class="line"><span class="comment">/// Each notification is broadcasted to all subscribed observers.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">PublishSubject</span>&lt;<span class="title class_">Element</span>&gt;</span><br></pre></td></tr></table></figure>

<p>当你只是想让订阅者只接受在订阅的时候以后发生的新的事件，直到他们unsubscribe，或者subject已经terminated以.completed或.error事件的方式，PublishSubject就可以派上用场。</p>
<p><img src="https://gewill.org/assets/RxSwiftPublishSubject.jpg" alt="RxSwiftPublishSubject"></p>
<p>第一个订阅者在将 1 添加到subject后进行订阅，因此它不会收到该事件。不过，它确实得到了2和3。由于第二个订阅者在添加2之前不会加入，因此它只能获得3。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">ObservableType</span> &#123;</span><br><span class="line">    <span class="comment">/// 添加带有`id`的观察者并打印每个发出的事件。</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">addObserver</span>(<span class="keyword">_</span> <span class="params">id</span>: <span class="type">String</span>) -&gt; <span class="type">Disposable</span> &#123;</span><br><span class="line">        subscribe &#123; <span class="built_in">print</span>(<span class="string">&quot;观察者:&quot;</span>, id, <span class="string">&quot;事件:&quot;</span>, <span class="variable">$0</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从订阅开始向所有观察者广播新事件。</span></span><br><span class="line">example(<span class="string">&quot;PublishSubject&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line">    <span class="keyword">let</span> subject <span class="operator">=</span> <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;1&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🐶&quot;</span>)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🐱&quot;</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;2&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🅰️&quot;</span>)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🅱️&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    subject.onCompleted()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--- PublishSubject example ---</span><br><span class="line">观察者: 1 事件: next(🐶)</span><br><span class="line">观察者: 1 事件: next(🐱)</span><br><span class="line">观察者: 1 事件: next(🅰️)</span><br><span class="line">观察者: 2 事件: next(🅰️)</span><br><span class="line">观察者: 1 事件: next(🅱️)</span><br><span class="line">观察者: 2 事件: next(🅱️)</span><br><span class="line">观察者: 1 事件: completed</span><br><span class="line">观察者: 2 事件: completed</span><br></pre></td></tr></table></figure>

<h3 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents an object that is both an observable sequence as well as an observer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Each notification is broadcasted to all subscribed and future observers, subject to buffer trimming policies.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReplaySubject</span>&lt;<span class="title class_">Element</span>&gt;</span><br></pre></td></tr></table></figure>

<p>ReplaySubject将临时缓存, 或缓冲区, 它们发出的最新元素, 由您选择的 speciﬁed 大小决定。然后, 他们会将该缓冲区重播到新订阅者。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向所有观察者广播新事件，并向新观察者广播之前指定的bufferSize大小的事件数。</span></span><br><span class="line">example(<span class="string">&quot;ReplaySubject&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line">    <span class="keyword">let</span> subject <span class="operator">=</span> <span class="type">ReplaySubject</span>&lt;<span class="type">String</span>&gt;.create(bufferSize: <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;1&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🐶&quot;</span>)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🐱&quot;</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;2&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🅰️&quot;</span>)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🅱️&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    subject.onCompleted()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--- ReplaySubject example ---</span><br><span class="line">观察者: 1 事件: next(🐶)</span><br><span class="line">观察者: 1 事件: next(🐱)</span><br><span class="line">观察者: 2 事件: next(🐱) // 相比PublishSubject多了订阅前一个事件</span><br><span class="line">观察者: 1 事件: next(🅰️)</span><br><span class="line">观察者: 2 事件: next(🅰️)</span><br><span class="line">观察者: 1 事件: next(🅱️)</span><br><span class="line">观察者: 2 事件: next(🅱️)</span><br><span class="line">观察者: 1 事件: completed</span><br><span class="line">观察者: 2 事件: completed</span><br></pre></td></tr></table></figure>



<h3 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents a value that changes over time.</span></span><br><span class="line"><span class="comment">/// Observers can subscribe to the subject to receive the last (or initial) value and all subsequent notifications.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BehaviorSubject</span>&lt;<span class="title class_">Element</span>&gt;</span><br></pre></td></tr></table></figure>

<p>当您希望使用最新数据预先填充View时, BehaviorSubject非常有用。例如, 可以将用户详情页中的控件绑定到BehaviorSubject, 以便在应用程序获取新数据时, 可以使用最新值来预先填充显示。 </p>
<p><img src="https://gewill.org/assets/RxSwiftBehaviorSubject.png" alt="RxSwiftBehaviorSubject"> </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">example(<span class="string">&quot;BehaviorSubject&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line">    <span class="keyword">let</span> subject <span class="operator">=</span> <span class="type">BehaviorSubject</span>(value: <span class="string">&quot;🔴&quot;</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;1&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🐶&quot;</span>)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🐱&quot;</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;2&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🅰️&quot;</span>)</span><br><span class="line">    subject.onNext(<span class="string">&quot;🅱️&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    subject.onCompleted()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--- BehaviorSubject example ---</span><br><span class="line">观察者: 1 事件: next(🔴) // 相比ReplaySubject多了订阅前一个事件</span><br><span class="line">观察者: 1 事件: next(🐶)</span><br><span class="line">观察者: 1 事件: next(🐱)</span><br><span class="line">观察者: 2 事件: next(🐱)</span><br><span class="line">观察者: 1 事件: next(🅰️)</span><br><span class="line">观察者: 2 事件: next(🅰️)</span><br><span class="line">观察者: 1 事件: next(🅱️)</span><br><span class="line">观察者: 2 事件: next(🅱️)</span><br><span class="line">观察者: 1 事件: completed</span><br><span class="line">观察者: 2 事件: completed</span><br></pre></td></tr></table></figure>

<h3 id="Relay"><a href="#Relay" class="headerlink" title="Relay"></a>Relay</h3><p>Relay在保持其replay行为的同时包装了subject。与其他subject不同，可以使用 <code>accept(_:)</code> 添加值，而非 <code>onNext(_:)</code>。这是因为Relay只能接受值，即不能向它们添加错误或已完成的事件。</p>
<p>PublishRelay将包装PublishSubject ，而BehaviorRelay将包装BehaviorSubject。中继与包装主体的区别在于，它们可以保证永远不会终止。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> RxRelay</span><br><span class="line"></span><br><span class="line">example(<span class="string">&quot;PublishRelay&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line">    <span class="keyword">let</span> subject <span class="operator">=</span> <span class="type">PublishRelay</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;1&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.accept(<span class="string">&quot;🐶&quot;</span>)</span><br><span class="line">    subject.accept(<span class="string">&quot;🐱&quot;</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;2&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.accept(<span class="string">&quot;🅰️&quot;</span>)</span><br><span class="line">    subject.accept(<span class="string">&quot;🅱️&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--- PublishRelay example ---</span><br><span class="line">观察者: 1 事件: next(🐶) //next事件和PublishSubject一样，少了completed事件</span><br><span class="line">观察者: 1 事件: next(🐱)</span><br><span class="line">观察者: 1 事件: next(🅰️)</span><br><span class="line">观察者: 2 事件: next(🅰️)</span><br><span class="line">观察者: 1 事件: next(🅱️)</span><br><span class="line">观察者: 2 事件: next(🅱️)</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> RxRelay</span><br><span class="line"></span><br><span class="line">example(<span class="string">&quot;BehaviorRelay&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> disposeBag <span class="operator">=</span> <span class="type">DisposeBag</span>()</span><br><span class="line">    <span class="keyword">let</span> subject <span class="operator">=</span> <span class="type">BehaviorRelay</span>&lt;<span class="type">String</span>&gt;(value: <span class="string">&quot;🔴&quot;</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;1&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.accept(<span class="string">&quot;🐶&quot;</span>)</span><br><span class="line">    subject.accept(<span class="string">&quot;🐱&quot;</span>)</span><br><span class="line"></span><br><span class="line">    subject.addObserver(<span class="string">&quot;2&quot;</span>).disposed(by: disposeBag)</span><br><span class="line">    subject.accept(<span class="string">&quot;🅰️&quot;</span>)</span><br><span class="line">    subject.accept(<span class="string">&quot;🅱️&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--- BehaviorRelay example ---</span><br><span class="line">观察者: 1 事件: next(🔴)  //next事件和BehaviorSubject，少了completed事件</span><br><span class="line">观察者: 1 事件: next(🐶)</span><br><span class="line">观察者: 1 事件: next(🐱)</span><br><span class="line">观察者: 2 事件: next(🐱)</span><br><span class="line">观察者: 1 事件: next(🅰️)</span><br><span class="line">观察者: 2 事件: next(🅰️)</span><br><span class="line">观察者: 1 事件: next(🅱️)</span><br><span class="line">观察者: 2 事件: next(🅱️)</span><br></pre></td></tr></table></figure>



<h2 id="第四章：Observables-和-Subjects-实践"><a href="#第四章：Observables-和-Subjects-实践" class="headerlink" title="第四章：Observables 和 Subjects 实践"></a>第四章：Observables 和 Subjects 实践</h2><p>本章重点是在一个完整的应用开发中使用RxSwift，一步一步的学会如何把概念应用到实际项目中。</p>
<h3 id="在-view-controller-中使用-subject-x2F-relay"><a href="#在-view-controller-中使用-subject-x2F-relay" class="headerlink" title="在 view controller 中使用 subject&#x2F;relay"></a>在 view controller 中使用 subject&#x2F;relay</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">  <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">  images</span><br><span class="line">    .subscribe(onNext: &#123; [<span class="keyword">weak</span> imagePreview] photos <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> preview <span class="operator">=</span> imagePreview <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">      preview.image <span class="operator">=</span> photos.collage(size: preview.frame.size)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line"></span><br><span class="line">  images</span><br><span class="line">    .subscribe(onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] photos <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">self</span><span class="operator">?</span>.updateUI(photos: photos)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: bag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-subject-在-view-controller-之间传值"><a href="#使用-subject-在-view-controller-之间传值" class="headerlink" title="使用 subject 在 view controller 之间传值"></a>使用 subject 在 view controller 之间传值</h3><p>view controller 之间传值可以通过 delegate，但是用 subject 更好。</p>
<p><img src="https://gewill.org/assets/Talkingtootherviewcontrollersviadelegate.jpg" alt="Talkingtootherviewcontrollersviadelegate"></p>
<p><img src="https://gewill.org/assets/Talkingtootherviewcontrollersviasubjects.jpg" alt="Talkingtootherviewcontrollersviasubjects"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">actionAdd</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> photosViewController <span class="operator">=</span> storyboard<span class="operator">!</span>.instantiateViewController(</span><br><span class="line">        withIdentifier: <span class="string">&quot;PhotosViewController&quot;</span>) <span class="keyword">as!</span> <span class="type">PhotosViewController</span></span><br><span class="line"></span><br><span class="line">    navigationController<span class="operator">!</span>.pushViewController(photosViewController, animated: <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    photosViewController.selectedPhotos</span><br><span class="line">        .subscribe(</span><br><span class="line">            onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] newImage <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> images <span class="operator">=</span> <span class="keyword">self</span><span class="operator">?</span>.images <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                images.accept(images.value <span class="operator">+</span> [newImage])</span><br><span class="line">            &#125;,</span><br><span class="line">            onDisposed: &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;completed photo selection&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        .disposed(by: bag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="封装已有API为Observable"><a href="#封装已有API为Observable" class="headerlink" title="封装已有API为Observable"></a>封装已有API为Observable</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Photos</span><br><span class="line"><span class="keyword">import</span> RxSwift</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoWriter</span> &#123;</span><br><span class="line">  <span class="keyword">enum</span> <span class="title class_">Errors</span>: <span class="title class_">Error</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> couldNotSavePhoto</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">save</span>(<span class="keyword">_</span> <span class="params">image</span>: <span class="type">UIImage</span>) -&gt; <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Observable</span>.create &#123; observer <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">var</span> savedAssetId: <span class="type">String</span>?</span><br><span class="line">      <span class="type">PHPhotoLibrary</span>.shared().performChanges(&#123;</span><br><span class="line">        <span class="keyword">let</span> request <span class="operator">=</span> <span class="type">PHAssetChangeRequest</span>.creationRequestForAsset(from: image)</span><br><span class="line">        savedAssetId <span class="operator">=</span> request.placeholderForCreatedAsset<span class="operator">?</span>.localIdentifier</span><br><span class="line">      &#125;, completionHandler: &#123; success, error <span class="keyword">in</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">          <span class="keyword">if</span> success, <span class="keyword">let</span> id <span class="operator">=</span> savedAssetId &#123;</span><br><span class="line">            observer.onNext(id)</span><br><span class="line">            observer.onCompleted()</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            observer.onError(error <span class="operator">??</span> <span class="type">Errors</span>.couldNotSavePhoto)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RxSwift-traits-实践"><a href="#RxSwift-traits-实践" class="headerlink" title="RxSwift traits 实践"></a>RxSwift traits 实践</h3><h4 id="Single"><a href="#Single" class="headerlink" title="Single"></a>Single</h4><p>Single 只有<code>.success</code> 或 <code>.error</code> 两种事件 。适合作为封装网络接口的返回值，要么成功，要么失败。<img src="https://gewill.org/assets/single.jpg" alt="single"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PhotoWriter</span>.save(image)</span><br><span class="line">      .asSingle()</span><br><span class="line">      .subscribe(onSuccess: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] id <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span><span class="operator">?</span>.showMessage(<span class="string">&quot;Saved with id: <span class="subst">\(id)</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">self</span><span class="operator">?</span>.actionClear()</span><br><span class="line">        &#125;, onError: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] error <span class="keyword">in</span></span><br><span class="line">          <span class="keyword">self</span><span class="operator">?</span>.showMessage(<span class="string">&quot;Error&quot;</span>, description: error.localizedDescription)</span><br><span class="line">      &#125;)</span><br><span class="line">      .disposed(by: bag)</span><br></pre></td></tr></table></figure>

<h4 id="Maybe"><a href="#Maybe" class="headerlink" title="Maybe"></a>Maybe</h4><p>Maybe 有三种事件：<code>.success</code>、<code>.completed</code> 和 <code>.error</code> 。</p>
<p>和 Single 一样，你既可以通过 <code>Maybe.create(&#123; ... &#125;)</code> 直接创建，也可以使用 <code>.asMaybe()</code></p>
<p><img src="https://gewill.org/assets/maybe.jpg" alt="maybe"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PhotoWriter</span>.save(image)</span><br><span class="line">    .asMaybe()</span><br><span class="line">    .subscribe(</span><br><span class="line">        onSuccess: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] id <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.showMessage(<span class="string">&quot;Saved with id: <span class="subst">\(id)</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.actionClear()</span><br><span class="line">        &#125;,</span><br><span class="line">        onError: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.showMessage(<span class="string">&quot;Error&quot;</span>, description: error.localizedDescription)</span><br><span class="line">        &#125;,</span><br><span class="line">        onCompleted: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.showMessage(<span class="string">&quot;Saved&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    .disposed(by: bag)</span><br></pre></td></tr></table></figure>

<h4 id="Completable"><a href="#Completable" class="headerlink" title="Completable"></a>Completable</h4><p>Completable 只有<code>.completed</code> 和 <code>.error</code> 两种事件。适合只关心是否完成，而不需要传递value的情况。使用方法：<code>Completable.create(&#123; ... &#125;)</code></p>
<p><img src="https://gewill.org/assets/completable.jpg" alt="completable"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoWriter</span> &#123;</span><br><span class="line">  <span class="keyword">enum</span> <span class="title class_">Errors</span>: <span class="title class_">Error</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> couldNotSavePhoto</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">save</span>(<span class="keyword">_</span> <span class="params">image</span>: <span class="type">UIImage</span>) -&gt; <span class="type">Completable</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Completable</span>.create &#123; completable <span class="keyword">in</span></span><br><span class="line">      <span class="type">PHPhotoLibrary</span>.shared().performChanges(&#123;</span><br><span class="line">        <span class="type">PHAssetChangeRequest</span>.creationRequestForAsset(from: image)</span><br><span class="line">      &#125;, completionHandler: &#123; success, error <span class="keyword">in</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">          <span class="keyword">if</span> success &#123;</span><br><span class="line">            completable(.completed)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            completable(.error(error <span class="operator">??</span> <span class="type">Errors</span>.couldNotSavePhoto))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">PhotoWriter</span>.save(image)</span><br><span class="line">  .subscribe(</span><br><span class="line">    onCompleted: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">self</span><span class="operator">?</span>.showMessage(<span class="string">&quot;Saved&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    onError: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] error <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">self</span><span class="operator">?</span>.showMessage(<span class="string">&quot;Error&quot;</span>, description: error.localizedDescription)</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  .disposed(by: bag)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/10/Realm-Notes-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/10/Realm-Notes-2/" class="post-title-link" itemprop="url">Realm 笔记(二)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-05-10 20:46:38" itemprop="dateCreated datePublished" datetime="2018-05-10T20:46:38+08:00">2018-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://cdn-images-1.medium.com/max/1600/1*s1KQFE3IHyzb_PKF-q_wHA@2x.png" alt="RealmsSchema"></p>
<p><strong>系列文章目录：</strong></p>
<ol>
<li><a target="_blank" rel="noopener" href="http://gewill.org/2018/04/26/Realm-Notes-1/">Realm 笔记 (一)</a></li>
<li><a target="_blank" rel="noopener" href="http://gewill.org/2018/05/10/Realm-Notes-2/">Realm 笔记 (二)</a></li>
</ol>
<h3 id="第七章：Realm配置"><a href="#第七章：Realm配置" class="headerlink" title="第七章：Realm配置"></a>第七章：<strong>Realm</strong>配置</h3><p>打开一个Realm:<code>let realm = try! Realm()</code></p>
<p>Realm没有使用单例，而是每次直接尝试新建一个Realm实例，有以下几个运行时优化：</p>
<ol>
<li>调用Realm()返回同一个共享实例，而不受创建该Realm实例的线程限制。而Object和Realm实例被限制在创建的线程中，所以不能跨线程分享。</li>
<li>Realm也提供了多个安全措施，如：使用不同的密钥或文件不存在均会报错。</li>
</ol>
<blockquote>
<p>书中均使用 try! ，但实际生产环境你可以进行错误处理。</p>
</blockquote>
<p><code>deleteRealmIfMigrationNeeded</code> 新版直接删除Realm文件，不做迁移处理。</p>
<p>存在文件在Documents文件夹有几个好处：自动备份到用户的iCloud storage，方便用户使用iTunes备份和访问。当然苹果推荐存储文件在Library文件夹。</p>
<p>App Bundle 文件夹是只读的，所以该目录中的Realm是能作为只读数据库。</p>
<p>加密在Realm极为简单，只要在配置中添加一个64位的密钥即可。</p>
<h3 id="第八章：多个Realm和共享Realm"><a href="#第八章：多个Realm和共享Realm" class="headerlink" title="第八章：多个Realm和共享Realm"></a>第八章：多个<strong>Realm</strong>和共享<strong>Realm</strong></h3><p>创建一个RealmProvider以方便操作Realm，尤其是涉及多个Realm或加密等情况。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*W8tnptm39Ixw0gvV-ub4FA.jpeg" alt="img"></p>
<p>如需转换JSON、CSV或纯文本为Realm，并内置到App Bundle。此时可以创建一个Target和来Tools.swift，自动生成Realm文件。把生成的Realm文件拖入Xcode即可。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*PQoGupwjm1ZNHXXRjQysUA.jpeg" alt="img"></p>
<h3 id="第九章：依赖注入和测试"><a href="#第九章：依赖注入和测试" class="headerlink" title="第九章：依赖注入和测试"></a>第九章：依赖注入和测试</h3><p>在本章中，您将学习两个重要主题：如何使用依赖注入来改进 Flash Cards 应用的架构，以及如何编写由Realm支持的同步和异步测试。</p>
<p>本章不会深入研究诸如测试驱动开发等主题，而是专注测试使用 Realm Object的类的技巧，并且依赖于特定于Realm的功能，例如更改通知。</p>
<h4 id="测试-cards-场景-Scene"><a href="#测试-cards-场景-Scene" class="headerlink" title="测试 cards 场景(Scene)"></a><strong>测试 cards 场景(Scene)</strong></h4><ul>
<li>CardsViewController：设置所需的手势识别器并根据用户的输入更新UI。本章不会介绍UI测试。</li>
<li>CardsModel：从Realm中抽象查询对象的简单封装。为它编写测试将意味着在测试中重复相同的代码并比较输出，而不提供实际值。除此之外，你真正要在这里测试的将是Realm的底层实现，它已经经过了充分测试。</li>
<li>CardsViewModel：实现此场景的业务逻辑。它格式化Model的输出，以显示在屏幕上，并提供与模型交互的方法。这将是一些单元测试的完美候选！</li>
</ul>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*vhkdTdhoOoY1dQW3yPescA.jpeg" alt="img"></p>
<p>这里只是简单测试 ViewModel 初始化和更新状态。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*dmF8jn3bhAwCz7kzsys2cw.jpeg" alt="img"></p>
<h4 id="测试-sets-场景"><a href="#测试-sets-场景" class="headerlink" title="测试 sets 场景"></a>测试 sets 场景</h4><p>在显示列表的场景中，您的视图模型依赖于Realm通知来动态更新数据。你必须：</p>
<ul>
<li>模拟Realm框架以测试依赖通知的 ViewModel 和其他高级Realm功能。</li>
<li>编写依赖Realm通知的测试</li>
</ul>
<p>为了使测试有效，您需要稍微更改代码以提供一个方法将测试的 Realm providers 注入到Model和ViewModel中。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*gfi15_iu5vDJ-u7YgZ6dcQ.jpeg" alt="img"></p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*xnR1I5wQ3laa3dVpLMqPoQ.jpeg" alt="img"></p>
<p>异步测试需要使用XCTestExpectation，这个期望类将帮助你等待某些条件在您的测试中得到满足，然后再转到您测试断言的部分。</p>
<p>在使用XCTWaiter类来持有测试的执行，直到满足期望为止。 XCTWaiter是Apple的XCTest框架中的一个便捷类，它暂时停止当前代码的执行，而不会阻塞当前线程。 XCTWaiter定期检查期望的状态，因此当异步代码将执行计数增加到3时，XCTWaiter将负责恢复执行测试。</p>
<p>步骤如下：</p>
<ul>
<li>初始化XCTestExpectation和expectedFulfillmentCount</li>
<li>在异步回调中fulfill，</li>
<li>最后添加定期检查结果的帮助类XCTWaiter。</li>
</ul>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*dTCJ1PW8lPGR6l3_W5GBnQ.jpeg" alt="img"></p>
<h4 id="测试-Word-of-Today-场景"><a href="#测试-Word-of-Today-场景" class="headerlink" title="测试 Word of Today 场景"></a>测试 Word of Today 场景</h4><p><img src="https://cdn-images-1.medium.com/max/1600/1*FDEM3iDyXtpv-Yqp3iRIIA.jpeg" alt="img"></p>
<h4 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h4><p>在本章中，你将亲身体验用Realm编写同步和异步测试的简易性。本章中重点是：</p>
<ul>
<li>测试自己的逻辑，而不是Realm，因为它已经在全球数百万用户中得到了充分测试和使用。</li>
<li>“哑”模型和视图控制器可以更轻松地测试视图模型，您通常可以在其中放置MVVM应用程序的逻辑。</li>
<li>编写需要这些依赖项的特定测试版本的测试时，使用中央provider结构来抽取某些依赖项的检索很有用。</li>
</ul>
<p>通常，测试基于Realm的代码可能不会改变您构建自己的测试套件的方式。借助本章的经验，您应该能够为您的Realm项目编写可靠的测试，无论你心意哪一种架构。</p>
<blockquote>
<p>注意：对于单元测试，模拟Realm本身是一个偏爱的问题。如果你想模拟Realm并从测试套件中删除Realm依赖关系，你可以模拟关键的方法，比如对象（^）、过滤器（^）等等。风险是你必须增加和保持的代码量，以保持与Realm自己行为的一致，尤其是已经有了基于内存的Realm这个特别棒的方案。</p>
</blockquote>
<blockquote>
<p>笔者觉得模拟Realm的唯一好处是，Realm依赖增加了CI服务器需要安装，构建和测试应用程序的时间。</p>
</blockquote>
<h3 id="第十章：高效率的多线程"><a href="#第十章：高效率的多线程" class="headerlink" title="第十章：高效率的多线程"></a>第十章：高效率的多线程</h3><p>Realm线程：多线程访问同一个Realm总是可以读写到最新的数据。</p>
<p>线程间传递Object，有以下两个替代方法：</p>
<ul>
<li>传递Object的主键</li>
<li>使用ThreadSafeReference：<code>let ref = ThreadSafeReference(to: myRealmObject)</code> 和 <code>let myRealmobject = realm.resolve(ref)</code></li>
</ul>
<p>主线程：访问带主键合适数量的数据时，无需担心性能问题。如在View Controller lifecycle 和 UIKit delegate 中直接读取Object，和更新UI。因为总是在同一个Realm文件的快照中工作，所以速度最快。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*Sae-yNE-Z8AiShY1NJPY9A.jpeg" alt="img"></p>
<p>后台线程：（不推荐）由于是异步并发执行，会因为Realm 快照之间同步问题，产生性能和体积大的问题。</p>
<p>专用线程：（推荐）可以解决主线程影响UI，后台线程性能问题。使用Thread，自己维护一个线程的生命周期，所有读写都在该线程操作。还可以缓存任务批量提交读写事务，进一步提高性能。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*vJX_oPQhAAXBeFCDHFyIfQ.jpeg" alt="img"></p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*qdG-8dAadridla-Oztjq5w.jpeg" alt="img"></p>
<p>简版（无缓冲机制）</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*yaxbDhdgZUPxzFNbAIEozA.jpeg" alt="img"></p>
<blockquote>
<p><em>未完待续…</em></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/26/Realm-Notes-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/04/26/Realm-Notes-1/" class="post-title-link" itemprop="url">Realm 笔记 (一)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-04-26 00:22:51" itemprop="dateCreated datePublished" datetime="2018-04-26T00:22:51+08:00">2018-04-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://cdn-images-1.medium.com/max/2000/1*yludU713C9JyEUMDrAOAAA.png" alt="img"></p>
<p><strong>系列文章目录：</strong></p>
<ol>
<li><a target="_blank" rel="noopener" href="http://gewill.org/2018/04/26/Realm-Notes-1/">Realm 笔记 (一)</a></li>
<li><a target="_blank" rel="noopener" href="http://gewill.org/2018/05/10/Realm-Notes-2/">Realm 笔记 (二)</a></li>
</ol>
<p>Realm Database 基于C++编写的核心引擎，支持多平台多语言的移动端数据库。因其面向对象存取模型，高效的性能，开源的特性，不失为移动端数据库好的选择。之前项目也有使用过，基本上看官方文档和Demo，即可解决大部分问题。最近买了 <a target="_blank" rel="noopener" href="https://store.raywenderlich.com/products/advanced-swift-spring-bundle"><strong>Advanced Swift Spring Bundle</strong></a>，包含 <a target="_blank" rel="noopener" href="https://store.raywenderlich.com/products/realm-building-modern-swift-apps-with-realm-database"><strong>Realm: Building Modern Swift Apps with Realm Database</strong></a>， 故再系统学习一遍，是为此笔记。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*SfLo1QJ9UlaSP9aMUXeDlQ.jpeg" alt="img"></p>
<hr>
<h3 id="第一章：介绍Realm"><a href="#第一章：介绍Realm" class="headerlink" title="第一章：介绍Realm"></a>第一章：介绍<strong>Realm</strong></h3><ol>
<li>Realm API是更现代且符合最佳实践的代码，比处理C语言的API和SQLite容易的多。亦即无需使用SQL语言，而是苹果的NSPredicate。</li>
<li>Realm 数据库的设计哲学的基础之一是现代的应用开发使用的对象。模型就是对象，Realm提供基类Object，继承自NSObject。属性也支持Swift中原始和基本类型，对集合类也进行了封装，纯面向对象编程。</li>
</ol>
<blockquote>
<p>对象：是指面向对象编程中的对象，Object：文中专指Realm中模型的基类Object</p>
</blockquote>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*z94UQYxtiBuEukF1tNX9QA.jpeg" alt="img"></p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*F-lFrV14ZiWJ6KvKTpcYHA.jpeg" alt="img"></p>
<p>3.如果你偏爱 struct，只需要添加 <code>toStruct()</code> 和 <code>fromStruct(_)</code> 方法到 object，即可快速读取struct的数据。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*xRzIP6U43If9mmRRs3_mZQ.jpeg" alt="img"></p>
<hr>
<h3 id="第三章：Object基础和数据类型"><a href="#第三章：Object基础和数据类型" class="headerlink" title="第三章：Object基础和数据类型"></a>第三章：<strong>Object</strong>基础和数据类型</h3><p><strong>数据类型：</strong></p>
<ol>
<li>对象类型属性：<code>@objc dynamic var</code> 修饰，String、Date、Data，支持可选</li>
<li>原始类型属性：包含Bool、Int、Float、Double。<code>let allowsPublication = RealmOptional&lt;Bool&gt;()</code> 需要使用Realm封装的可选类型</li>
<li>自定义类型：比如封装CLLocation、封装枚举值</li>
</ol>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*GunTyiEKB1zNoiEnGSroBw.jpeg" alt="img"></p>
<p><strong>属性速查表</strong></p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*SqX_HG9aGL54qmy1Kazz_A.png" alt="img"></p>
<p><strong>Object支持还以下几个属性：</strong></p>
<ol>
<li>计算属性</li>
<li>主键：在移动应用使用自增主键不是一个好主意，尤其是使用Realm。</li>
<li>索引：谨慎的使用索引，仅在反复查询的属性上使用。</li>
<li>忽略属性</li>
</ol>
<blockquote>
<p>@objcMembers 修饰 Object，是非常适合使用的一个场景。</p>
</blockquote>
<hr>
<h3 id="第四章：模式和关系"><a href="#第四章：模式和关系" class="headerlink" title="第四章：模式和关系"></a>第四章：模式和关系</h3><ol>
<li>对一</li>
<li>对多（Object）：使用List，和Swift中Array类似</li>
<li>对多（Value）：</li>
<li>反向关系：<code>LinkingObjects</code></li>
</ol>
<hr>
<h3 id="第五章：读写"><a href="#第五章：读写" class="headerlink" title="第五章：读写"></a>第五章：读写</h3><h4 id="查询结果（Results）"><a href="#查询结果（Results）" class="headerlink" title="查询结果（Results）"></a>查询结果（Results）</h4><p>Results 是一个惰性抓取持久化数据的API。</p>
<p>过滤结果：使用NSPredicate</p>
<ol>
<li>子查询谓词（Sub-query predicates）</li>
</ol>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*kiYuU27N3RaABADVMi8t0Q.jpeg" alt="img"></p>
<ol start="2">
<li>谓词速查表</li>
</ol>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*ztDnH8wGK2CTDJF-NGF_Zg.jpeg" alt="img"></p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*fMvjsbdNWZzu4ejFep0p-Q.jpeg" alt="img"></p>
<p>排序结果：单属性排序 .sorted(byKeyPath: “firstName”) 和多个属性排序</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*OF-2iPzx0DIPgYgSvi4Mvw.jpeg" alt="img"></p>
<p>写入数据时：因为存储Object包括修改属性，都会修改硬盘文件，必须进行写入事务。</p>
<hr>
<h3 id="第六章：通知和响应式应用"><a href="#第六章：通知和响应式应用" class="headerlink" title="第六章：通知和响应式应用"></a>第六章：通知和响应式应用</h3><h4 id="更改的通知"><a href="#更改的通知" class="headerlink" title="更改的通知"></a>更改的通知</h4><p>Realm 的核心特征之一就是数据永不过时的理念。</p>
<p><strong>通知三个级别：</strong></p>
<ol>
<li>Object</li>
<li>Collection：list、results、linking objects</li>
<li>Realm</li>
</ol>
<p><strong>通知的细节：</strong></p>
<ol>
<li>线程：通知回调在和订阅通知相同线程被调用。</li>
<li>Run loop：Realm使用 run loop 发送更改通知。因此你只能在有 run loop的线程订阅通知。</li>
<li>通知的间隔尺度（granularity）：Realm在每次成功写入事务后推送通知给观察者。因为推送使用的是订阅线程的run loop（可能有时候忙于其它事情），可能会在Realm发生了其它更改才送达。这种情况下，Realm会聚集所有更改一起推送通知。</li>
<li>仅限持久化的 Object</li>
<li>通知令牌（Notiﬁcation tokens）：手动invalidate()或者在内存中释放（View Controller 被释放）</li>
</ol>
<p><strong>响应式应用</strong></p>
<p>响应式系统拥有以下几个关键特性：对发生的变化做出反应，使用基于消息的工作流程，具有扩展能力等等。Realm 都提供了完整的支持。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/03/06/iOS-UI-Develop-Shortcut-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/06/iOS-UI-Develop-Shortcut-Notes/" class="post-title-link" itemprop="url">iOS UI 开发捷径 - 笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-06 20:59:40" itemprop="dateCreated datePublished" datetime="2018-03-06T20:59:40+08:00">2018-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>该书对IB的讲解还是比较全面详细，建议大家读读，也算是差缺补漏。以下是我的一些笔记。</p>
<ol>
<li>xib 固化为 nib，storyboard 固化为 storyboardc。</li>
<li>IB文件冲突，Open source 的方式查看和编辑。</li>
<li>同一个sb文件中的不同的VC都应该设置一个不同的StoryboardID与之对应</li>
<li>App 启动过程，手动新建 main.swift 即可编辑修改。</li>
<li>IB文件的 Target Membership的作用：当工程的某个Target被编译，只有IB文件中该Target被勾选，才会被序列化为对应的nib或storyboardc文件，并存放在该Target对应的Bundle中。</li>
<li>Custom Class -&gt; Module 标签是针对Swift设计的，代表命名空间。</li>
<li>Document -&gt; Label 给每个控件起一个简短的名字。</li>
<li>IB使用Auto Layout，根据实时反馈机制，发现问题解决问题。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/09/21/Migrating-to-Swift-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/21/Migrating-to-Swift-4/" class="post-title-link" itemprop="url">迁移 Swift 4</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-21 10:17:00" itemprop="dateCreated datePublished" datetime="2017-09-21T10:17:00+08:00">2017-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>直接可以参考官方的文档即可：<a target="_blank" rel="noopener" href="https://swift.org/migration-guide-swift4/">https://swift.org/migration-guide-swift4/</a></p>
<h2 id="简单记录我的步骤："><a href="#简单记录我的步骤：" class="headerlink" title="简单记录我的步骤："></a>简单记录我的步骤：</h2><ol>
<li>利用Xcode9的 Swift Migrator tool迁移Swift3.2</li>
<li>利用Xcode9的 Swift Migrator tool迁移Swift4</li>
<li>如果是<a target="_blank" rel="noopener" href="https://cocoapods.org/">CocoaPods</a>，目前建议保持Swift3。Xcode9支持Swift3和Swift4的target混合编译，这也是这么快能把项目迁移Swift4的原因。<a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Compatibility.html">https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Compatibility.html</a></li>
</ol>
<h2 id="需要手动更改的地方："><a href="#需要手动更改的地方：" class="headerlink" title="需要手动更改的地方："></a>需要手动更改的地方：</h2><ol>
<li><p><code>NSAttributedString</code> attributes 类型<code> [String: Any]</code> 改为 <code>[NSAttributedStringKey : Any]</code></p>
</li>
<li><p>Swift Migrator tool 会错误地转为<code>NSAttributedString.DocumentAttributeKey.documentType</code> 改为<code>NSAttributedString.DocumentReadingOptionKey.documentType</code></p>
</li>
<li><p>Swift 4: Cannot assign value of type ‘(_) -&gt; Void’ to type ‘(() -&gt; ())?’ 部分情况不能使用下面的简写格式。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="variable">$0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><p>Method ‘initialize()’ defines Objective-C class method ‘initialize’, which is not permitted by Swift。 关于Swift4不支持initialize()这个问题，先跳过了，项目只有工具类定义且未使用。</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一次新版本迁移很轻松，API更改也不多，强烈迁移立即迁移Swift4。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/07/10/inch-per-point-on-different-of-iPhones/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/10/inch-per-point-on-different-of-iPhones/" class="post-title-link" itemprop="url">iPhone 点与物理尺寸的关系</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-10 02:19:53" itemprop="dateCreated datePublished" datetime="2017-07-10T02:19:53+08:00">2017-07-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://i.imgur.com/mkOJeb0.png" alt="The Ultimate Guide To iPhone Resolutions"></p>
<p>最近思考设计稿一个字号显示在不同设备物理尺寸是否一致，即对于用户看到的大小是否一致？</p>
<p>因此从理论和实践两个方面对于三个尺寸(4、4.7、5.5)英寸的差异。</p>
<h2 id="1-理论："><a href="#1-理论：" class="headerlink" title="1. 理论："></a>1. 理论：</h2><p>参考资料：The Ultimate Guide To iPhone Resolutions <a target="_blank" rel="noopener" href="https://www.paintcodeapp.com/news/ultimate-guide-to-iphone-resolutions">https://www.paintcodeapp.com/news/ultimate-guide-to-iphone-resolutions</a></p>
<p>根据上图的计算每个点对应物理尺寸，公式为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">piexl / inch = (point * (render * downsmaping)) / inch </span><br><span class="line"></span><br><span class="line">inch / point = (render * downsmaping) / (piexl / inch)</span><br></pre></td></tr></table></figure>

<p>每个点的大小 等于  每个点实际对应的像素数 除以 每英寸像素（PPI）</p>
<table>
<thead>
<tr>
<th></th>
<th>render</th>
<th>downsmaping</th>
<th>piexl &#x2F; inch</th>
<th>inch &#x2F; point</th>
<th>20 * (inch &#x2F; point)</th>
</tr>
</thead>
<tbody><tr>
<td>4”</td>
<td>2</td>
<td>1</td>
<td>326</td>
<td>0.00613497</td>
<td>0.12269939</td>
</tr>
<tr>
<td>4.7”</td>
<td>2</td>
<td>1</td>
<td>326</td>
<td>0.00613497</td>
<td>0.12269939</td>
</tr>
<tr>
<td>5.5”</td>
<td>3</td>
<td>1&#x2F;1.15</td>
<td>401</td>
<td>0.00650548</td>
<td>0.13010951</td>
</tr>
</tbody></table>
<p>1.06039312336 &#x3D; 0.00650548 &#x2F; 0.00613497</p>
<p>结论：<strong>4” 和 4.7” 完全一致，5.5”同样点数要比其他的大，约为1.06倍。</strong></p>
<h2 id="2-实践："><a href="#2-实践：" class="headerlink" title="2. 实践："></a>2. 实践：</h2><p>写了一个Demo <a target="_blank" rel="noopener" href="https://github.com/gewill/Demo/tree/PPI">https://github.com/gewill/Demo/tree/PPI</a> ，真机量了一下物理尺寸也和上面的结论一致。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 各种字号的文本</span></span><br><span class="line">   <span class="keyword">func</span> <span class="title function_">drawLabel</span>() &#123;</span><br><span class="line">       <span class="keyword">var</span> y: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">40</span></span><br><span class="line">       <span class="keyword">for</span> size <span class="keyword">in</span> <span class="number">13</span><span class="operator">...</span><span class="number">24</span> &#123;</span><br><span class="line">           <span class="keyword">let</span> label <span class="operator">=</span> <span class="type">UILabel</span>()</span><br><span class="line">           label.text <span class="operator">=</span> <span class="string">&quot;Font size: <span class="subst">\(size)</span>-壹拾贰亿拾陆-@#￥ABCxyz&quot;</span></span><br><span class="line">           label.font <span class="operator">=</span> <span class="type">UIFont</span>.systemFont(ofSize: <span class="type">CGFloat</span>(size))</span><br><span class="line">           label.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.green.withAlphaComponent(<span class="number">0.4</span>)</span><br><span class="line">           y <span class="operator">+=</span> <span class="type">CGFloat</span>(size) <span class="operator">+</span> <span class="number">20</span></span><br><span class="line">           label.frame <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">0</span>, y: y, width: <span class="type">UIScreen</span>.main.bounds.width, height: <span class="type">CGFloat</span>(size))</span><br><span class="line">           <span class="keyword">self</span>.view.addSubview(label)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/07/06/Modern-User-Interaction-on-iOS-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/06/Modern-User-Interaction-on-iOS-Notes/" class="post-title-link" itemprop="url">Modern User Interaction on iOS - 笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-06 22:31:48" itemprop="dateCreated datePublished" datetime="2017-07-06T22:31:48+08:00">2017-07-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>WWDC 2017 Session 219 地址：[<a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2017/219/">https://developer.apple.com/videos/play/wwdc2017/219/</a></p>
<p>目录：</p>
<ul>
<li>手势 The UIGestureRecognizer system</li>
<li>系统手势 System gesture interaction</li>
<li>拖拽 Drag and Drop</li>
</ul>
<h3 id="1-手势"><a href="#1-手势" class="headerlink" title="1. 手势"></a>1. 手势</h3><h4 id="基础："><a href="#基础：" class="headerlink" title="基础："></a>基础：</h4><ul>
<li><p>UIGestureRecognizer 比 UITouch 优先级高</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UIGestureRecognizer</span>: <span class="title class_">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> delaysTouchesEnded: <span class="type">Bool</span> <span class="comment">// default is true.</span></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> cancelsTouchesInView: <span class="type">Bool</span> <span class="comment">// default is true.</span></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> delaysTouchesBegan: <span class="type">Bool</span> <span class="comment">// default is false.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><p>UIGestureRecognizer 只有一个的胜出相应手势</p>
</li>
<li><p>UIGestureRecognizer 是否允许同时响应其他手势：在delegate可控制</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">protocol</span> <span class="title class_">UIGestureRecognizerDelegate</span>: <span class="title class_">NSObjectProtocol</span> &#123;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">optional</span> <span class="keyword">func</span> <span class="title function_">gestureRecognizer</span>(<span class="keyword">_</span> <span class="params">gestureRecognizer</span>: <span class="type">UIGestureRecognizer</span>, <span class="params">shouldRecognizeSimultaneouslyWith</span> <span class="params">otherGestureRecognizer</span>: <span class="type">UIGestureRecognizer</span>) -&gt; <span class="type">Bool</span></span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><p>UIGestureRecognizer 是否让其他手势失效</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">UIGestureRecognizer</span>: <span class="title class_">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">func</span> <span class="title function_">shouldRequireFailure</span>(<span class="params">of</span> <span class="params">otherGestureRecognizer</span>: <span class="type">UIGestureRecognizer</span>) -&gt; <span class="type">Bool</span></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">func</span> <span class="title function_">shouldBeRequiredToFail</span>(<span class="params">by</span> <span class="params">otherGestureRecognizer</span>: <span class="type">UIGestureRecognizer</span>) -&gt; <span class="type">Bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hit Testing</p>
</li>
<li><p>新属性 name，便于调试</p>
</li>
</ul>
<h4 id="手势系统的注意事项："><a href="#手势系统的注意事项：" class="headerlink" title="手势系统的注意事项："></a>手势系统的注意事项：</h4><ul>
<li>复查你的构建步骤（Revisit your setups ）</li>
<li>排除和失效的标准（Exclusion and failure requirements）</li>
<li>手势是否在正确的视图上？（ Are your gesture recognizers on the right views?）</li>
</ul>
<h3 id="2-系统手势"><a href="#2-系统手势" class="headerlink" title="2. 系统手势"></a>2. 系统手势</h3><p>应用手势和系统手势之争！如非沉浸式的游戏或画画的应用，别推迟系统手势。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyViewController</span>: <span class="title class_">UIViewController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// override to return which screen edges to defer system gestures</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">preferredScreenEdgesDeferringSystemGestures</span>() -&gt; <span class="type">UIRectEdge</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> deferControlCenter <span class="operator">?</span> .bottom : <span class="type">UIRectEdge</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// call whenever your method would return a different screen edge</span></span><br><span class="line">    <span class="keyword">var</span> deferControlCenter: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123; setNeedsUpdateOfScreenEdgesDeferringSystemGestures() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-拖拽"><a href="#3-拖拽" class="headerlink" title="3. 拖拽"></a>3. 拖拽</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dragInteraction <span class="operator">=</span> <span class="type">UIDragInteraction</span>(delegate: myDelegate) myView.addInteraction(dragInteraction)</span><br></pre></td></tr></table></figure>



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>手势部分关于同时兼容或禁止其他的应该都很熟悉，尤其是分页加 table view经常处理。iOS可以延迟系统边缘手势很不错的选择，很多app手势经常与系统同步调出。拖拽的话，主要在iPad上应用，就不深入学习了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/07/06/Introducing-Password-AutoFill-for-Apps-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/06/Introducing-Password-AutoFill-for-Apps-Notes/" class="post-title-link" itemprop="url">Introducing Password AutoFill for Apps - 笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-06 21:55:28" itemprop="dateCreated datePublished" datetime="2017-07-06T21:55:28+08:00">2017-07-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>WWDC 2017 Session 206 地址：<a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2017/206/">https://developer.apple.com/videos/play/wwdc2017/206/</a></p>
<p>应用支持自动填充密码，三步搞定：</p>
<ul>
<li>显示QuickType工具栏</li>
<li>提供证书：网址提供json格式证书</li>
<li>显示对应的证书：项目中添加证书</li>
<li>（可选）通过第三方服务授权：SafariViewController</li>
</ul>
<p>附 Demo: <a target="_blank" rel="noopener" href="https://github.com/gewill/Demo/tree/PasswordAutoFill">https://github.com/gewill/Demo/tree/PasswordAutoFill</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ge Will</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
