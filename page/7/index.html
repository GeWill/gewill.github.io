<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
<meta property="og:type" content="website">
<meta property="og:title" content="Will&#39;s Blog">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="Will&#39;s Blog">
<meta property="og:description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Ge Will">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Will's Blog</title>
  







<head>
    <!-- 霞鹜文楷字体 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css"/>

    <!-- datapulse统计 -->
    <script defer type="text/javascript" src="https://datapulse.app/datapulse.min.js" id="datapulse" data-endpoint="https://datapulse.app/api/v1/event" data-workspace="cljxqml5q0y0f8j37d4futnbl"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DR0FC9YJLH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-DR0FC9YJLH');
    </script>

    <!-- 看板娘 -->
    <script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
</head>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Will's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">194</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">11</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">1</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ge Will"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Ge Will</p>
  <div class="site-description" itemprop="description">The people who are crazy enough to think they can change the world, are the ones who DO.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">194</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/gewill" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gewill" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:531sunlight@gmail.com" title="E-Mail → mailto:531sunlight@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/gewei" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;gewei" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/BoJack_D" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;BoJack_D" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/18/Objective-C-id-as-Swift-Any-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/10/18/Objective-C-id-as-Swift-Any-Notes/" class="post-title-link" itemprop="url">Objective-C id as Swift Any-笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-10-18 11:21:30" itemprop="dateCreated datePublished" datetime="2016-10-18T11:21:30+08:00">2016-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Apple Swift 博客原文地址：<a target="_blank" rel="noopener" href="https://developer.apple.com/swift/blog/?id=39">https://developer.apple.com/swift/blog/?id=39</a> </p>
<p>主要变化：Swift 3 中 Any 映射 Objective-C 的 id </p>
<table>
<thead>
<tr>
<th>Objective-C</th>
<th>Swift 2</th>
<th>Swift 3</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>AnyObject</td>
<td>Any</td>
</tr>
<tr>
<td>NSArray *</td>
<td>[AnyObject]</td>
<td>[Any]</td>
</tr>
<tr>
<td>NSDictionary *</td>
<td>[NSObject: AnyObject]</td>
<td>[AnyHashable: Any]</td>
</tr>
<tr>
<td>NSSet *</td>
<td><code>Set&lt;NSObject&gt;</code></td>
<td><code>Set&lt;AnyHashable&gt;</code></td>
</tr>
</tbody></table>
<ul>
<li>方法和协议的中的AnyObject均改为Any</li>
<li>调用大部分 C 和 Objective-C 需要显示类型转换，指针为 <code>UnsafePointer&lt;AnyObject&gt;</code></li>
<li>Objective-C 协议仍是限制在 Class，而 structs 和 enums 无法符合。需要显示转换，如：String as NSString, Array as NSArray</li>
<li>Any 没有 AnyObject 中的一些魔法查询方法可用，如：(x as AnyObject).description</li>
<li>Swift 值类型隐式转换 id</li>
<li>Cocoa 也紧随 Swift 进化的脚步，而变得更强大</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/15/Learn-iOS-Design-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/08/15/Learn-iOS-Design-Notes/" class="post-title-link" itemprop="url">The Animation Tools Learn iOS Design - 笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-08-15 19:02:00" itemprop="dateCreated datePublished" datetime="2016-08-15T19:02:00+08:00">2016-08-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://designcode.io/iosdesign">Learn iOS Design</a> 是 Design Code 第一本，详细介绍了iOS 设计的方方面面，几乎每篇都是理论加工具。总体很全面，还有待进一步的实践中得到提高。</p>
<h2 id="Core-Philosophies"><a href="#Core-Philosophies" class="headerlink" title="Core Philosophies"></a>Core Philosophies</h2><p>讲解了设计的哲学，和最低的三个要求：consider the touch interface, make the text readable and optimize for the iPhone 5, 6 and 6 Plus.</p>
<p>iOS is driven by 3 core philosophies: deference, clarity and depth.</p>
<p>In Retina, typography should have a minimum size of 11pt. The optimal size for reading is around 16pt.</p>
<h2 id="Designing-for-iOS-9"><a href="#Designing-for-iOS-9" class="headerlink" title="Designing for iOS 9"></a>Designing for iOS 9</h2><p>详细讲解了 iOS 9 上常见控件的合理布局大小。</p>
<p>iOS uses vibrant colors to bring out the buttons. </p>
<p>iOS often uses neutral colors to serve as the background and menu areas.</p>
<p><img src="https://designcode.io/cloud/chapter1/Colors.jpg" alt="iOS-Colors"></p>
<h2 id="Learn-Colors"><a href="#Learn-Colors" class="headerlink" title="Learn Colors"></a>Learn Colors</h2><p>色彩运用和对比是 HSB 在数值上更有易于理解和对比。<br>下面介绍了：单色系、相似色、互补色、中间色、反色等色彩运用。将用的中间色的色板、颜色的含义、原质化设计(Material Design)颜色、阶梯色(UI Gradients)。</p>
<p>use colors only to draw attention to a button or element of importance.</p>
<p>I suggest starting with a vibrant, pastel color that is Primary or Secondary. </p>
<p>These are the colors used by Apple in their native apps. They’re vibrant and perfect for buttons, icons and actionable items.</p>
<p>I can easily map in my mind how much Hue, Saturation and Brightness. Those values make a lot more sense to me.</p>
<p>Meaning In Colors：I suggest reading this <a target="_blank" rel="noopener" href="http://www.rocket-design.fr/color-template/">guide</a> about colors.</p>
<p>This is a nice collection of gradients: <a target="_blank" rel="noopener" href="http://uigradients.com/">http://uigradients.com</a></p>
<h2 id="Learn-Typography"><a href="#Learn-Typography" class="headerlink" title="Learn Typography"></a>Learn Typography</h2><p>介绍了一些字体常用使用，和字体网站。</p>
<p>字体一些基础知识：位置线、有无衬线字体</p>
<p><img src="https://designcode.io/cloud/chapter1/Typography-Basics.jpg" alt="Typography-Basics"></p>
<p>Let’s look at these <a target="_blank" rel="noopener" href="http://practicaltypography.com/typography-in-ten-minutes.html">5 rules of good typography</a> and apply them to modern design for mobile and for Websites.</p>
<p>The font size should be at least <strong>11pt</strong> to be readable on the iPhone, iPad and Apple Watch. While that is the minimum value, the recommended size for the body text is actually<strong>15-18pt</strong>.</p>
<p>At 12-18pt, use Regular. At 18-24pt, use Light, at 24-32pt, use Thin and at 32pt or more, use Ultralight. Notice that for each scale, the text remains readable while looking clean and sophisticated.</p>
<p><img src="https://designcode.io/cloud/chapter1/Typography-LineHeight.jpg" alt="Typography-LineHeight"></p>
<p>“People say design isn’t art. It isn’t. Great design is art.”</p>
<p>字体资源网站：</p>
<p>* <a target="_blank" rel="noopener" href="https://www.google.com/fonts">Google Fonts</a><br>* <a target="_blank" rel="noopener" href="https://typekit.com/fonts">Typekit</a><br>* <a href="fonts.com">fonts.com</a></p>
<h2 id="Learn-Animations"><a href="#Learn-Animations" class="headerlink" title="Learn Animations"></a>Learn Animations</h2><p>介绍动画在交互中的作用，和一些基本原则，以及一些做动画原型的工具。</p>
<p>Good animations enhance, bad animations distract.</p>
<p>Good animations should provide feedback on taps and gestures, and give a sense of direct manipulation.</p>
<p>Modern apps tend to use Spring and Ease animations much more than Linear.</p>
<p><img src="https://designcode.io/cloud/chapter1/Animation-Good.jpg" alt="Animation-Good"></p>
<p><img src="https://designcode.io/cloud/chapter1/2015-10-14%2004_02_36.gif" alt="Animation Curve"></p>
<p>On <a target="_blank" rel="noopener" href="https://github.com/mengto/spring">Spring</a>, an animation framework that I created for iOS, I made available a bunch of preset animations that combine many transforms at once. They can be inexpensively integrated to your app, without even learning how to code. 和 <a target="_blank" rel="noopener" href="https://github.com/IBAnimatable/IBAnimatable">IBAnimatable</a> 类似的一个不用代码的动画库。</p>
<p>效果视频：<a target="_blank" rel="noopener" href="https://designcode.io/cloud/chapter1/Animation-Spring.mp4">https://designcode.io/cloud/chapter1/Animation-Spring.mp4</a></p>
<p>Animations Shouldn’t Last Longer Than 1 second.</p>
<blockquote>
<p>“Design is the fundamental soul of a human-made creation that ends up expressing itself in successive outer layers of the product or service.” </p>
<p>– Steve Jobs</p>
</blockquote>
<p>The Animation Tools:</p>
<ul>
<li>Principle</li>
<li>Flinto for Mac</li>
<li>Pixate</li>
<li>Origami</li>
<li>Framer</li>
<li>After Effects</li>
</ul>
<h2 id="UI-Icons"><a href="#UI-Icons" class="headerlink" title="UI Icons"></a>UI Icons</h2><p>好水的一章，介绍一些图标的网站。</p>
<p>图标要表意，避免于其他app混淆，除非故意为之。</p>
<h2 id="UI-Sounds"><a href="#UI-Sounds" class="headerlink" title="UI Sounds"></a>UI Sounds</h2><p>音效也是应用增强体验的一个方面，可应用在通知、正操作反馈和负操作反馈。</p>
<h2 id="Design-Inspiration"><a href="#Design-Inspiration" class="headerlink" title="Design Inspiration"></a>Design Inspiration</h2><p>介绍获取涉及灵感的方式：观察生活中的技艺，看书，和一些网站。</p>
<p>书：</p>
<ul>
<li>Becoming Steve Jobs</li>
<li>Steve Jobs by Walter Isaacson</li>
<li>Jony Ive: The Genius Behind Apple’s Greatest Products</li>
<li>Dieter Rams</li>
<li>Elon Musk</li>
<li>The Tipping Point,</li>
<li>Outliers, </li>
<li>Blink, </li>
<li>David and Goliath</li>
<li>What The Dog Saw</li>
</ul>
<p>网站：Twitter、Medium、<a target="_blank" rel="noopener" href="http://sidebar.io/">Sidebar</a></p>
<p>it’s about 10% reading, 30% writing and collecting, and 60% design and code.</p>
<p><img src="https://designcode.io/cloud/chapter1/Inspiration-Split.png"></p>
<h2 id="Design-Principles"><a href="#Design-Principles" class="headerlink" title="Design Principles"></a>Design Principles</h2><p>介绍了设计常见的几个原则和作者个人的一些建议：自学能力、尽可能少的设计、三原则法、一万小时法、做梦想的事、休息为强者准备的。</p>
<h2 id="Getting-Your-Product-Out-There"><a href="#Getting-Your-Product-Out-There" class="headerlink" title="Getting Your Product Out There"></a>Getting Your Product Out There</h2><p>介绍了产品运营的一些建议。</p>
<p>Benefits, Not Features</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/06/21/7-Closures-Extensions-Protocols-Delegation-and-ScrollView-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/21/7-Closures-Extensions-Protocols-Delegation-and-ScrollView-Notes/" class="post-title-link" itemprop="url">7. Closures, Extensions, Protocols, Delegation, and ScrollView - 笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-21 22:37:04" itemprop="dateCreated datePublished" datetime="2016-06-21T22:37:04+08:00">2016-06-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[weak self] 比[unowned self]更安全。</p>
<p> 拓展：分割代码快，更简洁，不要滥用</p>
<p> 协议：是一个更简洁表达API的方式。是一种类型： 协议用在属性&#x2F;方法的参数或返回值中。</p>
<p> 下面是协议的一个例子：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protocol</span> <span class="title class_">Moveable</span> &#123;</span><br><span class="line">    <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">moveTo</span>(<span class="params">p</span>: <span class="type">CGPoint</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span>: <span class="title class_">Moveable</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">moveTo</span>(<span class="params">p</span>: <span class="type">CGPoint</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Car move to <span class="subst">\(p)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">changeOil</span>() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;changeOil&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Shape</span>: <span class="title class_">Moveable</span> &#123;</span><br><span class="line">    <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">moveTo</span>(<span class="params">p</span>: <span class="type">CGPoint</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Shape move to <span class="subst">\(p)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">draw</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;draw&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> prius: <span class="type">Car</span> <span class="operator">=</span> <span class="type">Car</span>(name: <span class="string">&quot;A&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> square: <span class="type">Shape</span> <span class="operator">=</span> <span class="type">Shape</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> thingToMove: <span class="type">Moveable</span> <span class="operator">=</span> prius</span><br><span class="line">thingToMove.moveTo(<span class="type">CGPoint</span>(x: <span class="number">100</span>, y: <span class="number">100</span>))</span><br><span class="line"><span class="keyword">var</span> find: <span class="type">Car</span> <span class="operator">=</span> prius</span><br><span class="line">find.name</span><br><span class="line"></span><br><span class="line"><span class="comment">// 协议可以作为一个类型，来存储实现该协议的变量，但是不能直接调用后者的非协议的方法和属性</span></span><br><span class="line"><span class="comment">//thingToMove.changeOil()</span></span><br><span class="line">thingToMove <span class="operator">=</span> square</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> thingsToMove: [<span class="type">Moveable</span>] <span class="operator">=</span> [prius, square]</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">slide</span>(<span class="params">var</span> <span class="params">slider</span>: <span class="type">Moveable</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> positionToSlideTo <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">88</span>, y: <span class="number">88</span>)</span><br><span class="line">    slider.moveTo(positionToSlideTo)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slide(prius)</span><br><span class="line">slide(square)</span><br><span class="line"></span><br><span class="line"><span class="keyword">protocol</span> <span class="title class_">Slippery</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> speed: <span class="type">Double</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Car</span>: <span class="title class_">Slippery</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> speed: <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">slipAndSlide</span>(<span class="params">x</span>: <span class="keyword">protocol</span><span class="operator">&lt;</span><span class="type">Slippery</span>, <span class="type">Moveable</span><span class="operator">&gt;</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;slipAndSlide&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">slipAndSlide(prius)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/05/16/Transforming-Arrays/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/05/16/Transforming-Arrays/" class="post-title-link" itemprop="url">转换数组</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-05-16 10:33:38" itemprop="dateCreated datePublished" datetime="2016-05-16T10:33:38+08:00">2016-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近项目中，非持久化部分使用了数组来暂存数据，涉及到去重。一直以来都是 for in 循序遍历来处理数组，比较了函数式编程，还是后者的模块化组装性比较有优势。</p>
<p>《Advanced Swift》中 Transforming Arrays 一节讲解了一些数组的基本映射转换方法。其中主要是重新实现了部分方法，以及推荐我们自己写一些拓展标准库的方法。</p>
<p>以下是标准库中13个独立的方法，可以随意组合使用：</p>
<ul>
<li>map and flatMap — how to transform an element  映射：如何转换每一个元素</li>
<li>filter — should an element be included? 过滤：是否应该包含该元素</li>
<li>reduce — how to fold an element into an aggregate value 归纳：如何折叠元素到一个总值</li>
<li>sort and lexicographicCompare — in what order should two elements come? 排序和字典顺序比较：两个元素如何排序</li>
<li>indexOf and contains — does this element match?  索引&#x2F;下标 和 包含：是否与该元素匹配</li>
<li>minElement and maxElement — which is the min&#x2F;max of two elements? 最小元素和最大元素：两个元素中最小&#x2F;最大的那个</li>
<li>elementsEqual and startsWith — are two elements equivalent? 元素等于和开始于：两个元素是否是对等</li>
<li>split — is this element a separator? 分割：该元素是否是分隔符</li>
</ul>
<p>编程毕竟是操作性的语言，以上都有表意很明确的方法，只要在实际调用几次也就理解了。下面是我写的 Demo ：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// : Playground - noun: a place where people can play</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fibs <span class="operator">=</span> [<span class="number">2</span>, <span class="number">3</span>, <span class="number">45</span>, <span class="number">53</span>, <span class="number">32</span>, <span class="number">12</span>, <span class="number">32</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">fibs.map &#123;</span><br><span class="line">    <span class="type">Double</span>(<span class="variable">$0</span> <span class="operator">*</span> <span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> suits <span class="operator">=</span> [<span class="string">&quot;♠&quot;</span>, <span class="string">&quot;♥&quot;</span>, <span class="string">&quot;♣&quot;</span>, <span class="string">&quot;♦&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ranks <span class="operator">=</span> [<span class="string">&quot;J&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;A&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> allCombinations <span class="operator">=</span> suits.flatMap &#123; suit <span class="keyword">in</span></span><br><span class="line">    ranks.map &#123; rank <span class="keyword">in</span></span><br><span class="line">        (suit, rank)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">suits.flatMap &#123; (suit) -&gt; [<span class="type">String</span>]<span class="operator">?</span> <span class="keyword">in</span></span><br><span class="line">    [suit, suit]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">suits.flatMap &#123; (suit) -&gt; [<span class="type">String</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> suit <span class="operator">!=</span> <span class="string">&quot;♥&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [suit]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.flatMap &#123; (num) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(num)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.sort &#123;</span><br><span class="line">    <span class="variable">$0</span> <span class="operator">&gt;</span> <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.lexicographicalCompare([<span class="number">3</span>])</span><br><span class="line">fibs.lexicographicalCompare([<span class="number">1</span>])</span><br><span class="line">fibs.lexicographicalCompare([<span class="number">3</span>]) &#123; (num0, num1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num0 <span class="operator">&gt;</span> num1</span><br><span class="line">&#125;</span><br><span class="line">fibs.lexicographicalCompare([<span class="number">1</span>]) &#123; (num0, num1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num0 <span class="operator">&gt;</span> num1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.reduce(<span class="number">0</span>) &#123; (total, num) -&gt; <span class="type">Int</span> <span class="keyword">in</span></span><br><span class="line">    total <span class="operator">+</span> num</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.filter &#123; (num) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num <span class="operator">%</span> <span class="number">3</span> <span class="operator">==</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.indexOf(<span class="number">4</span>)</span><br><span class="line">fibs.indexOf(<span class="number">1</span>)</span><br><span class="line">fibs.contains(<span class="number">4</span>)</span><br><span class="line">fibs.contains(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">fibs.minElement()</span><br><span class="line">fibs.minElement &#123; (num0, num1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num0 <span class="operator">&lt;</span> num1</span><br><span class="line">&#125;</span><br><span class="line">fibs.minElement &#123; (num0, num1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num0 <span class="operator">&gt;</span> num1</span><br><span class="line">&#125;</span><br><span class="line">fibs.maxElement()</span><br><span class="line">fibs.maxElement &#123; (num0, num1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num0: <span class="subst">\(num0)</span>, num1: <span class="subst">\(num1)</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> num0 <span class="operator">&lt;</span> num1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.maxElement &#123; (num0, num1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num0 <span class="operator">&gt;</span> num1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> strs <span class="operator">=</span> [<span class="string">&quot;Lee&quot;</span>, <span class="string">&quot;Bee&quot;</span>, <span class="string">&quot;Will&quot;</span>, <span class="string">&quot;10&quot;</span>, <span class="string">&quot;&quot;</span>]</span><br><span class="line">strs.maxElement &#123; (str0, str1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    str0 <span class="operator">&lt;</span> str1</span><br><span class="line">&#125;</span><br><span class="line">strs.maxElement &#123; (str0, str1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    str0 <span class="operator">&gt;</span> str1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">strs.elementsEqual([<span class="string">&quot;Lee&quot;</span>, <span class="string">&quot;Bee&quot;</span>, <span class="string">&quot;Will&quot;</span>, <span class="string">&quot;10&quot;</span>])</span><br><span class="line">strs.elementsEqual([<span class="string">&quot;Lee&quot;</span>, <span class="string">&quot;Bee&quot;</span>, <span class="string">&quot;Will&quot;</span>, <span class="string">&quot;10&quot;</span>, <span class="string">&quot;&quot;</span>])</span><br><span class="line"></span><br><span class="line">strs.startsWith([<span class="string">&quot;Lee&quot;</span>])</span><br><span class="line">strs.startsWith([<span class="string">&quot;10&quot;</span>])</span><br><span class="line">strs.startsWith([<span class="string">&quot;Lee&quot;</span>]) &#123; (str0, str1) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    str0 <span class="operator">==</span> str1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">strs.split(<span class="string">&quot;10&quot;</span>)</span><br><span class="line">strs.split(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">fibs.split(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">fibs.split(<span class="number">1</span>, maxSplit: <span class="number">2</span>, allowEmptySlices: <span class="literal">true</span>)</span><br><span class="line">fibs.split(<span class="number">1</span>, maxSplit: <span class="number">2</span>, allowEmptySlices: <span class="literal">false</span>)</span><br><span class="line">fibs.split(<span class="number">1</span>, maxSplit: <span class="number">3</span>, allowEmptySlices: <span class="literal">true</span>)</span><br><span class="line">fibs.split(<span class="number">1</span>, maxSplit: <span class="number">6</span>, allowEmptySlices: <span class="literal">false</span>)</span><br><span class="line">fibs.split(<span class="number">3333</span>, maxSplit: <span class="number">2</span>, allowEmptySlices: <span class="literal">true</span>)</span><br><span class="line">fibs.split(<span class="number">44444</span>, maxSplit: <span class="number">2</span>, allowEmptySlices: <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">fibs.split(<span class="number">32</span>, maxSplit: <span class="number">0</span>, allowEmptySlices: <span class="literal">true</span>)</span><br><span class="line">fibs.split(<span class="number">32</span>, maxSplit: <span class="number">1</span>, allowEmptySlices: <span class="literal">false</span>)</span><br><span class="line">fibs.split(<span class="number">32</span>, maxSplit: <span class="number">2</span>, allowEmptySlices: <span class="literal">true</span>)</span><br><span class="line">fibs.split(<span class="number">32</span>, maxSplit: <span class="number">3</span>, allowEmptySlices: <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">fibs.split &#123; (num) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num <span class="operator">%</span> <span class="number">2</span> <span class="operator">==</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.split(<span class="number">1</span>, allowEmptySlices: <span class="literal">true</span>) &#123; (num) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num <span class="operator">%</span> <span class="number">2</span> <span class="operator">==</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.split(<span class="number">66</span>, allowEmptySlices: <span class="literal">true</span>) &#123; (num) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    num <span class="operator">%</span> <span class="number">2</span> <span class="operator">==</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fibs.forEach &#123; (num) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(num <span class="operator">-</span> <span class="number">44</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Demo 下载地址：<a target="_blank" rel="noopener" href="https://github.com/gewill/test-projects/tree/master/collections%20transform.playground">https://github.com/gewill/test-projects/tree/master/collections%20transform.playground</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/05/03/AVFoundation-Programming-Guide-Export/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/05/03/AVFoundation-Programming-Guide-Export/" class="post-title-link" itemprop="url">AVFoundation Programming Guide - Export</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-05-03 16:48:00" itemprop="dateCreated datePublished" datetime="2016-05-03T16:48:00+08:00">2016-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Export"><a href="#Export" class="headerlink" title="Export"></a>Export</h1><p>To read and write audiovisual assets, you must use the export APIs provided by the AVFoundation framework. The AVAssetExportSession class provides an interface for simple exporting needs, such as modifying the file format or trimming the length of an asset (see Trimming and Transcoding a Movie). For more in-depth exporting needs, use the AVAssetReader and AVAssetWriter classes.</p>
<p>Use an AVAssetReader when you want to perform an operation on the contents of an asset. For example, you might read the audio track of an asset to produce a visual representation of the waveform. To produce an asset from media such as sample buffers or still images, use an AVAssetWriter object.</p>
<blockquote>
<p>Note: The asset reader and writer classes are not intended to be used for real-time processing. In fact, an asset reader cannot even be used for reading from a real-time source like an HTTP live stream. However, if you are using an asset writer with a real-time data source, such as an AVCaptureOutput object, set the expectsMediaDataInRealTime property of your asset writer’s inputs to YES. Setting this property to YES for a non-real-time data source will result in your files not being interleaved properly.</p>
</blockquote>
<h2 id="1-Reading-an-Asset"><a href="#1-Reading-an-Asset" class="headerlink" title="1. Reading an Asset"></a>1. Reading an Asset</h2><p>Each AVAssetReader object can be associated only with a single asset at a time, but this asset may contain multiple tracks. For this reason, you must assign concrete subclasses of the AVAssetReaderOutput class to your asset reader before you begin reading in order to configure how the media data is read. There are three concrete subclasses of the AVAssetReaderOutput base class that you can use for your asset reading needs: AVAssetReaderTrackOutput, AVAssetReaderAudioMixOutput, and AVAssetReaderVideoCompositionOutput.</p>
<h3 id="1-1-Creating-the-Asset-Reader"><a href="#1-1-Creating-the-Asset-Reader" class="headerlink" title="1.1. Creating the Asset Reader"></a>1.1. Creating the Asset Reader</h3><p>All you need to initialize an AVAssetReader object is the asset that you want to read.</p>
<p>直接初始化即可，是一个可失败的构造器，注意检查是否成功。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *outError;</span><br><span class="line"><span class="built_in">AVAsset</span> *someAsset = &lt;#<span class="built_in">AVAsset</span> that you want to read#&gt;;</span><br><span class="line"><span class="built_in">AVAssetReader</span> *assetReader = [<span class="built_in">AVAssetReader</span> assetReaderWithAsset:someAsset error:&amp;outError];</span><br><span class="line"><span class="type">BOOL</span> success = (assetReader != <span class="literal">nil</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: Always check that the asset reader returned to you is non-nil to ensure that the asset reader was initialized successfully. Otherwise, the error parameter (outError in the previous example) will contain the relevant error information.</p>
</blockquote>
<h3 id="1-2-Setting-Up-the-Asset-Reader-Outputs"><a href="#1-2-Setting-Up-the-Asset-Reader-Outputs" class="headerlink" title="1.2. Setting Up the Asset Reader Outputs"></a>1.2. Setting Up the Asset Reader Outputs</h3><p>After you have created your asset reader, set up at least one output to receive the media data being read. When setting up your outputs, be sure to set the alwaysCopiesSampleData property to NO. In this way, you reap the benefits of performance improvements. In all of the examples within this chapter, this property could and should be set to NO.</p>
<p>alwaysCopiesSampleData 设置 NO，来获取性能的提升。</p>
<p>If you want only to read media data from one or more tracks and potentially convert that data to a different format, use the AVAssetReaderTrackOutput class, using a single track output object for each AVAssetTrack object that you want to read from your asset. To decompress an audio track to Linear PCM with an asset reader, you set up your track output as follows:</p>
<p>设置 track output</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVAsset</span> *localAsset = assetReader.asset;</span><br><span class="line"><span class="comment">// Get the audio track to read.</span></span><br><span class="line"><span class="built_in">AVAssetTrack</span> *audioTrack = [[localAsset tracksWithMediaType:<span class="built_in">AVMediaTypeAudio</span>] objectAtIndex:<span class="number">0</span>];</span><br><span class="line"><span class="comment">// Decompression settings for Linear PCM</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *decompressionAudioSettings = @&#123; <span class="built_in">AVFormatIDKey</span> : [<span class="built_in">NSNumber</span> numberWithUnsignedInt:kAudioFormatLinearPCM] &#125;;</span><br><span class="line"><span class="comment">// Create the output with the audio track and decompression settings.</span></span><br><span class="line"><span class="built_in">AVAssetReaderOutput</span> *trackOutput = [<span class="built_in">AVAssetReaderTrackOutput</span> assetReaderTrackOutputWithTrack:audioTrack outputSettings:decompressionAudioSettings];</span><br><span class="line"><span class="comment">// Add the output to the reader if possible.</span></span><br><span class="line"><span class="keyword">if</span> ([assetReader canAddOutput:trackOutput])</span><br><span class="line">    [assetReader addOutput:trackOutput];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: To read the media data from a specific asset track in the format in which it was stored, pass nil to the outputSettings parameter.</p>
</blockquote>
<p>You use the AVAssetReaderAudioMixOutput and AVAssetReaderVideoCompositionOutput classes to read media data that has been mixed or composited together using an AVAudioMix object or AVVideoComposition object, respectively. Typically, these outputs are used when your asset reader is reading from an AVComposition object.</p>
<p>With a single audio mix output, you can read multiple audio tracks from your asset that have been mixed together using an AVAudioMix object. To specify how the audio tracks are mixed, assign the mix to the AVAssetReaderAudioMixOutput object after initialization. The following code displays how to create an audio mix output with all of the audio tracks from your asset, decompress the audio tracks to Linear PCM, and assign an audio mix object to the output. For details on how to configure an audio mix, see Editing.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVAudioMix</span> *audioMix = &lt;#An <span class="built_in">AVAudioMix</span> that specifies how the audio tracks from the <span class="built_in">AVAsset</span> are mixed#&gt;;</span><br><span class="line"><span class="comment">// Assumes that assetReader was initialized with an AVComposition object.</span></span><br><span class="line"><span class="built_in">AVComposition</span> *composition = (<span class="built_in">AVComposition</span> *)assetReader.asset;</span><br><span class="line"><span class="comment">// Get the audio tracks to read.</span></span><br><span class="line"><span class="built_in">NSArray</span> *audioTracks = [composition tracksWithMediaType:<span class="built_in">AVMediaTypeAudio</span>];</span><br><span class="line"><span class="comment">// Get the decompression settings for Linear PCM.</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *decompressionAudioSettings = @&#123; <span class="built_in">AVFormatIDKey</span> : [<span class="built_in">NSNumber</span> numberWithUnsignedInt:kAudioFormatLinearPCM] &#125;;</span><br><span class="line"><span class="comment">// Create the audio mix output with the audio tracks and decompression setttings.</span></span><br><span class="line"><span class="built_in">AVAssetReaderOutput</span> *audioMixOutput = [<span class="built_in">AVAssetReaderAudioMixOutput</span> assetReaderAudioMixOutputWithAudioTracks:audioTracks audioSettings:decompressionAudioSettings];</span><br><span class="line"><span class="comment">// Associate the audio mix used to mix the audio tracks being read with the output.</span></span><br><span class="line">audioMixOutput.audioMix = audioMix;</span><br><span class="line"><span class="comment">// Add the output to the reader if possible.</span></span><br><span class="line"><span class="keyword">if</span> ([assetReader canAddOutput:audioMixOutput])</span><br><span class="line">    [assetReader addOutput:audioMixOutput];</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: Passing nil for the audioSettings parameter tells the asset reader to return samples in a convenient uncompressed format. The same is true for the AVAssetReaderVideoCompositionOutput class.</p>
</blockquote>
<p>The video composition output behaves in much the same way: You can read multiple video tracks from your asset that have been composited together using an AVVideoComposition object. To read the media data from multiple composited video tracks and decompress it to ARGB, set up your output as follows:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVVideoComposition</span> *videoComposition = &lt;#An <span class="built_in">AVVideoComposition</span> that specifies how the video tracks from the <span class="built_in">AVAsset</span> are composited#&gt;;</span><br><span class="line"><span class="comment">// Assumes assetReader was initialized with an AVComposition.</span></span><br><span class="line"><span class="built_in">AVComposition</span> *composition = (<span class="built_in">AVComposition</span> *)assetReader.asset;</span><br><span class="line"><span class="comment">// Get the video tracks to read.</span></span><br><span class="line"><span class="built_in">NSArray</span> *videoTracks = [composition tracksWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</span><br><span class="line"><span class="comment">// Decompression settings for ARGB.</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *decompressionVideoSettings = @&#123; (<span class="type">id</span>)kCVPixelBufferPixelFormatTypeKey : [<span class="built_in">NSNumber</span> numberWithUnsignedInt:kCVPixelFormatType_32ARGB], (<span class="type">id</span>)kCVPixelBufferIOSurfacePropertiesKey : [<span class="built_in">NSDictionary</span> dictionary] &#125;;</span><br><span class="line"><span class="comment">// Create the video composition output with the video tracks and decompression setttings.</span></span><br><span class="line"><span class="built_in">AVAssetReaderOutput</span> *videoCompositionOutput = [<span class="built_in">AVAssetReaderVideoCompositionOutput</span> assetReaderVideoCompositionOutputWithVideoTracks:videoTracks videoSettings:decompressionVideoSettings];</span><br><span class="line"><span class="comment">// Associate the video composition used to composite the video tracks being read with the output.</span></span><br><span class="line">videoCompositionOutput.videoComposition = videoComposition;</span><br><span class="line"><span class="comment">// Add the output to the reader if possible.</span></span><br><span class="line"><span class="keyword">if</span> ([assetReader canAddOutput:videoCompositionOutput])</span><br><span class="line">    [assetReader addOutput:videoCompositionOutput];</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h3 id="1-3-Reading-the-Asset’s-Media-Data"><a href="#1-3-Reading-the-Asset’s-Media-Data" class="headerlink" title="1.3. Reading the Asset’s Media Data"></a>1.3. Reading the Asset’s Media Data</h3><p>To start reading after setting up all of the outputs you need, call the startReading method on your asset reader. Next, retrieve the media data individually from each output using the copyNextSampleBuffer method. To start up an asset reader with a single output and read all of its media samples, do the following:</p>
<p>使用 copyNextSampleBuffer 方法获取 CMSampleBufferRef：一个抽象类，封装了零或多个媒体类型的小样。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start the asset reader up.</span></span><br><span class="line">[<span class="keyword">self</span>.assetReader startReading];</span><br><span class="line"><span class="type">BOOL</span> done = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">while</span> (!done)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Copy the next sample buffer from the reader output.</span></span><br><span class="line">  <span class="built_in">CMSampleBufferRef</span> sampleBuffer = [<span class="keyword">self</span>.assetReaderOutput copyNextSampleBuffer];</span><br><span class="line">  <span class="keyword">if</span> (sampleBuffer)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Do something with sampleBuffer here.</span></span><br><span class="line">    <span class="built_in">CFRelease</span>(sampleBuffer);</span><br><span class="line">    sampleBuffer = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Find out why the asset reader output couldn&#x27;t copy another sample buffer.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.assetReader.status == <span class="built_in">AVAssetReaderStatusFailed</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">NSError</span> *failureError = <span class="keyword">self</span>.assetReader.error;</span><br><span class="line">      <span class="comment">// Handle the error here.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// The asset reader output has read all of its samples.</span></span><br><span class="line">      done = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Writing-an-Asset"><a href="#2-Writing-an-Asset" class="headerlink" title="2. Writing an Asset"></a>2. Writing an Asset</h2><p>The AVAssetWriter class to write media data from multiple sources to a single file of a specified file format. You don’t need to associate your asset writer object with a specific asset, but you must use a separate asset writer for each output file that you want to create. Because an asset writer can write media data from multiple sources, you must create an AVAssetWriterInput object for each individual track that you want to write to the output file. Each AVAssetWriterInput object expects to receive data in the form of CMSampleBufferRef objects, but if you want to append CVPixelBufferRef objects to your asset writer input, use the AVAssetWriterInputPixelBufferAdaptor class.</p>
<blockquote>
<p>CVPixelBufferRef: A reference to a Core Video pixel buffer object. The pixel buffer stores an image in main memory.</p>
</blockquote>
<h3 id="2-1-Creating-the-Asset-Writer"><a href="#2-1-Creating-the-Asset-Writer" class="headerlink" title="2.1. Creating the Asset Writer"></a>2.1. Creating the Asset Writer</h3><p>To create an asset writer, specify the URL for the output file and the desired file type. The following code displays how to initialize an asset writer to create a QuickTime movie:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *outError;</span><br><span class="line"><span class="built_in">NSURL</span> *outputURL = &lt;#<span class="built_in">NSURL</span> object representing the URL where you want to save the video#&gt;;</span><br><span class="line"><span class="built_in">AVAssetWriter</span> *assetWriter = [<span class="built_in">AVAssetWriter</span> assetWriterWithURL:outputURL</span><br><span class="line">                                                      fileType:<span class="built_in">AVFileTypeQuickTimeMovie</span></span><br><span class="line">                                                         error:&amp;outError];</span><br><span class="line"><span class="type">BOOL</span> success = (assetWriter != <span class="literal">nil</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Setting-Up-the-Asset-Writer-Inputs"><a href="#2-2-Setting-Up-the-Asset-Writer-Inputs" class="headerlink" title="2.2. Setting Up the Asset Writer Inputs"></a>2.2. Setting Up the Asset Writer Inputs</h3><p>For your asset writer to be able to write media data, you must set up at least one asset writer input. For example, if your source of media data is already vending media samples as CMSampleBufferRef objects, just use the AVAssetWriterInput class. To set up an asset writer input that compresses audio media data to 128 kbps AAC and connect it to your asset writer, do the following:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Configure the channel layout as stereo.</span></span><br><span class="line">AudioChannelLayout stereoChannelLayout = &#123;</span><br><span class="line">    .mChannelLayoutTag = kAudioChannelLayoutTag_Stereo,</span><br><span class="line">    .mChannelBitmap = <span class="number">0</span>,</span><br><span class="line">    .mNumberChannelDescriptions = <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Convert the channel layout object to an NSData object.</span></span><br><span class="line"><span class="built_in">NSData</span> *channelLayoutAsData = [<span class="built_in">NSData</span> dataWithBytes:&amp;stereoChannelLayout length:offsetof(AudioChannelLayout, mChannelDescriptions)];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Get the compression settings for 128 kbps AAC.</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *compressionAudioSettings = @&#123;</span><br><span class="line">    <span class="built_in">AVFormatIDKey</span>         : [<span class="built_in">NSNumber</span> numberWithUnsignedInt:kAudioFormatMPEG4AAC],</span><br><span class="line">    <span class="built_in">AVEncoderBitRateKey</span>   : [<span class="built_in">NSNumber</span> numberWithInteger:<span class="number">128000</span>],</span><br><span class="line">    <span class="built_in">AVSampleRateKey</span>       : [<span class="built_in">NSNumber</span> numberWithInteger:<span class="number">44100</span>],</span><br><span class="line">    <span class="built_in">AVChannelLayoutKey</span>    : channelLayoutAsData,</span><br><span class="line">    <span class="built_in">AVNumberOfChannelsKey</span> : [<span class="built_in">NSNumber</span> numberWithUnsignedInteger:<span class="number">2</span>]</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create the asset writer input with the compression settings and specify the media type as audio.</span></span><br><span class="line"><span class="built_in">AVAssetWriterInput</span> *assetWriterInput = [<span class="built_in">AVAssetWriterInput</span> assetWriterInputWithMediaType:<span class="built_in">AVMediaTypeAudio</span> outputSettings:compressionAudioSettings];</span><br><span class="line"><span class="comment">// Add the input to the writer if possible.</span></span><br><span class="line"><span class="keyword">if</span> ([assetWriter canAddInput:assetWriterInput])</span><br><span class="line">    [assetWriter addInput:assetWriterInput];</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: If you want the media data to be written in the format in which it was stored, pass nil in the outputSettings parameter. Pass nil only if the asset writer was initialized with a fileType of AVFileTypeQuickTimeMovie.</p>
</blockquote>
<p>Your asset writer input can optionally include some metadata or specify a different transform for a particular track using the metadata and transform properties respectively. For an asset writer input whose data source is a video track, you can maintain the video’s original transform in the output file by doing the following:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVAsset</span> *videoAsset = &lt;#<span class="built_in">AVAsset</span> with at least one video track#&gt;;</span><br><span class="line"><span class="built_in">AVAssetTrack</span> *videoAssetTrack = [[videoAsset tracksWithMediaType:<span class="built_in">AVMediaTypeVideo</span>] objectAtIndex:<span class="number">0</span>];</span><br><span class="line">assetWriterInput.transform = videoAssetTrack.preferredTransform;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: Set the metadata and transform properties before you begin writing with your asset writer for them to take effect.</p>
</blockquote>
<p>When writing media data to the output file, sometimes you may want to allocate pixel buffers. To do so, use the AVAssetWriterInputPixelBufferAdaptor class. For greatest efficiency, instead of adding pixel buffers that were allocated using a separate pool, use the pixel buffer pool provided by the pixel buffer adaptor. The following code creates a pixel buffer object working in the RGB domain that will use CGImage objects to create its pixel buffers.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSDictionary</span> *pixelBufferAttributes = @&#123;</span><br><span class="line">     kCVPixelBufferCGImageCompatibilityKey : [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>],</span><br><span class="line">     kCVPixelBufferCGBitmapContextCompatibilityKey : [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>],</span><br><span class="line">     kCVPixelBufferPixelFormatTypeKey : [<span class="built_in">NSNumber</span> numberWithInt:kCVPixelFormatType_32ARGB]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">AVAssetWriterInputPixelBufferAdaptor</span> *inputPixelBufferAdaptor = [<span class="built_in">AVAssetWriterInputPixelBufferAdaptor</span> assetWriterInputPixelBufferAdaptorWithAssetWriterInput:<span class="keyword">self</span>.assetWriterInput sourcePixelBufferAttributes:pixelBufferAttributes];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: All AVAssetWriterInputPixelBufferAdaptor objects must be connected to a single asset writer input. That asset writer input must accept media data of type AVMediaTypeVideo.</p>
</blockquote>
<h3 id="2-3-Writing-Media-Data"><a href="#2-3-Writing-Media-Data" class="headerlink" title="2.3. Writing Media Data"></a>2.3. Writing Media Data</h3><p>When you have configured all of the inputs needed for your asset writer, you are ready to begin writing media data. As you did with the asset reader, initiate the writing process with a call to the startWriting method. You then need to start a sample-writing session with a call to the startSessionAtSourceTime: method. All writing done by an asset writer has to occur within one of these sessions and the time range of each session defines the time range of media data included from within the source. For example, if your source is an asset reader that is supplying media data read from an AVAsset object and you don’t want to include media data from the first half of the asset, you would do the following:</p>
<p>配置完就是开始了：startWriting，和上面的 reader 用法基本一致。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CMTime</span> halfAssetDuration = <span class="built_in">CMTimeMultiplyByFloat64</span>(<span class="keyword">self</span>.asset.duration, <span class="number">0.5</span>);</span><br><span class="line">[<span class="keyword">self</span>.assetWriter startSessionAtSourceTime:halfAssetDuration];</span><br><span class="line"><span class="comment">//Implementation continues.</span></span><br></pre></td></tr></table></figure>

<p>Normally, to end a writing session you must call the endSessionAtSourceTime: method. However, if your writing session goes right up to the end of your file, you can end the writing session simply by calling the finishWriting method. To start up an asset writer with a single input and write all of its media data, do the following:</p>
<p>两种方法都可以结束 writing session：endSessionAtSourceTime 和 finishWriting</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Prepare the asset writer for writing.</span></span><br><span class="line">[<span class="keyword">self</span>.assetWriter startWriting];</span><br><span class="line"><span class="comment">// Start a sample-writing session.</span></span><br><span class="line">[<span class="keyword">self</span>.assetWriter startSessionAtSourceTime:kCMTimeZero];</span><br><span class="line"><span class="comment">// Specify the block to execute when the asset writer is ready for media data and the queue to call it on.</span></span><br><span class="line">[<span class="keyword">self</span>.assetWriterInput requestMediaDataWhenReadyOnQueue:myInputSerialQueue usingBlock:^&#123;</span><br><span class="line">     <span class="keyword">while</span> ([<span class="keyword">self</span>.assetWriterInput isReadyForMoreMediaData])</span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// Get the next sample buffer.</span></span><br><span class="line">          <span class="built_in">CMSampleBufferRef</span> nextSampleBuffer = [<span class="keyword">self</span> copyNextSampleBufferToWrite];</span><br><span class="line">          <span class="keyword">if</span> (nextSampleBuffer)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If it exists, append the next sample buffer to the output file.</span></span><br><span class="line">               [<span class="keyword">self</span>.assetWriterInput appendSampleBuffer:nextSampleBuffer];</span><br><span class="line">               <span class="built_in">CFRelease</span>(nextSampleBuffer);</span><br><span class="line">               nextSampleBuffer = <span class="literal">nil</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// Assume that lack of a next sample buffer means the sample buffer source is out of samples and mark the input as finished.</span></span><br><span class="line">               [<span class="keyword">self</span>.assetWriterInput markAsFinished];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>The copyNextSampleBufferToWrite method in the code above is simply a stub. The location of this stub is where you would need to insert some logic to return CMSampleBufferRef objects representing the media data that you want to write. One possible source of sample buffers is an asset reader output.</p>
<p>这里的copyNextSampleBufferToWrite只是一个存根，你有必要在这里进行了一下逻辑上的处理。</p>
<h2 id="3-Reencoding-Assets"><a href="#3-Reencoding-Assets" class="headerlink" title="3. Reencoding Assets"></a>3. Reencoding Assets</h2><p>重新编码</p>
<p>You can use an asset reader and asset writer object in tandem to convert an asset from one representation to another. Using these objects, you have more control over the conversion than you do with an AVAssetExportSession object. For example, you can choose which of the tracks you want to be represented in the output file, specify your own output format, or modify the asset during the conversion process. The first step in this process is just to set up your asset reader outputs and asset writer inputs as desired. After your asset reader and writer are fully configured, you start up both of them with calls to the startReading and startWriting methods, respectively. The following code snippet displays how to use a single asset writer input to write media data supplied by a single asset reader output:</p>
<p>同时使用 asset reader 和 writer 可以用来转换编辑格式。而且比AVAssetExportSession有更多选项可控：指定自己的输出格式、处理中更改 asset。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *serializationQueueDescription = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ serialization queue&quot;</span>, <span class="keyword">self</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create a serialization queue for reading and writing.</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serializationQueue = dispatch_queue_create([serializationQueueDescription UTF8String], <span class="literal">NULL</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Specify the block to execute when the asset writer is ready for media data and the queue to call it on.</span></span><br><span class="line">[<span class="keyword">self</span>.assetWriterInput requestMediaDataWhenReadyOnQueue:serializationQueue usingBlock:^&#123;</span><br><span class="line">     <span class="keyword">while</span> ([<span class="keyword">self</span>.assetWriterInput isReadyForMoreMediaData])</span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// Get the asset reader output&#x27;s next sample buffer.</span></span><br><span class="line">          <span class="built_in">CMSampleBufferRef</span> sampleBuffer = [<span class="keyword">self</span>.assetReaderOutput copyNextSampleBuffer];</span><br><span class="line">          <span class="keyword">if</span> (sampleBuffer != <span class="literal">NULL</span>)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If it exists, append this sample buffer to the output file.</span></span><br><span class="line">               <span class="type">BOOL</span> success = [<span class="keyword">self</span>.assetWriterInput appendSampleBuffer:sampleBuffer];</span><br><span class="line">               <span class="built_in">CFRelease</span>(sampleBuffer);</span><br><span class="line">               sampleBuffer = <span class="literal">NULL</span>;</span><br><span class="line">               <span class="comment">// Check for errors that may have occurred when appending the new sample buffer.</span></span><br><span class="line">               <span class="keyword">if</span> (!success &amp;&amp; <span class="keyword">self</span>.assetWriter.status == <span class="built_in">AVAssetWriterStatusFailed</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="built_in">NSError</span> *failureError = <span class="keyword">self</span>.assetWriter.error;</span><br><span class="line">                    <span class="comment">//Handle the error.</span></span><br><span class="line">               &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If the next sample buffer doesn&#x27;t exist, find out why the asset reader output couldn&#x27;t vend another one.</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">self</span>.assetReader.status == <span class="built_in">AVAssetReaderStatusFailed</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="built_in">NSError</span> *failureError = <span class="keyword">self</span>.assetReader.error;</span><br><span class="line">                    <span class="comment">//Handle the error here.</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="comment">// The asset reader output must have vended all of its samples. Mark the input as finished.</span></span><br><span class="line">                    [<span class="keyword">self</span>.assetWriterInput markAsFinished];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h2 id="4-Putting-It-All-Together-Using-an-Asset-Reader-and-Writer-in-Tandem-to-Reencode-an-Asset"><a href="#4-Putting-It-All-Together-Using-an-Asset-Reader-and-Writer-in-Tandem-to-Reencode-an-Asset" class="headerlink" title="4. Putting It All Together: Using an Asset Reader and Writer in Tandem to Reencode an Asset"></a>4. Putting It All Together: Using an Asset Reader and Writer in Tandem to Reencode an Asset</h2><p>This brief code example illustrates how to use an asset reader and writer to reencode the first video and audio track of an asset into a new file. It shows how to:</p>
<ul>
<li>Use serialization queues to handle the asynchronous nature of reading and writing audiovisual data 使用串行队列来调度异步处理读写媒体数据</li>
<li>Initialize an asset reader and configure two asset reader outputs, one for audio and one for video 初始化 reader 并配置两个输出源</li>
<li>Initialize an asset writer and configure two asset writer inputs, one for audio and one for video 初始化 writer 并配置两个输出源</li>
<li>Use an asset reader to asynchronously supply media data to an asset writer through two different output&#x2F;input combinations 使用一个 reader 来异步提供媒体数据给 writer </li>
<li>Use a dispatch group to be notified of completion of the reencoding process 使用一个 dispatch group 来通知重新编码的进度</li>
<li>Allow a user to cancel the reencoding process once it has begun 允许用户取消操作</li>
</ul>
<blockquote>
<p>Note: To focus on the most relevant code, this example omits several aspects of a complete application. To use AVFoundation, you are expected to have enough experience with Cocoa to be able to infer the missing pieces.</p>
</blockquote>
<h3 id="4-1-Handling-the-Initial-Setup"><a href="#4-1-Handling-the-Initial-Setup" class="headerlink" title="4.1. Handling the Initial Setup"></a>4.1. Handling the Initial Setup</h3><p>Before you create your asset reader and writer and configure their outputs and inputs, you need to handle some initial setup. The first part of this setup involves creating three separate serialization queues to coordinate the reading and writing process.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *serializationQueueDescription = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ serialization queue&quot;</span>, <span class="keyword">self</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create the main serialization queue.</span></span><br><span class="line"><span class="keyword">self</span>.mainSerializationQueue = dispatch_queue_create([serializationQueueDescription UTF8String], <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">NSString</span> *rwAudioSerializationQueueDescription = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ rw audio serialization queue&quot;</span>, <span class="keyword">self</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create the serialization queue to use for reading and writing the audio data.</span></span><br><span class="line"><span class="keyword">self</span>.rwAudioSerializationQueue = dispatch_queue_create([rwAudioSerializationQueueDescription UTF8String], <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">NSString</span> *rwVideoSerializationQueueDescription = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ rw video serialization queue&quot;</span>, <span class="keyword">self</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create the serialization queue to use for reading and writing the video data.</span></span><br><span class="line"><span class="keyword">self</span>.rwVideoSerializationQueue = dispatch_queue_create([rwVideoSerializationQueueDescription UTF8String], <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>The main serialization queue is used to coordinate the starting and stopping of the asset reader and writer (perhaps due to cancellation) and the other two serialization queues are used to serialize the reading and writing by each output&#x2F;input combination with a potential cancellation.</p>
<p>主队列用来定位 reader 和 writer 的开始和结束，另外连个队列用来调度读写的输入输出源的联合体以及潜在的取消操作。</p>
<p>Now that you have some serialization queues, load the tracks of your asset and begin the reencoding process.</p>
<p>有了队列，就可以加载 asset 中的 tracks 并开始重新编码的进程了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.asset = &lt;#<span class="built_in">AVAsset</span> that you want to reencode#&gt;;</span><br><span class="line"><span class="keyword">self</span>.cancelled = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">self</span>.outputURL = &lt;#<span class="built_in">NSURL</span> representing desired output URL <span class="keyword">for</span> file generated by asset writer#&gt;;</span><br><span class="line"><span class="comment">// Asynchronously load the tracks of the asset you want to read.</span></span><br><span class="line">[<span class="keyword">self</span>.asset loadValuesAsynchronouslyForKeys:@[<span class="string">@&quot;tracks&quot;</span>] completionHandler:^&#123;</span><br><span class="line">     <span class="comment">// Once the tracks have finished loading, dispatch the work to the main serialization queue.</span></span><br><span class="line">     <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.mainSerializationQueue, ^&#123;</span><br><span class="line">          <span class="comment">// Due to asynchronous nature, check to see if user has already cancelled.</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">self</span>.cancelled)</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">          <span class="type">BOOL</span> success = <span class="literal">YES</span>;</span><br><span class="line">          <span class="built_in">NSError</span> *localError = <span class="literal">nil</span>;</span><br><span class="line">          <span class="comment">// Check for success of loading the assets tracks.</span></span><br><span class="line">          success = ([<span class="keyword">self</span>.asset statusOfValueForKey:<span class="string">@&quot;tracks&quot;</span> error:&amp;localError] == <span class="built_in">AVKeyValueStatusLoaded</span>);</span><br><span class="line">          <span class="keyword">if</span> (success)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If the tracks loaded successfully, make sure that no file exists at the output path for the asset writer.</span></span><br><span class="line">               <span class="built_in">NSFileManager</span> *fm = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">               <span class="built_in">NSString</span> *localOutputPath = [<span class="keyword">self</span>.outputURL path];</span><br><span class="line">               <span class="keyword">if</span> ([fm fileExistsAtPath:localOutputPath])</span><br><span class="line">                    success = [fm removeItemAtPath:localOutputPath error:&amp;localError];</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (success)</span><br><span class="line">               success = [<span class="keyword">self</span> setupAssetReaderAndAssetWriter:&amp;localError];</span><br><span class="line">          <span class="keyword">if</span> (success)</span><br><span class="line">               success = [<span class="keyword">self</span> startAssetReaderAndWriter:&amp;localError];</span><br><span class="line">          <span class="keyword">if</span> (!success)</span><br><span class="line">               [<span class="keyword">self</span> readingAndWritingDidFinishSuccessfully:success withError:localError];</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>When the track loading process finishes, whether successfully or not, the rest of the work is dispatched to the main serialization queue to ensure that all of this work is serialized with a potential cancellation. Now all that’s left is to implement the cancellation process and the three custom methods at the end of the previous code listing.</p>
<h3 id="4-2-Initializing-the-Asset-Reader-and-Writer"><a href="#4-2-Initializing-the-Asset-Reader-and-Writer" class="headerlink" title="4.2. Initializing the Asset Reader and Writer"></a>4.2. Initializing the Asset Reader and Writer</h3><p>The custom setupAssetReaderAndAssetWriter: method initializes the reader and writer and configures two output&#x2F;input combinations, one for an audio track and one for a video track. In this example, the audio is decompressed to Linear PCM using the asset reader and compressed back to 128 kbps AAC using the asset writer. The video is decompressed to YUV using the asset reader and compressed to H.264 using the asset writer.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)setupAssetReaderAndAssetWriter:(<span class="built_in">NSError</span> **)outError</span><br><span class="line">&#123;</span><br><span class="line">     <span class="comment">// Create and initialize the asset reader.</span></span><br><span class="line">     <span class="keyword">self</span>.assetReader = [[<span class="built_in">AVAssetReader</span> alloc] initWithAsset:<span class="keyword">self</span>.asset error:outError];</span><br><span class="line">     <span class="type">BOOL</span> success = (<span class="keyword">self</span>.assetReader != <span class="literal">nil</span>);</span><br><span class="line">     <span class="keyword">if</span> (success)</span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// If the asset reader was successfully initialized, do the same for the asset writer.</span></span><br><span class="line">          <span class="keyword">self</span>.assetWriter = [[<span class="built_in">AVAssetWriter</span> alloc] initWithURL:<span class="keyword">self</span>.outputURL fileType:<span class="built_in">AVFileTypeQuickTimeMovie</span> error:outError];</span><br><span class="line">          success = (<span class="keyword">self</span>.assetWriter != <span class="literal">nil</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">if</span> (success)</span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// If the reader and writer were successfully initialized, grab the audio and video asset tracks that will be used.</span></span><br><span class="line">          <span class="built_in">AVAssetTrack</span> *assetAudioTrack = <span class="literal">nil</span>, *assetVideoTrack = <span class="literal">nil</span>;</span><br><span class="line">          <span class="built_in">NSArray</span> *audioTracks = [<span class="keyword">self</span>.asset tracksWithMediaType:<span class="built_in">AVMediaTypeAudio</span>];</span><br><span class="line">          <span class="keyword">if</span> ([audioTracks count] &gt; <span class="number">0</span>)</span><br><span class="line">               assetAudioTrack = [audioTracks objectAtIndex:<span class="number">0</span>];</span><br><span class="line">          <span class="built_in">NSArray</span> *videoTracks = [<span class="keyword">self</span>.asset tracksWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</span><br><span class="line">          <span class="keyword">if</span> ([videoTracks count] &gt; <span class="number">0</span>)</span><br><span class="line">               assetVideoTrack = [videoTracks objectAtIndex:<span class="number">0</span>];</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">if</span> (assetAudioTrack)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If there is an audio track to read, set the decompression settings to Linear PCM and create the asset reader output.</span></span><br><span class="line">               <span class="built_in">NSDictionary</span> *decompressionAudioSettings = @&#123; <span class="built_in">AVFormatIDKey</span> : [<span class="built_in">NSNumber</span> numberWithUnsignedInt:kAudioFormatLinearPCM] &#125;;</span><br><span class="line">               <span class="keyword">self</span>.assetReaderAudioOutput = [<span class="built_in">AVAssetReaderTrackOutput</span> assetReaderTrackOutputWithTrack:assetAudioTrack outputSettings:decompressionAudioSettings];</span><br><span class="line">               [<span class="keyword">self</span>.assetReader addOutput:<span class="keyword">self</span>.assetReaderAudioOutput];</span><br><span class="line">               <span class="comment">// Then, set the compression settings to 128kbps AAC and create the asset writer input.</span></span><br><span class="line">               AudioChannelLayout stereoChannelLayout = &#123;</span><br><span class="line">                    .mChannelLayoutTag = kAudioChannelLayoutTag_Stereo,</span><br><span class="line">                    .mChannelBitmap = <span class="number">0</span>,</span><br><span class="line">                    .mNumberChannelDescriptions = <span class="number">0</span></span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="built_in">NSData</span> *channelLayoutAsData = [<span class="built_in">NSData</span> dataWithBytes:&amp;stereoChannelLayout length:offsetof(AudioChannelLayout, mChannelDescriptions)];</span><br><span class="line">               <span class="built_in">NSDictionary</span> *compressionAudioSettings = @&#123;</span><br><span class="line">                    <span class="built_in">AVFormatIDKey</span>         : [<span class="built_in">NSNumber</span> numberWithUnsignedInt:kAudioFormatMPEG4AAC],</span><br><span class="line">                    <span class="built_in">AVEncoderBitRateKey</span>   : [<span class="built_in">NSNumber</span> numberWithInteger:<span class="number">128000</span>],</span><br><span class="line">                    <span class="built_in">AVSampleRateKey</span>       : [<span class="built_in">NSNumber</span> numberWithInteger:<span class="number">44100</span>],</span><br><span class="line">                    <span class="built_in">AVChannelLayoutKey</span>    : channelLayoutAsData,</span><br><span class="line">                    <span class="built_in">AVNumberOfChannelsKey</span> : [<span class="built_in">NSNumber</span> numberWithUnsignedInteger:<span class="number">2</span>]</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">self</span>.assetWriterAudioInput = [<span class="built_in">AVAssetWriterInput</span> assetWriterInputWithMediaType:[assetAudioTrack mediaType] outputSettings:compressionAudioSettings];</span><br><span class="line">               [<span class="keyword">self</span>.assetWriter addInput:<span class="keyword">self</span>.assetWriterAudioInput];</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">if</span> (assetVideoTrack)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If there is a video track to read, set the decompression settings for YUV and create the asset reader output.</span></span><br><span class="line">               <span class="built_in">NSDictionary</span> *decompressionVideoSettings = @&#123;</span><br><span class="line">                    (<span class="type">id</span>)kCVPixelBufferPixelFormatTypeKey     : [<span class="built_in">NSNumber</span> numberWithUnsignedInt:kCVPixelFormatType_422YpCbCr8],</span><br><span class="line">                    (<span class="type">id</span>)kCVPixelBufferIOSurfacePropertiesKey : [<span class="built_in">NSDictionary</span> dictionary]</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">self</span>.assetReaderVideoOutput = [<span class="built_in">AVAssetReaderTrackOutput</span> assetReaderTrackOutputWithTrack:assetVideoTrack outputSettings:decompressionVideoSettings];</span><br><span class="line">               [<span class="keyword">self</span>.assetReader addOutput:<span class="keyword">self</span>.assetReaderVideoOutput];</span><br><span class="line">               <span class="built_in">CMFormatDescriptionRef</span> formatDescription = <span class="literal">NULL</span>;</span><br><span class="line">               <span class="comment">// Grab the video format descriptions from the video track and grab the first one if it exists.</span></span><br><span class="line">               <span class="built_in">NSArray</span> *videoFormatDescriptions = [assetVideoTrack formatDescriptions];</span><br><span class="line">               <span class="keyword">if</span> ([videoFormatDescriptions count] &gt; <span class="number">0</span>)</span><br><span class="line">                    formatDescription = (__bridge <span class="built_in">CMFormatDescriptionRef</span>)[formatDescriptions objectAtIndex:<span class="number">0</span>];</span><br><span class="line">               <span class="built_in">CGSize</span> trackDimensions = &#123;</span><br><span class="line">                    .width = <span class="number">0.0</span>,</span><br><span class="line">                    .height = <span class="number">0.0</span>,</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="comment">// If the video track had a format description, grab the track dimensions from there. Otherwise, grab them direcly from the track itself.</span></span><br><span class="line">               <span class="keyword">if</span> (formatDescription)</span><br><span class="line">                    trackDimensions = <span class="built_in">CMVideoFormatDescriptionGetPresentationDimensions</span>(formatDescription, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">                    trackDimensions = [assetVideoTrack naturalSize];</span><br><span class="line">               <span class="built_in">NSDictionary</span> *compressionSettings = <span class="literal">nil</span>;</span><br><span class="line">               <span class="comment">// If the video track had a format description, attempt to grab the clean aperture settings and pixel aspect ratio used by the video.</span></span><br><span class="line">               <span class="keyword">if</span> (formatDescription)</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="built_in">NSDictionary</span> *cleanAperture = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="built_in">NSDictionary</span> *pixelAspectRatio = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="built_in">CFDictionaryRef</span> cleanApertureFromCMFormatDescription = <span class="built_in">CMFormatDescriptionGetExtension</span>(formatDescription, kCMFormatDescriptionExtension_CleanAperture);</span><br><span class="line">                    <span class="keyword">if</span> (cleanApertureFromCMFormatDescription)</span><br><span class="line">                    &#123;</span><br><span class="line">                         cleanAperture = @&#123;</span><br><span class="line">                              <span class="built_in">AVVideoCleanApertureWidthKey</span>            : (<span class="type">id</span>)<span class="built_in">CFDictionaryGetValue</span>(cleanApertureFromCMFormatDescription, kCMFormatDescriptionKey_CleanApertureWidth),</span><br><span class="line">                              <span class="built_in">AVVideoCleanApertureHeightKey</span>           : (<span class="type">id</span>)<span class="built_in">CFDictionaryGetValue</span>(cleanApertureFromCMFormatDescription, kCMFormatDescriptionKey_CleanApertureHeight),</span><br><span class="line">                              <span class="built_in">AVVideoCleanApertureHorizontalOffsetKey</span> : (<span class="type">id</span>)<span class="built_in">CFDictionaryGetValue</span>(cleanApertureFromCMFormatDescription, kCMFormatDescriptionKey_CleanApertureHorizontalOffset),</span><br><span class="line">                              <span class="built_in">AVVideoCleanApertureVerticalOffsetKey</span>   : (<span class="type">id</span>)<span class="built_in">CFDictionaryGetValue</span>(cleanApertureFromCMFormatDescription, kCMFormatDescriptionKey_CleanApertureVerticalOffset)</span><br><span class="line">                         &#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">CFDictionaryRef</span> pixelAspectRatioFromCMFormatDescription = <span class="built_in">CMFormatDescriptionGetExtension</span>(formatDescription, kCMFormatDescriptionExtension_PixelAspectRatio);</span><br><span class="line">                    <span class="keyword">if</span> (pixelAspectRatioFromCMFormatDescription)</span><br><span class="line">                    &#123;</span><br><span class="line">                         pixelAspectRatio = @&#123;</span><br><span class="line">                              <span class="built_in">AVVideoPixelAspectRatioHorizontalSpacingKey</span> : (<span class="type">id</span>)<span class="built_in">CFDictionaryGetValue</span>(pixelAspectRatioFromCMFormatDescription, kCMFormatDescriptionKey_PixelAspectRatioHorizontalSpacing),</span><br><span class="line">                              <span class="built_in">AVVideoPixelAspectRatioVerticalSpacingKey</span>   : (<span class="type">id</span>)<span class="built_in">CFDictionaryGetValue</span>(pixelAspectRatioFromCMFormatDescription, kCMFormatDescriptionKey_PixelAspectRatioVerticalSpacing)</span><br><span class="line">                         &#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Add whichever settings we could grab from the format description to the compression settings dictionary.</span></span><br><span class="line">                    <span class="keyword">if</span> (cleanAperture || pixelAspectRatio)</span><br><span class="line">                    &#123;</span><br><span class="line">                         <span class="built_in">NSMutableDictionary</span> *mutableCompressionSettings = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">                         <span class="keyword">if</span> (cleanAperture)</span><br><span class="line">                              [mutableCompressionSettings setObject:cleanAperture forKey:<span class="built_in">AVVideoCleanApertureKey</span>];</span><br><span class="line">                         <span class="keyword">if</span> (pixelAspectRatio)</span><br><span class="line">                              [mutableCompressionSettings setObject:pixelAspectRatio forKey:<span class="built_in">AVVideoPixelAspectRatioKey</span>];</span><br><span class="line">                         compressionSettings = mutableCompressionSettings;</span><br><span class="line">                    &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// Create the video settings dictionary for H.264.</span></span><br><span class="line">               <span class="built_in">NSMutableDictionary</span> *videoSettings = (<span class="built_in">NSMutableDictionary</span> *) @&#123;</span><br><span class="line">                    <span class="built_in">AVVideoCodecKey</span>  : <span class="built_in">AVVideoCodecH264</span>,</span><br><span class="line">                    <span class="built_in">AVVideoWidthKey</span>  : [<span class="built_in">NSNumber</span> numberWithDouble:trackDimensions.width],</span><br><span class="line">                    <span class="built_in">AVVideoHeightKey</span> : [<span class="built_in">NSNumber</span> numberWithDouble:trackDimensions.height]</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="comment">// Put the compression settings into the video settings dictionary if we were able to grab them.</span></span><br><span class="line">               <span class="keyword">if</span> (compressionSettings)</span><br><span class="line">                    [videoSettings setObject:compressionSettings forKey:<span class="built_in">AVVideoCompressionPropertiesKey</span>];</span><br><span class="line">               <span class="comment">// Create the asset writer input and add it to the asset writer.</span></span><br><span class="line">               <span class="keyword">self</span>.assetWriterVideoInput = [<span class="built_in">AVAssetWriterInput</span> assetWriterInputWithMediaType:[videoTrack mediaType] outputSettings:videoSettings];</span><br><span class="line">               [<span class="keyword">self</span>.assetWriter addInput:<span class="keyword">self</span>.assetWriterVideoInput];</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Reencoding-the-Asset"><a href="#4-3-Reencoding-the-Asset" class="headerlink" title="4.3. Reencoding the Asset"></a>4.3. Reencoding the Asset</h3><p>Provided that the asset reader and writer are successfully initialized and configured, the startAssetReaderAndWriter: method described in Handling the Initial Setup is called. This method is where the actual reading and writing of the asset takes place.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)startAssetReaderAndWriter:(<span class="built_in">NSError</span> **)outError</span><br><span class="line">&#123;</span><br><span class="line">     <span class="type">BOOL</span> success = <span class="literal">YES</span>;</span><br><span class="line">     <span class="comment">// Attempt to start the asset reader.</span></span><br><span class="line">     success = [<span class="keyword">self</span>.assetReader startReading];</span><br><span class="line">     <span class="keyword">if</span> (!success)</span><br><span class="line">          *outError = [<span class="keyword">self</span>.assetReader error];</span><br><span class="line">     <span class="keyword">if</span> (success)</span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// If the reader started successfully, attempt to start the asset writer.</span></span><br><span class="line">          success = [<span class="keyword">self</span>.assetWriter startWriting];</span><br><span class="line">          <span class="keyword">if</span> (!success)</span><br><span class="line">               *outError = [<span class="keyword">self</span>.assetWriter error];</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">if</span> (success)</span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// If the asset reader and writer both started successfully, create the dispatch group where the reencoding will take place and start a sample-writing session.</span></span><br><span class="line">          <span class="keyword">self</span>.dispatchGroup = dispatch_group_create();</span><br><span class="line">          [<span class="keyword">self</span>.assetWriter startSessionAtSourceTime:kCMTimeZero];</span><br><span class="line">          <span class="keyword">self</span>.audioFinished = <span class="literal">NO</span>;</span><br><span class="line">          <span class="keyword">self</span>.videoFinished = <span class="literal">NO</span>;</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">self</span>.assetWriterAudioInput)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If there is audio to reencode, enter the dispatch group before beginning the work.</span></span><br><span class="line">               dispatch_group_enter(<span class="keyword">self</span>.dispatchGroup);</span><br><span class="line">               <span class="comment">// Specify the block to execute when the asset writer is ready for audio media data, and specify the queue to call it on.</span></span><br><span class="line">               [<span class="keyword">self</span>.assetWriterAudioInput requestMediaDataWhenReadyOnQueue:<span class="keyword">self</span>.rwAudioSerializationQueue usingBlock:^&#123;</span><br><span class="line">                    <span class="comment">// Because the block is called asynchronously, check to see whether its task is complete.</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">self</span>.audioFinished)</span><br><span class="line">                         <span class="keyword">return</span>;</span><br><span class="line">                    <span class="type">BOOL</span> completedOrFailed = <span class="literal">NO</span>;</span><br><span class="line">                    <span class="comment">// If the task isn&#x27;t complete yet, make sure that the input is actually ready for more media data.</span></span><br><span class="line">                    <span class="keyword">while</span> ([<span class="keyword">self</span>.assetWriterAudioInput isReadyForMoreMediaData] &amp;&amp; !completedOrFailed)</span><br><span class="line">                    &#123;</span><br><span class="line">                         <span class="comment">// Get the next audio sample buffer, and append it to the output file.</span></span><br><span class="line">                         <span class="built_in">CMSampleBufferRef</span> sampleBuffer = [<span class="keyword">self</span>.assetReaderAudioOutput copyNextSampleBuffer];</span><br><span class="line">                         <span class="keyword">if</span> (sampleBuffer != <span class="literal">NULL</span>)</span><br><span class="line">                         &#123;</span><br><span class="line">                              <span class="type">BOOL</span> success = [<span class="keyword">self</span>.assetWriterAudioInput appendSampleBuffer:sampleBuffer];</span><br><span class="line">                              <span class="built_in">CFRelease</span>(sampleBuffer);</span><br><span class="line">                              sampleBuffer = <span class="literal">NULL</span>;</span><br><span class="line">                              completedOrFailed = !success;</span><br><span class="line">                         &#125;</span><br><span class="line">                         <span class="keyword">else</span></span><br><span class="line">                         &#123;</span><br><span class="line">                              completedOrFailed = <span class="literal">YES</span>;</span><br><span class="line">                         &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (completedOrFailed)</span><br><span class="line">                    &#123;</span><br><span class="line">                         <span class="comment">// Mark the input as finished, but only if we haven&#x27;t already done so, and then leave the dispatch group (since the audio work has finished).</span></span><br><span class="line">                         <span class="type">BOOL</span> oldFinished = <span class="keyword">self</span>.audioFinished;</span><br><span class="line">                         <span class="keyword">self</span>.audioFinished = <span class="literal">YES</span>;</span><br><span class="line">                         <span class="keyword">if</span> (oldFinished == <span class="literal">NO</span>)</span><br><span class="line">                         &#123;</span><br><span class="line">                              [<span class="keyword">self</span>.assetWriterAudioInput markAsFinished];</span><br><span class="line">                         &#125;</span><br><span class="line">                         dispatch_group_leave(<span class="keyword">self</span>.dispatchGroup);</span><br><span class="line">                    &#125;</span><br><span class="line">               &#125;];</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">self</span>.assetWriterVideoInput)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// If we had video to reencode, enter the dispatch group before beginning the work.</span></span><br><span class="line">               dispatch_group_enter(<span class="keyword">self</span>.dispatchGroup);</span><br><span class="line">               <span class="comment">// Specify the block to execute when the asset writer is ready for video media data, and specify the queue to call it on.</span></span><br><span class="line">               [<span class="keyword">self</span>.assetWriterVideoInput requestMediaDataWhenReadyOnQueue:<span class="keyword">self</span>.rwVideoSerializationQueue usingBlock:^&#123;</span><br><span class="line">                    <span class="comment">// Because the block is called asynchronously, check to see whether its task is complete.</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">self</span>.videoFinished)</span><br><span class="line">                         <span class="keyword">return</span>;</span><br><span class="line">                    <span class="type">BOOL</span> completedOrFailed = <span class="literal">NO</span>;</span><br><span class="line">                    <span class="comment">// If the task isn&#x27;t complete yet, make sure that the input is actually ready for more media data.</span></span><br><span class="line">                    <span class="keyword">while</span> ([<span class="keyword">self</span>.assetWriterVideoInput isReadyForMoreMediaData] &amp;&amp; !completedOrFailed)</span><br><span class="line">                    &#123;</span><br><span class="line">                         <span class="comment">// Get the next video sample buffer, and append it to the output file.</span></span><br><span class="line">                         <span class="built_in">CMSampleBufferRef</span> sampleBuffer = [<span class="keyword">self</span>.assetReaderVideoOutput copyNextSampleBuffer];</span><br><span class="line">                         <span class="keyword">if</span> (sampleBuffer != <span class="literal">NULL</span>)</span><br><span class="line">                         &#123;</span><br><span class="line">                              <span class="type">BOOL</span> success = [<span class="keyword">self</span>.assetWriterVideoInput appendSampleBuffer:sampleBuffer];</span><br><span class="line">                              <span class="built_in">CFRelease</span>(sampleBuffer);</span><br><span class="line">                              sampleBuffer = <span class="literal">NULL</span>;</span><br><span class="line">                              completedOrFailed = !success;</span><br><span class="line">                         &#125;</span><br><span class="line">                         <span class="keyword">else</span></span><br><span class="line">                         &#123;</span><br><span class="line">                              completedOrFailed = <span class="literal">YES</span>;</span><br><span class="line">                         &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (completedOrFailed)</span><br><span class="line">                    &#123;</span><br><span class="line">                         <span class="comment">// Mark the input as finished, but only if we haven&#x27;t already done so, and then leave the dispatch group (since the video work has finished).</span></span><br><span class="line">                         <span class="type">BOOL</span> oldFinished = <span class="keyword">self</span>.videoFinished;</span><br><span class="line">                         <span class="keyword">self</span>.videoFinished = <span class="literal">YES</span>;</span><br><span class="line">                         <span class="keyword">if</span> (oldFinished == <span class="literal">NO</span>)</span><br><span class="line">                         &#123;</span><br><span class="line">                              [<span class="keyword">self</span>.assetWriterVideoInput markAsFinished];</span><br><span class="line">                         &#125;</span><br><span class="line">                         dispatch_group_leave(<span class="keyword">self</span>.dispatchGroup);</span><br><span class="line">                    &#125;</span><br><span class="line">               &#125;];</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Set up the notification that the dispatch group will send when the audio and video work have both finished.</span></span><br><span class="line">          dispatch_group_notify(<span class="keyword">self</span>.dispatchGroup, <span class="keyword">self</span>.mainSerializationQueue, ^&#123;</span><br><span class="line">               <span class="type">BOOL</span> finalSuccess = <span class="literal">YES</span>;</span><br><span class="line">               <span class="built_in">NSError</span> *finalError = <span class="literal">nil</span>;</span><br><span class="line">               <span class="comment">// Check to see if the work has finished due to cancellation.</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">self</span>.cancelled)</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="comment">// If so, cancel the reader and writer.</span></span><br><span class="line">                    [<span class="keyword">self</span>.assetReader cancelReading];</span><br><span class="line">                    [<span class="keyword">self</span>.assetWriter cancelWriting];</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="comment">// If cancellation didn&#x27;t occur, first make sure that the asset reader didn&#x27;t fail.</span></span><br><span class="line">                    <span class="keyword">if</span> ([<span class="keyword">self</span>.assetReader status] == <span class="built_in">AVAssetReaderStatusFailed</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                         finalSuccess = <span class="literal">NO</span>;</span><br><span class="line">                         finalError = [<span class="keyword">self</span>.assetReader error];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// If the asset reader didn&#x27;t fail, attempt to stop the asset writer and check for any errors.</span></span><br><span class="line">                    <span class="keyword">if</span> (finalSuccess)</span><br><span class="line">                    &#123;</span><br><span class="line">                         finalSuccess = [<span class="keyword">self</span>.assetWriter finishWriting];</span><br><span class="line">                         <span class="keyword">if</span> (!finalSuccess)</span><br><span class="line">                              finalError = [<span class="keyword">self</span>.assetWriter error];</span><br><span class="line">                    &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// Call the method to handle completion, and pass in the appropriate parameters to indicate whether reencoding was successful.</span></span><br><span class="line">               [<span class="keyword">self</span> readingAndWritingDidFinishSuccessfully:finalSuccess withError:finalError];</span><br><span class="line">          &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// Return success here to indicate whether the asset reader and writer were started successfully.</span></span><br><span class="line">     <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>During reencoding, the audio and video tracks are asynchronously handled on individual serialization queues to increase the overall performance of the process, but both queues are contained within the same dispatch group. By placing the work for each track within the same dispatch group, the group can send a notification when all of the work is done and the success of the reencoding process can be determined.</p>
<p>音频和视频 track 在各自队列里异步的处理，又在同一个队列组中，这样方便获取编码 成功的通知。</p>
<h3 id="4-4-Handling-Completion"><a href="#4-4-Handling-Completion" class="headerlink" title="4.4. Handling Completion"></a>4.4. Handling Completion</h3><p>To handle the completion of the reading and writing process, the readingAndWritingDidFinishSuccessfully: method is called—with parameters indicating whether or not the reencoding completed successfully. If the process didn’t finish successfully, the asset reader and writer are both canceled and any UI related tasks are dispatched to the main queue.</p>
<p>处理完成时：进度和是否成功。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)readingAndWritingDidFinishSuccessfully:(<span class="type">BOOL</span>)success withError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">if</span> (!success)</span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// If the reencoding process failed, we need to cancel the asset reader and writer.</span></span><br><span class="line">          [<span class="keyword">self</span>.assetReader cancelReading];</span><br><span class="line">          [<span class="keyword">self</span>.assetWriter cancelWriting];</span><br><span class="line">          <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">               <span class="comment">// Handle any UI tasks here related to failure.</span></span><br><span class="line">          &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">          <span class="comment">// Reencoding was successful, reset booleans.</span></span><br><span class="line">          <span class="keyword">self</span>.cancelled = <span class="literal">NO</span>;</span><br><span class="line">          <span class="keyword">self</span>.videoFinished = <span class="literal">NO</span>;</span><br><span class="line">          <span class="keyword">self</span>.audioFinished = <span class="literal">NO</span>;</span><br><span class="line">          <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">               <span class="comment">// Handle any UI tasks here related to success.</span></span><br><span class="line">          &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-5-Handling-Cancellation"><a href="#4-5-Handling-Cancellation" class="headerlink" title="4.5. Handling Cancellation"></a>4.5. Handling Cancellation</h3><p>Using multiple serialization queues, you can allow the user of your app to cancel the reencoding process with ease. On the main serialization queue, messages are asynchronously sent to each of the asset reencoding serialization queues to cancel their reading and writing. When these two serialization queues complete their cancellation, the dispatch group sends a notification to the main serialization queue where the cancelled property is set to YES. You might associate the cancel method from the following code listing with a button on your UI.</p>
<p>处理取消操作</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)cancel</span><br><span class="line">&#123;</span><br><span class="line">     <span class="comment">// Handle cancellation asynchronously, but serialize it with the main queue.</span></span><br><span class="line">     <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.mainSerializationQueue, ^&#123;</span><br><span class="line">          <span class="comment">// If we had audio data to reencode, we need to cancel the audio work.</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">self</span>.assetWriterAudioInput)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// Handle cancellation asynchronously again, but this time serialize it with the audio queue.</span></span><br><span class="line">               <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.rwAudioSerializationQueue, ^&#123;</span><br><span class="line">                    <span class="comment">// Update the Boolean property indicating the task is complete and mark the input as finished if it hasn&#x27;t already been marked as such.</span></span><br><span class="line">                    <span class="type">BOOL</span> oldFinished = <span class="keyword">self</span>.audioFinished;</span><br><span class="line">                    <span class="keyword">self</span>.audioFinished = <span class="literal">YES</span>;</span><br><span class="line">                    <span class="keyword">if</span> (oldFinished == <span class="literal">NO</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                         [<span class="keyword">self</span>.assetWriterAudioInput markAsFinished];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Leave the dispatch group since the audio work is finished now.</span></span><br><span class="line">                    dispatch_group_leave(<span class="keyword">self</span>.dispatchGroup);</span><br><span class="line">               &#125;);</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">self</span>.assetWriterVideoInput)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="comment">// Handle cancellation asynchronously again, but this time serialize it with the video queue.</span></span><br><span class="line">               <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.rwVideoSerializationQueue, ^&#123;</span><br><span class="line">                    <span class="comment">// Update the Boolean property indicating the task is complete and mark the input as finished if it hasn&#x27;t already been marked as such.</span></span><br><span class="line">                    <span class="type">BOOL</span> oldFinished = <span class="keyword">self</span>.videoFinished;</span><br><span class="line">                    <span class="keyword">self</span>.videoFinished = <span class="literal">YES</span>;</span><br><span class="line">                    <span class="keyword">if</span> (oldFinished == <span class="literal">NO</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                         [<span class="keyword">self</span>.assetWriterVideoInput markAsFinished];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Leave the dispatch group, since the video work is finished now.</span></span><br><span class="line">                    dispatch_group_leave(<span class="keyword">self</span>.dispatchGroup);</span><br><span class="line">               &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Set the cancelled Boolean property to YES to cancel any work on the main queue as well.</span></span><br><span class="line">          <span class="keyword">self</span>.cancelled = <span class="literal">YES</span>;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-Asset-Output-Settings-Assistant"><a href="#5-Asset-Output-Settings-Assistant" class="headerlink" title="5. Asset Output Settings Assistant"></a>5. Asset Output Settings Assistant</h2><p>The AVOutputSettingsAssistant class aids in creating output-settings dictionaries for an asset reader or writer. This makes setup much simpler, especially for high frame rate H264 movies that have a number of specific presets. Listing 5-1 shows an example that uses the output settings assistant to use the settings assistant.</p>
<p>资源输出源设置助手</p>
<p>Listing 5-1  AVOutputSettingsAssistant sample</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVOutputSettingsAssistant</span> *outputSettingsAssistant = [<span class="built_in">AVOutputSettingsAssistant</span> outputSettingsAssistantWithPreset:&lt;some preset&gt;];</span><br><span class="line"><span class="built_in">CMFormatDescriptionRef</span> audioFormat = [<span class="keyword">self</span> getAudioFormat];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (audioFormat != <span class="literal">NULL</span>)</span><br><span class="line">    [outputSettingsAssistant setSourceAudioFormat:(<span class="built_in">CMAudioFormatDescriptionRef</span>)audioFormat];</span><br><span class="line"> </span><br><span class="line"><span class="built_in">CMFormatDescriptionRef</span> videoFormat = [<span class="keyword">self</span> getVideoFormat];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (videoFormat != <span class="literal">NULL</span>)</span><br><span class="line">    [outputSettingsAssistant setSourceVideoFormat:(<span class="built_in">CMVideoFormatDescriptionRef</span>)videoFormat];</span><br><span class="line"> </span><br><span class="line"><span class="built_in">CMTime</span> assetMinVideoFrameDuration = [<span class="keyword">self</span> getMinFrameDuration];</span><br><span class="line"><span class="built_in">CMTime</span> averageFrameDuration = [<span class="keyword">self</span> getAvgFrameDuration]</span><br><span class="line"> </span><br><span class="line">[outputSettingsAssistant setSourceVideoAverageFrameDuration:averageFrameDuration];</span><br><span class="line">[outputSettingsAssistant setSourceVideoMinFrameDuration:assetMinVideoFrameDuration];</span><br><span class="line"> </span><br><span class="line"><span class="built_in">AVAssetWriter</span> *assetWriter = [<span class="built_in">AVAssetWriter</span> assetWriterWithURL:&lt;some URL&gt; fileType:[outputSettingsAssistant outputFileType] error:<span class="literal">NULL</span>];</span><br><span class="line"><span class="built_in">AVAssetWriterInput</span> *audioInput = [<span class="built_in">AVAssetWriterInput</span> assetWriterInputWithMediaType:<span class="built_in">AVMediaTypeAudio</span> outputSettings:[outputSettingsAssistant audioSettings] sourceFormatHint:audioFormat];</span><br><span class="line"><span class="built_in">AVAssetWriterInput</span> *videoInput = [<span class="built_in">AVAssetWriterInput</span> assetWriterInputWithMediaType:<span class="built_in">AVMediaTypeVideo</span> outputSettings:[outputSettingsAssistant videoSettings] sourceFormatHint:videoFormat];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>AVReaderWriter: Offline Audio &#x2F; Video Processing:<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/mac/samplecode/ReaderWriter/Introduction/Intro.html">https://developer.apple.com/library/mac/samplecode/ReaderWriter/Introduction/Intro.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/04/28/Core-Data-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/28/Core-Data-Notes/" class="post-title-link" itemprop="url">Core Data - Notes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-04-28 23:39:00" itemprop="dateCreated datePublished" datetime="2016-04-28T23:39:00+08:00">2016-04-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近项目写 Core Data 感觉之前的看过零碎的知识忘记的差不多了，又遇到异步处理的问题。重新看了一些资料，总结了一些要点如下。</p>
<h2 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h2><p> Core Data 是一个 对象图管理和存储框架。简单明确的属性和关系以及获取，都已封装好。不管底层数据库的实现，开发者只需关心数据和获取就行了。</p>
<h2 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h2><p>图形化编辑器：xcdatamodel </p>
<p>managed object model ：</p>
<ul>
<li>属性支持 NSData：Binary Data 和符合 NSCoding protocol 的类型：Transformable</li>
<li>关系建议采取 inverse</li>
<li>关系一对多和一对一，其中有有序和无序的一对多的关系，分别为 NSSet 和 NSOrderedSet，具体可以参考这样文章</li>
</ul>
<p>Core Data and Swift: Relationships and More Fetching ：<br><a target="_blank" rel="noopener" href="http://code.tutsplus.com/tutorials/core-data-and-swift-relationships-and-more-fetching--cms-25070">http://code.tutsplus.com/tutorials/core-data-and-swift-relationships-and-more-fetching--cms-25070
</a> </p>
<h2 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h2><p>  Core Data Stack 涉及四个类：</p>
<ul>
<li>NSManagedObjectModel</li>
<li>NSPersistentStore</li>
<li>NSPersistentStoreCoordinator</li>
<li>NSManagedObjectContext</li>
</ul>
<h2 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h2><p>NSManagedObjectContext：</p>
<ul>
<li>内存寄存器来处理 managed objects</li>
<li>记得 save()</li>
<li>掌管 managed objects 生命周期包括创建和获取</li>
<li>managed object 不能独立于 context 存在</li>
<li>context 具有领域性，一旦一个 managed object 被管理在一个 context ，将会在其整个生命周期绑定该 context</li>
<li>支持多个 context</li>
<li><strong>context 不是线程安全的</strong></li>
</ul>
<h2 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h2><p>如何配置 Core Data Stack：</p>
<p>其中 lazy、try catch 等技术细节不用多解释，后面在介绍多个 context 和异步处理的线程安全问题。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoreDataStack</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> modelName <span class="operator">=</span> <span class="string">&quot;Dog Walk&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">var</span> context: <span class="type">NSManagedObjectContext</span> <span class="operator">=</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> managedObjectContext <span class="operator">=</span> <span class="type">NSManagedObjectContext</span>(</span><br><span class="line">      concurrencyType: .<span class="type">MainQueueConcurrencyType</span>)</span><br><span class="line">    </span><br><span class="line">    managedObjectContext.persistentStoreCoordinator <span class="operator">=</span> <span class="keyword">self</span>.psc</span><br><span class="line">    <span class="keyword">return</span> managedObjectContext</span><br><span class="line">    &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">var</span> psc: <span class="type">NSPersistentStoreCoordinator</span> <span class="operator">=</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> coordinator <span class="operator">=</span> <span class="type">NSPersistentStoreCoordinator</span>(</span><br><span class="line">      managedObjectModel: <span class="keyword">self</span>.managedObjectModel)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="keyword">self</span>.applicationDocumentsDirectory</span><br><span class="line">      .<span class="type">URLByAppendingPathComponent</span>(<span class="keyword">self</span>.modelName)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> options <span class="operator">=</span></span><br><span class="line">      [<span class="type">NSMigratePersistentStoresAutomaticallyOption</span> : <span class="literal">true</span>]</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">try</span> coordinator.addPersistentStoreWithType(</span><br><span class="line">        <span class="type">NSSQLiteStoreType</span>, configuration: <span class="literal">nil</span>, URL: url,</span><br><span class="line">        options: options)</span><br><span class="line">    &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Error adding persistent store.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> coordinator</span><br><span class="line">    &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">var</span> managedObjectModel: <span class="type">NSManagedObjectModel</span> <span class="operator">=</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> modelURL <span class="operator">=</span> <span class="type">NSBundle</span>.mainBundle()</span><br><span class="line">      .<span class="type">URLForResource</span>(<span class="keyword">self</span>.modelName,</span><br><span class="line">        withExtension: <span class="string">&quot;momd&quot;</span>)<span class="operator">!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">NSManagedObjectModel</span>(contentsOfURL: modelURL)<span class="operator">!</span></span><br><span class="line">    &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">var</span> applicationDocumentsDirectory: <span class="type">NSURL</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> urls <span class="operator">=</span> <span class="type">NSFileManager</span>.defaultManager().<span class="type">URLsForDirectory</span>(</span><br><span class="line">      .<span class="type">DocumentDirectory</span>, inDomains: .<span class="type">UserDomainMask</span>)</span><br><span class="line">    <span class="keyword">return</span> urls[urls.count<span class="operator">-</span><span class="number">1</span>]</span><br><span class="line">    &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">saveContext</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> context.hasChanges &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> context.save()</span><br><span class="line">      &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error: <span class="subst">\(error.localizedDescription)</span>&quot;</span>)</span><br><span class="line">        abort()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6"><a href="#6" class="headerlink" title="6."></a>6.</h2><p>Fetch</p>
<ul>
<li>NSManagedObjectResultType: 默认值，返回 managed objects </li>
<li>NSCountResultType: 返回 count</li>
<li>NSDictionaryResultType:  返回一个计算后值，如 sum。详细用法可以看文档 NSExpression</li>
<li>NSManagedObjectIDResultType:</li>
</ul>
<p>从性能优化的角度，可以考虑时候后面的几个类型。<br>iOS8异步fetch：NSAsynchronousFetchRequest、批量更新&#x2F;删除属性</p>
<h2 id="7"><a href="#7" class="headerlink" title="7."></a>7.</h2><p>fetched results controller 可以帮助我们处理 core data 和 table view datasource，可以简单的看成专用的 datasource。</p>
<p>记得添加 cacheName</p>
<h2 id="8"><a href="#8" class="headerlink" title="8."></a>8.</h2><p>后台处理使用 context PrivateQueueConcurrencyType，默认使用 MainQueueConcurrencyType，尤其设计 UI。</p>
<p>可以使用 child context，先保存 child context 至 内存寄存器，一直到 parent context 保存后，才会保存至硬盘。</p>
<p>这里就涉及一个好的实践：有多个 context 总是调用 performBlock 来保证安全。</p>
<p>下面是一个 private context 后台处理，回到主线程的实践：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="keyword">let</span> privateContext <span class="operator">=</span> <span class="type">NSManagedObjectContext</span>(</span><br><span class="line">    concurrencyType: .<span class="type">PrivateQueueConcurrencyType</span>)</span><br><span class="line">privateContext.persistentStoreCoordinator <span class="operator">=</span></span><br><span class="line">    coreDataStack.context.persistentStoreCoordinator</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">privateContext.performBlock &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">let</span> results: [<span class="type">AnyObject</span>]</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        results <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">self</span>.coreDataStack.context</span><br><span class="line">            .executeFetchRequest(<span class="keyword">self</span>.surfJournalFetchRequest())</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> nserror <span class="operator">=</span> error <span class="keyword">as</span> <span class="type">NSError</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ERROR: <span class="subst">\(nserror)</span>&quot;</span>)</span><br><span class="line">        results <span class="operator">=</span> []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> exportFilePath <span class="operator">=</span></span><br><span class="line">        <span class="type">NSTemporaryDirectory</span>() <span class="operator">+</span> <span class="string">&quot;export.csv&quot;</span></span><br><span class="line">    <span class="keyword">let</span> exportFileURL <span class="operator">=</span> <span class="type">NSURL</span>(fileURLWithPath: exportFilePath)</span><br><span class="line">    <span class="type">NSFileManager</span>.defaultManager().createFileAtPath(</span><br><span class="line">        exportFilePath, contents: <span class="type">NSData</span>(), attributes: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">let</span> fileHandle: <span class="type">NSFileHandle</span>?</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        fileHandle <span class="operator">=</span> <span class="keyword">try</span> <span class="type">NSFileHandle</span>(forWritingToURL: exportFileURL)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> nserror <span class="operator">=</span> error <span class="keyword">as</span> <span class="type">NSError</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ERROR: <span class="subst">\(nserror)</span>&quot;</span>)</span><br><span class="line">        fileHandle <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> fileHandle <span class="operator">=</span> fileHandle &#123;</span><br><span class="line">        <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">for</span> object <span class="keyword">in</span> results &#123;</span><br><span class="line">            <span class="keyword">let</span> journalEntry <span class="operator">=</span> object <span class="keyword">as!</span> <span class="type">JournalEntry</span></span><br><span class="line"></span><br><span class="line">            fileHandle.seekToEndOfFile()</span><br><span class="line">            <span class="keyword">let</span> csvData <span class="operator">=</span> journalEntry.csv().dataUsingEncoding(</span><br><span class="line">                <span class="type">NSUTF8StringEncoding</span>, allowLossyConversion: <span class="literal">false</span>)</span><br><span class="line">            fileHandle.writeData(csvData<span class="operator">!</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5</span></span><br><span class="line">        fileHandle.closeFile()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4</span></span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.navigationItem.leftBarButtonItem <span class="operator">=</span></span><br><span class="line">                <span class="keyword">self</span>.exportBarButtonItem()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Export Path: <span class="subst">\(exportFilePath)</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">self</span>.showExportFinishedAlertView(exportFilePath)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.navigationItem.leftBarButtonItem <span class="operator">=</span></span><br><span class="line">                <span class="keyword">self</span>.exportBarButtonItem()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// 5 Closing brace for performBlock()</span></span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="9-参考资料"><a href="#9-参考资料" class="headerlink" title="9. 参考资料"></a>9. 参考资料</h2><ul>
<li>走进Core Data的世界：<br>  <a target="_blank" rel="noopener" href="http://liuduo.me/2016/03/12/gointocoredata/">http://liuduo.me/2016/03/12/gointocoredata/</a></li>
<li>Core Data by Tutorials:<br>   <a target="_blank" rel="noopener" href="https://www.raywenderlich.com/store/core-data-by-tutorials">https://www.raywenderlich.com/store/core-data-by-tutorials
</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/04/22/AVFoundation-Camera-Swift/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/22/AVFoundation-Camera-Swift/" class="post-title-link" itemprop="url">AVFoundation Camera Swift</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-04-22 15:35:00" itemprop="dateCreated datePublished" datetime="2016-04-22T15:35:00+08:00">2016-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>AVCam-iOSUsingAVFoundationtoCaptureImagesandMovies:<br><a target="_blank" rel="noopener" href="https://github.com/robovm/apple-ios-samples/tree/master/AVCam-iOSUsingAVFoundationtoCaptureImagesandMovies">https://github.com/robovm/apple-ios-samples/tree/master/AVCam-iOSUsingAVFoundationtoCaptureImagesandMovies</a></p>
<p>参考 Apple 的 Objective-C 转化为 Swift 版本。过程中学了不少知识，因没办法 copy-paste，都必须理解相关知识点才行。KVO 、Notification 和多线程等，注释也十分详细。唯一不舒服的就是AVFoundation API 本身没有对 Swift 优化，<a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Swift/Conceptual/BuildingCocoaApps/AdoptingCocoaDesignPatterns.html">Swift KVO</a> 也是一个坑。</p>
<p>源码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/gewill/test-projects/tree/master/test%20AVCam">https://github.com/gewill/test-projects/tree/master/test%20AVCam</a></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  JLXCameraViewController.swift</span></span><br><span class="line"><span class="comment">//  test AVCam</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by Will on 4/15/16.</span></span><br><span class="line"><span class="comment">//  Copyright © 2016 gewill.org. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> AVFoundation</span><br><span class="line"><span class="keyword">import</span> Photos</span><br><span class="line"><span class="keyword">import</span> AssetsLibrary</span><br><span class="line"></span><br><span class="line"><span class="keyword">protocol</span> <span class="title class_">JLXCameraViewControllerDelegate</span>: <span class="title class_">NSObjectProtocol</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">cameraViewController</span>(<span class="params">vc</span>: <span class="type">JLXCameraViewController</span>, <span class="params">didFinishCaptureVideoUrl</span> <span class="params">url</span>: <span class="type">NSURL</span>!)</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">cameraViewControllerDidCancel</span>(<span class="params">vc</span>: <span class="type">JLXCameraViewController</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">JLXAVCamSetupResult</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Success</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">CameraNotAuthorized</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">SessionConfiguratonFailed</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> <span class="type">SessionRunningContext</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JLXCameraViewController</span>: <span class="title class_">UIViewController</span>, <span class="title class_">AVCaptureFileOutputRecordingDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> previewView: <span class="type">JLXPreviewView</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> cameraUnavailableLabel: <span class="type">UILabel</span>!</span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> resumeButton: <span class="type">UIButton</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> flashButton: <span class="type">UIButton</span>!</span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> changeCameraButton: <span class="type">UIButton</span>!</span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> cancelButton: <span class="type">UIButton</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> durationLabel: <span class="type">UILabel</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">var</span> recordButton: <span class="type">UIButton</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> delegate: <span class="type">JLXCameraViewControllerDelegate</span>?</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Session management</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Communicate with the session and other session objects on this queue.</span></span><br><span class="line">    <span class="keyword">var</span> sessionQueue <span class="operator">=</span> dispatch_queue_create(<span class="string">&quot;session queue&quot;</span>, <span class="type">DISPATCH_QUEUE_SERIAL</span>)</span><br><span class="line">    <span class="keyword">dynamic</span> <span class="keyword">var</span> session: <span class="type">AVCaptureSession</span>!</span><br><span class="line">    <span class="keyword">var</span> videoDeviceInput: <span class="type">AVCaptureDeviceInput</span>!</span><br><span class="line">    <span class="keyword">var</span> movieFileOutput: <span class="type">AVCaptureMovieFileOutput</span>!</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Utilities</span></span><br><span class="line">    <span class="keyword">var</span> setupResult: <span class="type">JLXAVCamSetupResult</span>!</span><br><span class="line">    <span class="keyword">var</span> sessionRunning: <span class="type">Bool</span>!</span><br><span class="line">    <span class="keyword">var</span> backgroundRecordingId: <span class="type">UIBackgroundTaskIdentifier</span>!</span><br><span class="line">    <span class="keyword">var</span> durationTimer: <span class="type">NSTimer</span>?</span><br><span class="line">    <span class="keyword">var</span> seconds: <span class="type">Int</span>!</span><br><span class="line">    <span class="keyword">var</span> isRecording <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - life cycle</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.setupUI()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.setupSession()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">setupUI</span>() &#123;</span><br><span class="line">        <span class="comment">// Disable UI. The UI is enabled if and only if the session starts running.</span></span><br><span class="line">        <span class="keyword">self</span>.changeCameraButton.enabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">self</span>.recordButton.enabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">self</span>.flashButton.enabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.resumeButton.setTitle(<span class="string">&quot;Tap to resume&quot;</span>, forState: .<span class="type">Normal</span>)</span><br><span class="line">        <span class="keyword">self</span>.resumeButton.hidden <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">self</span>.cameraUnavailableLabel.text <span class="operator">=</span> <span class="string">&quot;Camera Unavailable&quot;</span></span><br><span class="line">        <span class="keyword">self</span>.cameraUnavailableLabel.hidden <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tapGesture <span class="operator">=</span> <span class="type">UITapGestureRecognizer</span>(target: <span class="keyword">self</span>, action: <span class="keyword">#selector</span>(<span class="type">JLXCameraViewController</span>.focusAndExposeTap(<span class="keyword">_</span>:)))</span><br><span class="line">        <span class="keyword">self</span>.previewView.addGestureRecognizer(tapGesture)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">setupAuthorization</span>() &#123;</span><br><span class="line">        <span class="comment">// Check video authorization status. Video access is required and audio access is optional.</span></span><br><span class="line">        <span class="comment">// If audio access is denied, audio is not recorded during movie recording.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> <span class="type">AVCaptureDevice</span>.authorizationStatusForMediaType(<span class="type">AVMediaTypeVideo</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">AVAuthorizationStatus</span>.<span class="type">NotDetermined</span>:</span><br><span class="line">            dispatch_suspend(<span class="keyword">self</span>.sessionQueue)</span><br><span class="line">            <span class="type">AVCaptureDevice</span>.requestAccessForMediaType(<span class="type">AVMediaTypeVideo</span>, completionHandler: &#123; (granted) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> granted <span class="operator">==</span> <span class="literal">false</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.setupResult <span class="operator">=</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">CameraNotAuthorized</span></span><br><span class="line">                &#125;</span><br><span class="line">                dispatch_resume(<span class="keyword">self</span>.sessionQueue)</span><br><span class="line">            &#125;)</span><br><span class="line">        <span class="keyword">case</span> <span class="type">AVAuthorizationStatus</span>.<span class="type">Authorized</span>:</span><br><span class="line">            <span class="keyword">self</span>.setupResult <span class="operator">=</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">Success</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">self</span>.setupResult <span class="operator">=</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">CameraNotAuthorized</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the capture session.</span></span><br><span class="line">    <span class="comment">// In general it is not safe to mutate an AVCaptureSession or any of its inputs, outputs, or connections from multiple threads at the same time.</span></span><br><span class="line">    <span class="comment">// Why not do all of this on the main queue?</span></span><br><span class="line">    <span class="comment">// Because -[AVCaptureSession startRunning] is a blocking call which can take a long time. We dispatch session setup to the sessionQueue</span></span><br><span class="line">    <span class="comment">// so that the main queue isn&#x27;t blocked, which keeps the UI responsive.</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">setupSession</span>() &#123;</span><br><span class="line">        <span class="comment">// Create the AVCaptureSession.</span></span><br><span class="line">        <span class="keyword">self</span>.session <span class="operator">=</span> <span class="type">AVCaptureSession</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Setup the preview view.</span></span><br><span class="line">        <span class="keyword">self</span>.previewView.setSession(<span class="keyword">self</span>.session)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.setupResult <span class="operator">=</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">Success</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.setupAuthorization()</span><br><span class="line"></span><br><span class="line">        dispatch_async(<span class="keyword">self</span>.sessionQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.setupResult <span class="operator">!=</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">Success</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.backgroundRecordingId <span class="operator">=</span> <span class="type">UIBackgroundTaskInvalid</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> videoDevice: <span class="type">AVCaptureDevice</span> <span class="operator">=</span> <span class="type">JLXCameraViewController</span>.deviceWithMediaType(<span class="type">AVMediaTypeVideo</span>, preferringPosition: <span class="type">AVCaptureDevicePosition</span>.<span class="type">Back</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> videoDeviceInput: <span class="type">AVCaptureDeviceInput</span>?</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                videoDeviceInput <span class="operator">=</span> <span class="keyword">try</span> <span class="type">AVCaptureDeviceInput</span>.<span class="keyword">init</span>(device: videoDevice)</span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Could not create video device input: <span class="subst">\(error.debugDescription)</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.session.beginConfiguration()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.session.canAddInput(videoDeviceInput) &#123;</span><br><span class="line">                <span class="keyword">self</span>.session.addInput(videoDeviceInput)</span><br><span class="line">                <span class="keyword">self</span>.videoDeviceInput <span class="operator">=</span> videoDeviceInput</span><br><span class="line"></span><br><span class="line">                dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">                    <span class="comment">// Why are we dispatching this to the main queue?</span></span><br><span class="line">                    <span class="comment">// Because AVCaptureVideoPreviewLayer is the backing layer for AAPLPreviewView and UIView</span></span><br><span class="line">                    <span class="comment">// can only be manipulated on the main thread.</span></span><br><span class="line">                    <span class="comment">// Note: As an exception to the above rule, it is not necessary to serialize video orientation changes</span></span><br><span class="line">                    <span class="comment">// on the AVCaptureVideoPreviewLayer’s connection with other session manipulation.</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Use the status bar orientation as the initial video orientation. Subsequent orientation changes are handled by</span></span><br><span class="line">                    <span class="comment">// -[viewWillTransitionToSize:withTransitionCoordinator:].</span></span><br><span class="line">                    <span class="keyword">let</span> orientation <span class="operator">=</span> <span class="type">AVCaptureVideoOrientation</span>.<span class="type">LandscapeRight</span></span><br><span class="line">                    <span class="keyword">let</span> previewLayer <span class="operator">=</span> <span class="keyword">self</span>.previewView.layer <span class="keyword">as!</span> <span class="type">AVCaptureVideoPreviewLayer</span></span><br><span class="line">                    previewLayer.connection.videoOrientation <span class="operator">=</span> orientation</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Could not add video device input to the session&quot;</span>)</span><br><span class="line">                <span class="keyword">self</span>.setupResult <span class="operator">=</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">SessionConfiguratonFailed</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> - test failed</span></span><br><span class="line">            <span class="keyword">let</span> audioDevice <span class="operator">=</span> <span class="type">AVCaptureDevice</span>.defaultDeviceWithMediaType(<span class="type">AVMediaTypeAudio</span>)</span><br><span class="line">            <span class="keyword">let</span> audioDeviceInput: <span class="type">AVCaptureDeviceInput</span>?</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                audioDeviceInput <span class="operator">=</span> <span class="keyword">try</span> <span class="type">AVCaptureDeviceInput</span>.<span class="keyword">init</span>(device: audioDevice)</span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Could not create audio device input: <span class="subst">\(error.debugDescription.debugDescription)</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> movieFileOutput <span class="operator">=</span> <span class="type">AVCaptureMovieFileOutput</span>()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.session.canAddOutput(movieFileOutput) &#123;</span><br><span class="line">                <span class="keyword">self</span>.session.addOutput(movieFileOutput)</span><br><span class="line">                <span class="keyword">let</span> connection <span class="operator">=</span> movieFileOutput.connectionWithMediaType(<span class="type">AVMediaTypeVideo</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">#available</span>(<span class="keyword">iOS</span> <span class="number">8.0</span>, <span class="operator">*</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> connection.supportsVideoStabilization &#123;</span><br><span class="line">                        connection.preferredVideoStabilizationMode <span class="operator">=</span> .<span class="type">Auto</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    connection.enablesVideoStabilizationWhenAvailable <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> connection.supportsVideoOrientation &#123;</span><br><span class="line">                    connection.videoOrientation <span class="operator">=</span> <span class="type">AVCaptureVideoOrientation</span>.<span class="type">LandscapeRight</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">self</span>.movieFileOutput <span class="operator">=</span> movieFileOutput</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Could not add movie file output to the session&quot;</span>)</span><br><span class="line">                <span class="keyword">self</span>.setupResult <span class="operator">=</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">SessionConfiguratonFailed</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.session.commitConfiguration()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">didReceiveMemoryWarning</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.didReceiveMemoryWarning()</span><br><span class="line">        <span class="comment">// Dispose of any resources that can be recreated.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewWillAppear</span>(<span class="params">animated</span>: <span class="type">Bool</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// response setupResult</span></span><br><span class="line"></span><br><span class="line">        dispatch_async(<span class="keyword">self</span>.sessionQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">self</span>.setupResult &#123;</span><br><span class="line">                <span class="keyword">switch</span> result &#123;</span><br><span class="line">                <span class="keyword">case</span> .<span class="type">Success</span>:</span><br><span class="line">                    <span class="comment">// Only setup observers and start the session running if setup succeeded.</span></span><br><span class="line">                    <span class="keyword">self</span>.addObservers()</span><br><span class="line">                    <span class="keyword">self</span>.session.startRunning()</span><br><span class="line">                    <span class="keyword">self</span>.sessionRunning <span class="operator">=</span> <span class="keyword">self</span>.session.running</span><br><span class="line">                <span class="keyword">case</span> .<span class="type">CameraNotAuthorized</span>:</span><br><span class="line">                    dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">                        <span class="keyword">let</span> title <span class="operator">=</span> <span class="type">NSBundle</span>.mainBundle().localizedInfoDictionary<span class="operator">!</span>[<span class="string">&quot;CFBundleName&quot;</span>] <span class="keyword">as!</span> <span class="type">String</span></span><br><span class="line">                        <span class="keyword">let</span> message <span class="operator">=</span> <span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;AVCam doesn&#x27;t have permission to use the camera, please change privacy settings&quot;</span>, <span class="string">&quot;Alert message when the user has denied access to the camera&quot;</span>)</span><br><span class="line">                        <span class="keyword">let</span> cancelText <span class="operator">=</span> <span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;OK&quot;</span>, <span class="string">&quot;Alert OK button&quot;</span>)</span><br><span class="line">                        <span class="keyword">let</span> settingsText <span class="operator">=</span> <span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;Settings&quot;</span>, <span class="string">&quot;Alert button to open Settings&quot;</span>)</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">#available</span>(<span class="keyword">iOS</span> <span class="number">8.0</span>, <span class="operator">*</span>) &#123;</span><br><span class="line">                            <span class="keyword">let</span> alertController <span class="operator">=</span> <span class="type">UIAlertController</span>(title: title, message: message, preferredStyle: <span class="type">UIAlertControllerStyle</span>.<span class="type">Alert</span>)</span><br><span class="line">                            <span class="keyword">let</span> cancelAction <span class="operator">=</span> <span class="type">UIAlertAction</span>(title: cancelText, style: <span class="type">UIAlertActionStyle</span>.<span class="type">Cancel</span>, handler: <span class="literal">nil</span>)</span><br><span class="line">                            alertController.addAction(cancelAction)</span><br><span class="line">                            <span class="keyword">let</span> settingsAction <span class="operator">=</span> <span class="type">UIAlertAction</span>(title: settingsText, style: <span class="type">UIAlertActionStyle</span>.<span class="type">Default</span>, handler: &#123; (action) <span class="keyword">in</span></span><br><span class="line">                                <span class="type">UIApplication</span>.sharedApplication().openURL(<span class="type">NSURL</span>(string: <span class="type">UIApplicationOpenSettingsURLString</span>)<span class="operator">!</span>)</span><br><span class="line">                            &#125;)</span><br><span class="line">                            alertController.addAction(settingsAction)</span><br><span class="line">                            <span class="keyword">self</span>.presentViewController(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> alert <span class="operator">=</span> <span class="type">UIAlertView</span>(title: title, message: message, delegate: <span class="literal">nil</span>, cancelButtonTitle: cancelText, otherButtonTitles: settingsText)</span><br><span class="line">                            alert.show()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> .<span class="type">SessionConfiguratonFailed</span>:</span><br><span class="line">                    <span class="keyword">let</span> title <span class="operator">=</span> <span class="type">NSBundle</span>.mainBundle().localizedInfoDictionary<span class="operator">!</span>[<span class="string">&quot;CFBundleName&quot;</span>] <span class="keyword">as!</span> <span class="type">String</span></span><br><span class="line">                    <span class="keyword">let</span> message <span class="operator">=</span> <span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;Unable to capture media&quot;</span>, <span class="string">&quot;Alert message when something goes wrong during capture session configuration&quot;</span>)</span><br><span class="line">                    <span class="keyword">let</span> cancelText <span class="operator">=</span> <span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;OK&quot;</span>, <span class="string">&quot;Alert OK button&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">#available</span>(<span class="keyword">iOS</span> <span class="number">8.0</span>, <span class="operator">*</span>) &#123;</span><br><span class="line">                        <span class="keyword">let</span> alertController <span class="operator">=</span> <span class="type">UIAlertController</span>(title: title, message: message, preferredStyle: <span class="type">UIAlertControllerStyle</span>.<span class="type">Alert</span>)</span><br><span class="line">                        <span class="keyword">let</span> cancelAction <span class="operator">=</span> <span class="type">UIAlertAction</span>(title: cancelText, style: <span class="type">UIAlertActionStyle</span>.<span class="type">Cancel</span>, handler: <span class="literal">nil</span>)</span><br><span class="line">                        alertController.addAction(cancelAction)</span><br><span class="line">                        <span class="keyword">self</span>.presentViewController(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> alert <span class="operator">=</span> <span class="type">UIAlertView</span>(title: title, message: message, delegate: <span class="literal">nil</span>, cancelButtonTitle: cancelText)</span><br><span class="line">                        alert.show()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidDisappear</span>(<span class="params">animated</span>: <span class="type">Bool</span>) &#123;</span><br><span class="line">        dispatch_async(<span class="keyword">self</span>.sessionQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.setupResult <span class="operator">==</span> <span class="type">JLXAVCamSetupResult</span>.<span class="type">Success</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.session.stopRunning()</span><br><span class="line">                <span class="keyword">self</span>.removeObservers()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.viewDidDisappear(animated)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - Orientation</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">supportedInterfaceOrientations</span>() -&gt; <span class="type">UIInterfaceOrientationMask</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UIInterfaceOrientationMask</span>.<span class="type">LandscapeRight</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - KVO and Notifications</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">addObservers</span>() &#123;</span><br><span class="line">        <span class="keyword">self</span>.session.addObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">&quot;running&quot;</span>, options: <span class="type">NSKeyValueObservingOptions</span>.<span class="type">New</span>, context: <span class="operator">&amp;</span><span class="type">SessionRunningContext</span>)</span><br><span class="line"></span><br><span class="line">        <span class="type">NSNotificationCenter</span>.defaultCenter().addObserver(<span class="keyword">self</span>, selector: <span class="keyword">#selector</span>(subjectAreaDidChange(<span class="keyword">_</span>:)), name: <span class="type">AVCaptureDeviceSubjectAreaDidChangeNotification</span>, object: <span class="keyword">self</span>.videoDeviceInput.device)</span><br><span class="line">        <span class="comment">// A session can only run when the app is full screen. It will be interrupted</span></span><br><span class="line">        <span class="comment">// in a multi-app layout, introduced in iOS 9,</span></span><br><span class="line">        <span class="comment">// see also the documentation of AVCaptureSessionInterruptionReason. Add</span></span><br><span class="line">        <span class="comment">// observers to handle these session interruptions</span></span><br><span class="line">        <span class="comment">// and show a preview is paused message. See the documentation of</span></span><br><span class="line">        <span class="comment">// AVCaptureSessionWasInterruptedNotification for other</span></span><br><span class="line">        <span class="comment">// interruption reasons.</span></span><br><span class="line">        <span class="type">NSNotificationCenter</span>.defaultCenter().addObserver(<span class="keyword">self</span>, selector: <span class="keyword">#selector</span>(sessionWatInterruptedEnded(<span class="keyword">_</span>:)), name: <span class="type">AVCaptureSessionWasInterruptedNotification</span>, object: <span class="keyword">self</span>.session)</span><br><span class="line">        <span class="type">NSNotificationCenter</span>.defaultCenter().addObserver(<span class="keyword">self</span>, selector: <span class="keyword">#selector</span>(sessionWatInterruptedEnded(<span class="keyword">_</span>:)), name: <span class="type">AVCaptureSessionInterruptionEndedNotification</span>, object: <span class="keyword">self</span>.session)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">removeObservers</span>() &#123;</span><br><span class="line">        <span class="keyword">self</span>.session.removeObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">&quot;running&quot;</span>, context: <span class="operator">&amp;</span><span class="type">SessionRunningContext</span>)</span><br><span class="line"></span><br><span class="line">        <span class="type">NSNotificationCenter</span>.defaultCenter().removeObserver(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">observeValueForKeyPath</span>(<span class="params">keyPath</span>: <span class="type">String</span>?, <span class="params">ofObject</span> <span class="params">object</span>: <span class="type">AnyObject</span>?, <span class="params">change</span>: [<span class="params">String</span>: <span class="type">AnyObject</span>]<span class="operator">?</span>, <span class="params">context</span>: <span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Void</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">if</span> context <span class="operator">==</span> <span class="operator">&amp;</span><span class="type">SessionRunningContext</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> isSessionRunning <span class="operator">=</span> change<span class="operator">?</span>[<span class="type">NSKeyValueChangeNewKey</span>]<span class="operator">?</span>.boolValue <span class="keyword">where</span></span><br><span class="line">            isSessionRunning <span class="operator">==</span> <span class="literal">true</span> &#123;</span><br><span class="line">                dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">                    <span class="comment">// Only enable the ability to change camera if the device has more than</span></span><br><span class="line">                    <span class="comment">// one camera.</span></span><br><span class="line">                    <span class="keyword">self</span>.changeCameraButton.enabled <span class="operator">=</span> isSessionRunning <span class="operator">&amp;&amp;</span> (<span class="type">AVCaptureDevice</span>.devicesWithMediaType(<span class="type">AVMediaTypeVideo</span>).count <span class="operator">&gt;</span> <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">self</span>.recordButton.enabled <span class="operator">=</span> isSessionRunning</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.observeValueForKeyPath(keyPath, ofObject: object, change: change, context: context)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">subjectAreaDidChange</span>(<span class="params">notification</span>: <span class="type">NSNotification</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> devicePoiont <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">0.5</span>, y: <span class="number">0.5</span>)</span><br><span class="line">        <span class="keyword">self</span>.focusWithMode(<span class="type">AVCaptureFocusMode</span>.<span class="type">ContinuousAutoFocus</span>, exposureWithMode: <span class="type">AVCaptureExposureMode</span>.<span class="type">ContinuousAutoExposure</span>, atDevicePoint: devicePoiont, monitorSubjectAreaChange: <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">sessionRuntimeError</span>(<span class="params">notification</span>: <span class="type">NSNotification</span>) &#123;</span><br><span class="line">        <span class="comment">// Automatically try to restart the session running if media services were</span></span><br><span class="line">        <span class="comment">// reset and the last start running succeeded.</span></span><br><span class="line">        <span class="comment">// Otherwise, enable the user to try to resume the session running.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> notification.userInfo<span class="operator">?</span>[<span class="type">AVCaptureSessionErrorKey</span>] <span class="keyword">where</span></span><br><span class="line">        error.code <span class="operator">==</span> <span class="type">AVError</span>.<span class="type">MediaServicesWereReset</span>.rawValue &#123;</span><br><span class="line">            dispatch_async(<span class="keyword">self</span>.sessionQueue, &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">self</span>.sessionRunning <span class="operator">==</span> <span class="literal">true</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.session.startRunning()</span><br><span class="line">                    <span class="keyword">self</span>.sessionRunning <span class="operator">=</span> <span class="keyword">self</span>.session.running</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">                        <span class="keyword">self</span>.resumeButton.hidden <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.resumeButton.hidden <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">sessionWasInterrupted</span>(<span class="params">notification</span>: <span class="type">NSNotification</span>) &#123;</span><br><span class="line">        <span class="comment">// In some scenarios we want to enable the user to resume the session running.</span></span><br><span class="line">        <span class="comment">// For example, if music playback is initiated via control center while using AVCam,</span></span><br><span class="line">        <span class="comment">// then the user can let AVCam resume the session running, which will stop music playback.</span></span><br><span class="line">        <span class="comment">// Note that stopping music playback in control center will not automatically resume the session running.</span></span><br><span class="line">        <span class="comment">// Also note that it is not always possible to resume, see -[resumeInterruptedSession:].</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> showResumeButton <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// In iOS 9 and later, the userInfo dictionary contains information on why the</span></span><br><span class="line">        <span class="comment">// session was interrupted.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">#available</span>(<span class="keyword">iOS</span> <span class="number">9.0</span>, <span class="operator">*</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> reason <span class="operator">=</span> notification.userInfo<span class="operator">?</span>[<span class="type">AVCaptureSessionInterruptionReasonKey</span>] <span class="keyword">where</span> reason <span class="keyword">is</span> <span class="type">Int</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (reason <span class="keyword">as!</span> <span class="type">Int</span>) <span class="operator">==</span> <span class="type">AVCaptureSessionInterruptionReason</span>.<span class="type">AudioDeviceInUseByAnotherClient</span>.rawValue <span class="operator">||</span> (reason <span class="keyword">as!</span> <span class="type">Int</span>) <span class="operator">==</span> <span class="type">AVCaptureSessionInterruptionReason</span>.<span class="type">VideoDeviceInUseByAnotherClient</span>.rawValue &#123;</span><br><span class="line">                    showResumeButton <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reason <span class="keyword">as!</span> <span class="type">Int</span>) <span class="operator">==</span> <span class="type">AVCaptureSessionInterruptionReason</span>.<span class="type">VideoDeviceNotAvailableWithMultipleForegroundApps</span>.rawValue &#123;</span><br><span class="line">                    <span class="comment">// Simply fade-in a label to inform the user that the camera is</span></span><br><span class="line">                    <span class="comment">// unavailable.</span></span><br><span class="line">                    <span class="keyword">self</span>.cameraUnavailableLabel.hidden <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">                    <span class="keyword">self</span>.cameraUnavailableLabel.alpha <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">                    <span class="type">UIView</span>.animateWithDuration(<span class="number">0.25</span>, animations: &#123;</span><br><span class="line">                        <span class="keyword">self</span>.cameraUnavailableLabel.alpha <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Capture session was interrupted&quot;</span>)</span><br><span class="line">            showResumeButton <span class="operator">=</span> <span class="type">UIApplication</span>.sharedApplication().applicationState <span class="operator">==</span> <span class="type">UIApplicationState</span>.<span class="type">Inactive</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> showResumeButton &#123;</span><br><span class="line">            <span class="comment">// Simply fade-in a button to enable the user to try to resume the session</span></span><br><span class="line">            <span class="comment">// running.</span></span><br><span class="line">            <span class="keyword">self</span>.resumeButton.hidden <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">self</span>.resumeButton.alpha <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">            <span class="type">UIView</span>.animateWithDuration(<span class="number">0.25</span>, animations: &#123;</span><br><span class="line">                <span class="keyword">self</span>.resumeButton.alpha <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">sessionWatInterruptedEnded</span>(<span class="params">notification</span>: <span class="type">NSNotification</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Capture session interruption ended&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// hide buttons with animations</span></span><br><span class="line">        <span class="keyword">if</span> <span class="operator">!</span><span class="keyword">self</span>.resumeButton.hidden &#123;</span><br><span class="line">            <span class="type">UIView</span>.animateWithDuration(<span class="number">0.25</span>, animations: &#123;</span><br><span class="line">                <span class="keyword">self</span>.resumeButton.alpha <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">                &#125;, completion: &#123; (finished) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.resumeButton.hidden <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="operator">!</span><span class="keyword">self</span>.cameraUnavailableLabel.hidden &#123;</span><br><span class="line">            <span class="type">UIView</span>.animateWithDuration(<span class="number">0.25</span>, animations: &#123;</span><br><span class="line">                <span class="keyword">self</span>.cameraUnavailableLabel.alpha <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">                &#125;, completion: &#123; (finished) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.cameraUnavailableLabel.hidden <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: -  Response Actions</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">resumeButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        dispatch_async(<span class="keyword">self</span>.sessionQueue) &#123;</span><br><span class="line">            <span class="comment">// The session might fail to start running, e.g., if a phone or FaceTime</span></span><br><span class="line">            <span class="comment">// call is still using audio or video.</span></span><br><span class="line">            <span class="comment">// A failure to start the session running will be communicated via a session</span></span><br><span class="line">            <span class="comment">// runtime error notification.</span></span><br><span class="line">            <span class="comment">// To avoid repeatedly failing to start the session running, we only try to</span></span><br><span class="line">            <span class="comment">// restart the session running in the</span></span><br><span class="line">            <span class="comment">// session runtime error handler if we aren&#x27;t trying to resume the session</span></span><br><span class="line">            <span class="comment">// running.</span></span><br><span class="line">            <span class="keyword">self</span>.session.startRunning()</span><br><span class="line">            <span class="keyword">self</span>.durationTimer <span class="operator">=</span> <span class="type">NSTimer</span>(timeInterval: <span class="number">1.0</span>, target: <span class="keyword">self</span>, selector: <span class="keyword">#selector</span>(<span class="type">JLXCameraViewController</span>.refreshDurationLabel), userInfo: <span class="literal">nil</span>, repeats: <span class="literal">true</span>)</span><br><span class="line">            <span class="type">NSRunLoop</span>.currentRunLoop().addTimer(<span class="keyword">self</span>.durationTimer<span class="operator">!</span>, forMode: <span class="type">NSRunLoopCommonModes</span>)</span><br><span class="line">            <span class="keyword">self</span>.durationTimer<span class="operator">?</span>.fire()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.sessionRunning <span class="operator">=</span> <span class="keyword">self</span>.session.running</span><br><span class="line">            <span class="keyword">if</span> <span class="operator">!</span><span class="keyword">self</span>.session.running &#123;</span><br><span class="line">                dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">                    <span class="keyword">let</span> title <span class="operator">=</span> <span class="type">NSBundle</span>.mainBundle().localizedInfoDictionary<span class="operator">!</span>[<span class="string">&quot;CFBundleName&quot;</span>] <span class="keyword">as!</span> <span class="type">String</span></span><br><span class="line">                    <span class="keyword">let</span> message <span class="operator">=</span> <span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;Unable to resume&quot;</span>, <span class="string">&quot;Alert message when unable to resume the session running&quot;</span>)</span><br><span class="line">                    <span class="keyword">let</span> cancelText <span class="operator">=</span> <span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;OK&quot;</span>, <span class="string">&quot;Alert OK button&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">#available</span>(<span class="keyword">iOS</span> <span class="number">8.0</span>, <span class="operator">*</span>) &#123;</span><br><span class="line">                        <span class="keyword">let</span> alertController <span class="operator">=</span> <span class="type">UIAlertController</span>(title: title, message: message, preferredStyle: <span class="type">UIAlertControllerStyle</span>.<span class="type">Alert</span>)</span><br><span class="line">                        <span class="keyword">let</span> cancelAction <span class="operator">=</span> <span class="type">UIAlertAction</span>(title: cancelText, style: <span class="type">UIAlertActionStyle</span>.<span class="type">Cancel</span>, handler: <span class="literal">nil</span>)</span><br><span class="line">                        alertController.addAction(cancelAction)</span><br><span class="line">                        <span class="keyword">self</span>.presentViewController(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> alert <span class="operator">=</span> <span class="type">UIAlertView</span>(title: title, message: message, delegate: <span class="literal">nil</span>, cancelButtonTitle: cancelText)</span><br><span class="line">                        alert.show()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.resumeButton.hidden <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">recordButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        <span class="comment">// Disable the Camera button until recording finishes, and disable the Record</span></span><br><span class="line">        <span class="comment">// button until recording starts or finishes. See the</span></span><br><span class="line">        <span class="comment">// AVCaptureFileOutputRecordingDelegate methods.</span></span><br><span class="line">        <span class="keyword">self</span>.changeCameraButton.enabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">self</span>.recordButton.enabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.isRecording <span class="operator">==</span> <span class="literal">true</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.durationTimer<span class="operator">?</span>.invalidate()</span><br><span class="line">            <span class="keyword">self</span>.durationTimer <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">self</span>.seconds <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">self</span>.durationLabel.text <span class="operator">=</span> secondsToFormatTimeFull(<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.seconds <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">self</span>.durationTimer <span class="operator">=</span> <span class="type">NSTimer</span>(timeInterval: <span class="number">1.0</span>, target: <span class="keyword">self</span>, selector: <span class="keyword">#selector</span>(<span class="type">JLXCameraViewController</span>.refreshDurationLabel), userInfo: <span class="literal">nil</span>, repeats: <span class="literal">true</span>)</span><br><span class="line">            <span class="type">NSRunLoop</span>.currentRunLoop().addTimer(<span class="keyword">self</span>.durationTimer<span class="operator">!</span>, forMode: <span class="type">NSRunLoopCommonModes</span>)</span><br><span class="line">            <span class="keyword">self</span>.durationTimer<span class="operator">?</span>.fire()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.isRecording <span class="operator">=</span> <span class="operator">!</span>isRecording</span><br><span class="line"></span><br><span class="line">        dispatch_async(<span class="keyword">self</span>.sessionQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="operator">!</span><span class="keyword">self</span>.movieFileOutput.recording <span class="operator">&amp;&amp;</span> <span class="type">UIDevice</span>.currentDevice().multitaskingSupported &#123;</span><br><span class="line">                <span class="comment">// Setup background task. This is needed because the</span></span><br><span class="line">                <span class="comment">// -[captureOutput:didFinishRecordingToOutputFileAtURL:fromConnections:error:]</span></span><br><span class="line">                <span class="comment">// callback is not received until AVCam returns to the foreground unless</span></span><br><span class="line">                <span class="comment">// you request background execution time.</span></span><br><span class="line">                <span class="comment">// This also ensures that there will be time to write the file to the</span></span><br><span class="line">                <span class="comment">// photo library when AVCam is backgrounded.</span></span><br><span class="line">                <span class="comment">// To conclude this background execution, -endBackgroundTask is called</span></span><br><span class="line">                <span class="comment">// in</span></span><br><span class="line">                <span class="comment">// -[captureOutput:didFinishRecordingToOutputFileAtURL:fromConnections:error:]</span></span><br><span class="line">                <span class="comment">// after the recorded file has been saved.</span></span><br><span class="line">                <span class="keyword">self</span>.backgroundRecordingId <span class="operator">=</span> <span class="type">UIApplication</span>.sharedApplication().beginBackgroundTaskWithExpirationHandler(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Turn OFF flash for video recording.</span></span><br><span class="line">                <span class="type">JLXCameraViewController</span>.setFlashMode(<span class="type">AVCaptureFlashMode</span>.<span class="type">Off</span>, forDevice: <span class="keyword">self</span>.videoDeviceInput.device)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Start recording to a temporary file.</span></span><br><span class="line">                <span class="keyword">let</span> outputFileName <span class="operator">=</span> <span class="type">NSProcessInfo</span>.processInfo().globallyUniqueString</span><br><span class="line">                <span class="keyword">let</span> outputFileUrl <span class="operator">=</span> <span class="type">NSURL</span>(fileURLWithPath: <span class="type">NSTemporaryDirectory</span>()).<span class="type">URLByAppendingPathComponent</span>(outputFileName).<span class="type">URLByAppendingPathExtension</span>(<span class="string">&quot;mov&quot;</span>)</span><br><span class="line">                <span class="keyword">self</span>.movieFileOutput.startRecordingToOutputFileURL(outputFileUrl, recordingDelegate: <span class="keyword">self</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.movieFileOutput.stopRecording()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">changeCameraButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.changeCameraButton.enabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">self</span>.recordButton.enabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        dispatch_async(<span class="keyword">self</span>.sessionQueue) &#123;</span><br><span class="line">            <span class="keyword">let</span> currentVideoDivice <span class="operator">=</span> <span class="keyword">self</span>.videoDeviceInput.device</span><br><span class="line">            <span class="keyword">var</span> preferredPosition <span class="operator">=</span> <span class="type">AVCaptureDevicePosition</span>.<span class="type">Unspecified</span></span><br><span class="line">            <span class="keyword">let</span> currentPosition <span class="operator">=</span> currentVideoDivice.position</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> currentPosition &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="type">AVCaptureDevicePosition</span>.<span class="type">Front</span>:</span><br><span class="line">                preferredPosition <span class="operator">=</span> <span class="type">AVCaptureDevicePosition</span>.<span class="type">Back</span></span><br><span class="line">            <span class="keyword">case</span> <span class="type">AVCaptureDevicePosition</span>.<span class="type">Back</span>:</span><br><span class="line">                preferredPosition <span class="operator">=</span> <span class="type">AVCaptureDevicePosition</span>.<span class="type">Front</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> videoDevice <span class="operator">=</span> <span class="type">JLXCameraViewController</span>.deviceWithMediaType(<span class="type">AVMediaTypeVideo</span>, preferringPosition: preferredPosition)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> videoDeviceInput: <span class="type">AVCaptureDeviceInput</span>?</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                videoDeviceInput <span class="operator">=</span> <span class="keyword">try</span> <span class="type">AVCaptureDeviceInput</span>.<span class="keyword">init</span>(device: videoDevice)</span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Could not create video device input: <span class="subst">\(error.debugDescription)</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.session.beginConfiguration()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Remove the existing device input first, since using the front and back</span></span><br><span class="line">            <span class="comment">// camera simultaneously is not supported.</span></span><br><span class="line">            <span class="keyword">self</span>.session.removeInput(<span class="keyword">self</span>.videoDeviceInput)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.session.canAddInput(videoDeviceInput) &#123;</span><br><span class="line">                <span class="type">NSNotificationCenter</span>.defaultCenter().removeObserver(<span class="keyword">self</span>, name: <span class="type">AVCaptureDeviceSubjectAreaDidChangeNotification</span>, object: currentVideoDivice)</span><br><span class="line"></span><br><span class="line">                <span class="type">JLXCameraViewController</span>.setFlashMode(<span class="type">AVCaptureFlashMode</span>.<span class="type">Auto</span>, forDevice: videoDevice)</span><br><span class="line">                <span class="type">NSNotificationCenter</span>.defaultCenter().addObserver(<span class="keyword">self</span>, selector: <span class="keyword">#selector</span>(<span class="type">JLXCameraViewController</span>.subjectAreaDidChange(<span class="keyword">_</span>:)), name: <span class="type">AVCaptureDeviceSubjectAreaDidChangeNotification</span>, object: videoDevice)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">self</span>.session.addInput(videoDeviceInput)</span><br><span class="line">                <span class="keyword">self</span>.videoDeviceInput <span class="operator">=</span> videoDeviceInput</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.session.addInput(<span class="keyword">self</span>.videoDeviceInput)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> connection <span class="operator">=</span> <span class="keyword">self</span>.movieFileOutput.connectionWithMediaType(<span class="type">AVMediaTypeVideo</span>)</span><br><span class="line">            <span class="keyword">if</span> connection.supportsVideoStabilization &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">#available</span>(<span class="keyword">iOS</span> <span class="number">8.0</span>, <span class="operator">*</span>) &#123;</span><br><span class="line">                    connection.preferredVideoStabilizationMode <span class="operator">=</span> .<span class="type">Auto</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    connection.enablesVideoStabilizationWhenAvailable <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.session.commitConfiguration()</span><br><span class="line"></span><br><span class="line">            dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">                <span class="keyword">self</span>.changeCameraButton.enabled <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">                <span class="keyword">self</span>.recordButton.enabled <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">focusAndExposeTap</span>(<span class="params">gestureRecognizer</span>: <span class="type">UIGestureRecognizer</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> devicePoint <span class="operator">=</span> (<span class="keyword">self</span>.previewView.layer <span class="keyword">as!</span> <span class="type">AVCaptureVideoPreviewLayer</span>).captureDevicePointOfInterestForPoint(gestureRecognizer.locationInView(gestureRecognizer.view))</span><br><span class="line">        <span class="keyword">self</span>.focusWithMode(<span class="type">AVCaptureFocusMode</span>.<span class="type">AutoFocus</span>, exposureWithMode: <span class="type">AVCaptureExposureMode</span>.<span class="type">AutoExpose</span>, atDevicePoint: devicePoint, monitorSubjectAreaChange: <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">flashButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> - should deal while changeCameraButton</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">refreshDurationLabel</span>() &#123;</span><br><span class="line">        seconds <span class="operator">=</span> seconds <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">self</span>.durationLabel.text <span class="operator">=</span> secondsToFormatTimeFull(<span class="type">Double</span>(<span class="keyword">self</span>.seconds))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">cancelButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        delegate<span class="operator">?</span>.cameraViewControllerDidCancel(<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">self</span>.dismissViewControllerAnimated(<span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - File Output Recording Delegate</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">captureOutput</span>(<span class="params">captureOutput</span>: <span class="type">AVCaptureFileOutput</span>!, <span class="params">didStartRecordingToOutputFileAtURL</span> <span class="params">fileURL</span>: <span class="type">NSURL</span>!, <span class="params">fromConnections</span> <span class="params">connections</span>: [<span class="type">AnyObject</span>]<span class="operator">!</span>) &#123;</span><br><span class="line">        <span class="comment">// Enable the Record button to let the user stop the recording.</span></span><br><span class="line">        dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">            <span class="keyword">self</span>.recordButton.enabled <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">            <span class="keyword">self</span>.recordButton.setTitle(<span class="type">String</span>.localizedStringWithFormat(<span class="string">&quot;Stop&quot;</span>, <span class="string">&quot;Recording button stop title&quot;</span>), forState: .<span class="type">Normal</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">captureOutput</span>(<span class="params">captureOutput</span>: <span class="type">AVCaptureFileOutput</span>!, <span class="params">didFinishRecordingToOutputFileAtURL</span> <span class="params">outputFileURL</span>: <span class="type">NSURL</span>!, <span class="params">fromConnections</span> <span class="params">connections</span>: [<span class="type">AnyObject</span>]<span class="operator">!</span>, <span class="params">error</span>: <span class="type">NSError</span>!) &#123;</span><br><span class="line">        <span class="comment">// Note that currentBackgroundRecordingID is used to end the background task</span></span><br><span class="line">        <span class="comment">// associated with this recording.</span></span><br><span class="line">        <span class="comment">// This allows a new recording to be started, associated with a new</span></span><br><span class="line">        <span class="comment">// UIBackgroundTaskIdentifier, once the movie file output&#x27;s isRecording</span></span><br><span class="line">        <span class="comment">// property</span></span><br><span class="line">        <span class="comment">// is back to NO — which happens sometime after this method returns.</span></span><br><span class="line">        <span class="comment">// Note: Since we use a unique file path for each recording, a new recording</span></span><br><span class="line">        <span class="comment">// will not overwrite a recording currently being saved.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.delegate<span class="operator">?</span>.cameraViewController(<span class="keyword">self</span>, didFinishCaptureVideoUrl: outputFileURL)</span><br><span class="line">        <span class="keyword">self</span>.dismissViewControllerAnimated(<span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - Device Configuration</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">focusWithMode</span>(<span class="params">focusMode</span>: <span class="type">AVCaptureFocusMode</span>, <span class="params">exposureWithMode</span> <span class="params">exposureMode</span>: <span class="type">AVCaptureExposureMode</span>, <span class="params">atDevicePoint</span> <span class="params">point</span>: <span class="type">CGPoint</span>, <span class="params">monitorSubjectAreaChange</span>: <span class="type">Bool</span>) &#123;</span><br><span class="line">        dispatch_async(<span class="keyword">self</span>.sessionQueue) &#123;</span><br><span class="line">            <span class="keyword">let</span> device <span class="operator">=</span> <span class="keyword">self</span>.videoDeviceInput.device</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> device.lockForConfiguration()</span><br><span class="line">                <span class="comment">// Setting (focus/exposure)PointOfInterest alone does not initiate a</span></span><br><span class="line">                <span class="comment">// (focus/exposure) operation.</span></span><br><span class="line">                <span class="comment">// Call -set(Focus/Exposure)Mode: to apply the new point of interest.</span></span><br><span class="line">                <span class="keyword">if</span> device.focusPointOfInterestSupported <span class="operator">&amp;&amp;</span> device.isFocusModeSupported(<span class="type">AVCaptureFocusMode</span>.<span class="type">AutoFocus</span>) &#123;</span><br><span class="line">                    device.focusPointOfInterest <span class="operator">=</span> point</span><br><span class="line">                    device.focusMode <span class="operator">=</span> focusMode</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> device.exposurePointOfInterestSupported <span class="operator">&amp;&amp;</span> device.isExposureModeSupported(<span class="type">AVCaptureExposureMode</span>.<span class="type">AutoExpose</span>) &#123;</span><br><span class="line">                    device.exposurePointOfInterest <span class="operator">=</span> point</span><br><span class="line">                    device.exposureMode <span class="operator">=</span> exposureMode</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                device.subjectAreaChangeMonitoringEnabled <span class="operator">=</span> monitorSubjectAreaChange</span><br><span class="line"></span><br><span class="line">                device.unlockForConfiguration()</span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot; <span class="subst">\(error.debugDescription)</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">func</span> <span class="title class_">setFlashMode</span>(<span class="title class_">flashMode</span>: <span class="title class_">AVCaptureFlashMode</span>, <span class="title class_">forDevice</span> <span class="title class_">device</span>: <span class="title class_">AVCaptureDevice</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> device.hasFlash <span class="operator">&amp;&amp;</span> device.isFlashModeSupported(flashMode) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> device.lockForConfiguration()</span><br><span class="line">                device.flashMode <span class="operator">=</span> flashMode</span><br><span class="line">                device.unlockForConfiguration()</span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Could not lock device for configuration: <span class="subst">\(error.debugDescription)</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">func</span> <span class="title class_">deviceWithMediaType</span>(<span class="title class_">mediaType</span>: <span class="title class_">String</span>, <span class="title class_">preferringPosition</span> <span class="title class_">position</span>: <span class="title class_">AVCaptureDevicePosition</span>) -&gt; <span class="title class_">AVCaptureDevice</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> devices <span class="operator">=</span> <span class="type">AVCaptureDevice</span>.devicesWithMediaType(mediaType) <span class="keyword">as!</span>[<span class="type">AVCaptureDevice</span>!]</span><br><span class="line">        <span class="keyword">var</span> captureDevice <span class="operator">=</span> devices.first</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> device <span class="keyword">in</span> devices &#123;</span><br><span class="line">            <span class="keyword">if</span> device.position <span class="operator">==</span> position &#123;</span><br><span class="line">                captureDevice <span class="operator">=</span> device</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> captureDevice<span class="operator">!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/04/14/Exploring-AVFoundation-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/14/Exploring-AVFoundation-Notes/" class="post-title-link" itemprop="url">Exploring AVFoundation - Notes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-04-14 22:48:59" itemprop="dateCreated datePublished" datetime="2016-04-14T22:48:59+08:00">2016-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>WWDC 2011 - Session 405 - Exploring AV Foundation<br><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2011/405/">https://developer.apple.com/videos/play/wwdc2011/405/</a></p>
<h2 id="1-扯淡"><a href="#1-扯淡" class="headerlink" title="1. 扯淡"></a>1. 扯淡</h2><p>可以学习英文教程，但要循序渐进，之后总结实践很重要。转化为自己的理解才行。之前看了一段时间 Doctmentation，感觉很大很复杂的框架。之后动手写了一些代码，回头再看相关 Session 就豁然开朗，一切不过是熟悉 Cocoa 框架结构，无非就是本事视频相关的不熟悉，直接开发就比较抽象。<strong>开发实践中持续学习</strong>，也就进入佳境。</p>
<p>视频学习时，双屏必备利器。加上最近 iPad 在 Session Keynote 上笔记，效率很高。</p>
<p>Session 不停的示例代码非常易于理解。</p>
<h2 id="2-总结"><a href="#2-总结" class="headerlink" title="2. 总结"></a>2. 总结</h2><p> Keynote 要点如下：</p>
<ol>
<li>五大功能：检测&#x2F;播放&#x2F;编辑片段&#x2F;导出&#x2F;录制。</li>
<li>两种媒体 model：static&#x2F;dynamic， 类似NSArray&#x2F;NSMutableArray，对应读取时是否会 mutate。</li>
<li>异步加载</li>
<li>Key-Value Observe 支持大多数属性</li>
<li>“There’s a protocol for that” TM</li>
<li>AVPlayerItem: AVAsynchronousKeyValueLoading：<code> loadValuesAsynchronouslyForKeys(_:completionHandler:)</code>，可以异步获取状态&#x2F;属性变化，以更新 UI 等。</li>
<li>AVPlayer 时间属性变化很快，异步 KVO 不再合适，改为同步 KVO，需要添加&#x2F;移除观察：<code>addPeriodicTimeObserverForInterval(_:queue:usingBlock:)</code></li>
<li>AVPlayerItem 可获取媒体相关的属性，对 status 添加KVO。</li>
<li>AVPlayerItemTrack：enabled 属性可以选择性播放 track。</li>
<li>AVQueuePlayer：播放一组 AVAsset，适用于编辑完播放。</li>
<li>AVPlayerLayer 用于显示媒体在屏幕上。有 readyForDisplay&#x2F;videoGravity 等属性。</li>
<li>AVMediaSelectionGroup 用于字幕&#x2F;音频等可选 track。</li>
<li>iPod Library: MPMediaQuery</li>
<li>Camera Roll: AssetsLibrary (iOS 9: Photos)</li>
<li>static&#x2F;dynamic model 对应不同的观察机制，如下：</li>
</ol>
<p>Matters of protocol And platform etiquette</p>
<ul>
<li>AVAsynchronousKeyValueLoading</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loadValuesAsynchronouslyForKeys:completionHandler: </span><br><span class="line">statusOfValueForKey:error:</span><br></pre></td></tr></table></figure>


<ul>
<li>NSObject(NSKeyValueObserving)</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addObserver:forKeyPath:options:context: </span><br><span class="line">removeObserver:forKeyPath: </span><br><span class="line">observeValueForKeyPath:ofObject:change:context:</span><br></pre></td></tr></table></figure>


<h2 id="3-部分示例代码："><a href="#3-部分示例代码：" class="headerlink" title="3. 部分示例代码："></a>3. 部分示例代码：</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *keys = [<span class="built_in">NSArray</span> arrayWithObject:@”playable”];</span><br><span class="line">[asset</span><br><span class="line">    loadValuesAsynchronouslyForKeys:keys</span><br><span class="line">                  completionHandler:^&#123;</span><br><span class="line">                    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="built_in">AVKeyValueStatus</span> playableStatus =</span><br><span class="line">                        [asset statusOfValueForKey:<span class="string">@&quot;playable&quot;</span> error:&amp;error];</span><br><span class="line">                    <span class="keyword">switch</span> (playableStatus) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="built_in">AVKeyValueStatusLoaded</span>:</span><br><span class="line">                      [<span class="keyword">self</span> updateUIForAsset];</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="built_in">AVKeyValueStatusFailed</span>:</span><br><span class="line">                      [<span class="keyword">self</span> reportError:error forAsset:asset];</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                      ...</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;];</span><br></pre></td></tr></table></figure>


<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)setUpTransportUI &#123;</span><br><span class="line">  <span class="built_in">CMTime</span> interval = <span class="built_in">CMTimeMakeWithSeconds</span>(<span class="number">0.5</span>);</span><br><span class="line">  <span class="type">id</span> myObserver =</span><br><span class="line">      [[myPlayer addPeriodicTimeObserverForInterval:interval</span><br><span class="line">                                              queue:dispatch_get_main_queue()</span><br><span class="line">                                         usingBlock:^&#123;</span><br><span class="line">                                           [<span class="keyword">self</span> movePlayheadUI];</span><br><span class="line">                                         &#125;] <span class="keyword">retain</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)cleanUp &#123;</span><br><span class="line">  [myPlayer removeTimeObserver:myObserver];</span><br><span class="line">  [myObserver release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/03/29/Custom-UIView/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/03/29/Custom-UIView/" class="post-title-link" itemprop="url">Custom UIView</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-03-29 20:53:52" itemprop="dateCreated datePublished" datetime="2016-03-29T20:53:52+08:00">2016-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近项目需要自定义一个 UIView，虽然不是第一次做，但是还是出现了很多问题，其中最严重是的获取的 self.bounds 是不对。</p>
<p>Debug 能力真的需要提高了，调试了很久，还是靠断点，逐个对比 bounds 才知道问题所在。</p>
<p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/29763818/making-a-custom-uiview-subview-that-fills-its-superview">http://stackoverflow.com/questions/29763818/making-a-custom-uiview-subview-that-fills-its-superview</a></p>
<p>这一篇解释的很清楚，我自己混淆了几种方法的使用，还忘记了手动设置 frame 时，还忘了layoutSubviews()。以前可能是宽高确定或根据 UIScreen 来的计算的，一直没出现问题。</p>
<ol>
<li>Use Auto Layout<ul>
<li>Interface Builder</li>
<li>Programmatically</li>
</ul>
</li>
<li>Manual Layout<ul>
<li>Resizing Masks</li>
<li>Layout Subviews</li>
</ul>
</li>
</ol>
<h2 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">init</span>(<span class="params">frame</span>: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    setupViews()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">required</span> <span class="keyword">init?</span>(<span class="params">coder</span> <span class="params">aDecoder</span>: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(coder: aDecoder)</span><br><span class="line">    setupViews()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">setupViews</span>() &#123;</span><br><span class="line">   	        </span><br><span class="line">    <span class="keyword">let</span> view <span class="operator">=</span> <span class="type">UIView</span>(frame: <span class="type">CGRectZero</span>)</span><br><span class="line">    view.setTranslatesAutoresizingMaskIntoConstraints(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    <span class="keyword">let</span> viewsDict <span class="operator">=</span> [<span class="string">&quot;view&quot;</span>: view]</span><br><span class="line">    addConstraints(<span class="type">NSLayoutConstraint</span>.constraintsWithVisualFormat(<span class="string">&quot;V:|-0-[view]-0-|&quot;</span>, options: .allZeros, metrics: <span class="literal">nil</span>, views: viewsDict))</span><br><span class="line">    addConstraints(<span class="type">NSLayoutConstraint</span>.constraintsWithVisualFormat(<span class="string">&quot;H:|-0-[view]-0-|&quot;</span>, options: .allZeros, metrics: <span class="literal">nil</span>, views: viewsDict))</span><br><span class="line">    addSubview(view)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>viewDidLoad 时获取的size 可能是错误的。</p>
<blockquote>
<p>viewDidLoad</p>
</blockquote>
<blockquote>
<p>The view controller has obtained its view. See the discussion earlier in this chapter of how a view controller gets its view. Recall that this does not mean that the view is in the interface or even that it has been given its correct size.</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/03/16/Core-Animation-Essentials-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ge Will">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Will's Blog">
      <meta itemprop="description" content="The people who are crazy enough to think they can change the world, are the ones who DO.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Will's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/03/16/Core-Animation-Essentials-Notes/" class="post-title-link" itemprop="url">Core Animation Essentials - Notes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-03-16 18:13:31" itemprop="dateCreated datePublished" datetime="2016-03-16T18:13:31+08:00">2016-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 17:06:49" itemprop="dateModified" datetime="2023-09-08T17:06:49+08:00">2023-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Core Animation Essentials (WWDC 2011 - Session 421): </p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2011/421/">https://developer.apple.com/videos/play/wwdc2011/421/</a></p>
<p>Animations Explained:</p>
<p><a target="_blank" rel="noopener" href="https://www.objc.io/issues/12-animations/animations-explained/#a-basic-animation">https://www.objc.io/issues/12-animations/animations-explained/#a-basic-animation</a></p>
<p>According above two documents，write code again by myself. </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> QuartzCore</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_">UIViewController</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> layer <span class="operator">=</span> <span class="type">CALayer</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.addImageLayer()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">addImageLayer</span>() &#123;</span><br><span class="line"></span><br><span class="line">        layer.bounds <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="number">25</span>, height: <span class="number">25</span>)</span><br><span class="line">        layer.position <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">100</span>, y: <span class="number">100</span>)</span><br><span class="line">        <span class="keyword">let</span> image <span class="operator">=</span> <span class="type">UIImage</span>(named: <span class="string">&quot;yanFei&quot;</span>)<span class="operator">!</span></span><br><span class="line">        layer.contents <span class="operator">=</span> image.<span class="type">CGImage</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.view.layer.addSublayer(layer)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">stopButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">firstButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        layer.opacity <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">secendButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        <span class="comment">// Just disable current run loop transaction</span></span><br><span class="line"><span class="comment">//        CATransaction.setDisableActions(true)</span></span><br><span class="line"></span><br><span class="line">        <span class="type">CATransaction</span>.setAnimationDuration(<span class="number">2</span>)</span><br><span class="line">        layer.opacity <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        layer.position <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">100</span>, y: <span class="number">400</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">thirdButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        <span class="type">CATransaction</span>.setAnimationDuration(<span class="number">5</span>)</span><br><span class="line">        layer.position <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="type">UIScreen</span>.mainScreen().bounds.height)</span><br><span class="line">        layer.opacity <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">fourthButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line"></span><br><span class="line">        layer.position <span class="operator">=</span> <span class="type">CGPoint</span>(x: layer.position.x, y: <span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> drop <span class="operator">=</span> <span class="type">CABasicAnimation</span>(keyPath: <span class="string">&quot;position.y&quot;</span>)</span><br><span class="line">        drop.fromValue <span class="operator">=</span> <span class="number">30</span></span><br><span class="line">        drop.toValue <span class="operator">=</span> <span class="number">400</span></span><br><span class="line">        drop.duration <span class="operator">=</span> <span class="number">5</span></span><br><span class="line">        drop.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line"><span class="comment">//        drop.beginTime = CACurrentMediaTime() + 0.5</span></span><br><span class="line">        layer.addAnimation(drop, forKey: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">fivethButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> shake <span class="operator">=</span> <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">&quot;position.x&quot;</span>)</span><br><span class="line">        <span class="comment">// values or path</span></span><br><span class="line">        shake.values <span class="operator">=</span> [<span class="number">0</span>, <span class="number">10</span>, <span class="operator">-</span><span class="number">10</span>, <span class="number">10</span>, <span class="number">0</span>]</span><br><span class="line">        shake.keyTimes <span class="operator">=</span> [<span class="number">0</span>, <span class="number">1</span> <span class="operator">/</span> <span class="number">6.0</span>, <span class="number">3</span> <span class="operator">/</span> <span class="number">6.0</span>, <span class="number">5</span> <span class="operator">/</span> <span class="number">6.0</span>, <span class="number">1</span>]</span><br><span class="line">        shake.duration <span class="operator">=</span> <span class="number">0.4</span></span><br><span class="line"></span><br><span class="line">        shake.additive <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        shake.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">        layer.addAnimation(shake, forKey: <span class="string">&quot;shake&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">sixthButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> boundingRect <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="operator">-</span><span class="number">50</span>, y: <span class="operator">-</span><span class="number">50</span>, width: <span class="number">100</span>, height: <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> orbit <span class="operator">=</span> <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">&quot;position&quot;</span>)</span><br><span class="line">        orbit.path <span class="operator">=</span> <span class="type">CGPathCreateWithEllipseInRect</span>(boundingRect, <span class="literal">nil</span>)</span><br><span class="line">        orbit.duration <span class="operator">=</span> <span class="number">4</span></span><br><span class="line">        orbit.additive <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        orbit.repeatCount <span class="operator">=</span> <span class="type">Float</span>.infinity</span><br><span class="line">        orbit.calculationMode <span class="operator">=</span> kCAAnimationPaced</span><br><span class="line">        orbit.rotationMode <span class="operator">=</span> kCAAnimationRotateAuto</span><br><span class="line"></span><br><span class="line">        layer.addAnimation(orbit, forKey: <span class="string">&quot;orbit&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">seventhButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line"></span><br><span class="line">        layer.position <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">300</span>, y: layer.position.y)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> timing <span class="operator">=</span> <span class="type">CABasicAnimation</span>(keyPath: <span class="string">&quot;position.x&quot;</span>)</span><br><span class="line">        timing.fromValue <span class="operator">=</span> <span class="number">30</span></span><br><span class="line">        timing.toValue <span class="operator">=</span> <span class="number">300</span></span><br><span class="line">        timing.duration <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        timing.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionLinear)</span></span><br><span class="line">        timing.timingFunction <span class="operator">=</span> <span class="type">CAMediaTimingFunction</span>(controlPoints: <span class="number">0.5</span>, <span class="number">0</span>, <span class="number">0.9</span>, <span class="number">0.7</span>)</span><br><span class="line">        layer.addAnimation(timing, forKey: <span class="string">&quot;timing&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">eighthButtonClick</span>(<span class="params">sender</span>: <span class="type">AnyObject</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> zPosistion <span class="operator">=</span> <span class="type">CABasicAnimation</span>(keyPath: <span class="string">&quot;zPosition&quot;</span>)</span><br><span class="line">        zPosistion.fromValue <span class="operator">=</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        zPosistion.toValue <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        zPosistion.duration <span class="operator">=</span> <span class="number">1.2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> rotation <span class="operator">=</span> <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">&quot;transform.rotation&quot;</span>)</span><br><span class="line">        rotation.values <span class="operator">=</span> [<span class="number">0</span>, <span class="number">0.14</span>, <span class="number">0</span>]</span><br><span class="line">        rotation.duration <span class="operator">=</span> <span class="number">1.2</span></span><br><span class="line">        rotation.timingFunctions <span class="operator">=</span> [<span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut),</span><br><span class="line">            <span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut)]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> position <span class="operator">=</span> <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">&quot;position&quot;</span>)</span><br><span class="line">        position.values <span class="operator">=</span> [<span class="type">NSValue</span>(CGPoint: <span class="type">CGPointZero</span>), <span class="type">NSValue</span>(CGPoint: <span class="type">CGPoint</span>(x: <span class="number">110</span>, y: <span class="operator">-</span><span class="number">20</span>)), <span class="type">NSValue</span>(CGPoint: <span class="type">CGPointZero</span>)]</span><br><span class="line">        position.timingFunctions <span class="operator">=</span> [<span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut),</span><br><span class="line">            <span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut)]</span><br><span class="line">        position.duration <span class="operator">=</span> <span class="number">1.2</span></span><br><span class="line">        position.additive <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> group <span class="operator">=</span> <span class="type">CAAnimationGroup</span>()</span><br><span class="line">        group.animations <span class="operator">=</span> [zPosistion, rotation, position]</span><br><span class="line">        group.duration <span class="operator">=</span> <span class="number">1.2</span></span><br><span class="line">        group.beginTime <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>() <span class="operator">+</span> <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">        layer.addAnimation(group, forKey: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">        layer.zPosition <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">ViewController</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">animationDidStart</span>(<span class="params">anim</span>: <span class="type">CAAnimation</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(anim)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">animationDidStop</span>(<span class="params">anim</span>: <span class="type">CAAnimation</span>, <span class="params">finished</span> <span class="params">flag</span>: <span class="type">Bool</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(anim)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Demo link:<br><a target="_blank" rel="noopener" href="https://github.com/gewill/test-projects/tree/master/test%20Core%20Animation">https://github.com/gewill/test-projects/tree/master/test%20Core%20Animation</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ge Will</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
